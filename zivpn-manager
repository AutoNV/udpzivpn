#!/bin/bash

YELLOW='\033[1;37m'
RED='\033[0;31m'
LIGHT_BLUE='\033[0;37m'
BOLD_WHITE='\033[1;37m'
CYAN='\033[0;37m'
GREEN='\033[0;32m'
LIGHT_GREEN='\033[1;32m'
PURPLE='\033[0;37m'
BOLD_CYAN='\033[1;37m'
NC='\033[0m'

_C='\033[0;36m'
_G='\033[1;32m'
_W='\033[1;37m'
_Y='\033[1;33m'
_R='\033[0;31m'

_progress() {
  local label="$1"
  local width=28
  local i bar filled empty
  for ((i=0; i<=100; i++)); do
    filled=$(( i * width / 100 ))
    empty=$(( width - filled ))
    bar=""
    for ((j=0; j<filled; j++)); do bar+="â–ˆ"; done
    for ((j=0; j<empty; j++)); do bar+="â–‘"; done
    printf "\r${_W}  %-22s ${_C}[${_G}%s${_C}]${_W} %3d%% ${NC}" "$label" "$bar" "$i"
    sleep 0.015
  done
  printf "\r${_W}  %-22s ${_C}[${_G}%s${_C}]${_W} %3d%% ${NC}\n" "$label" "$bar" "100"
}

_ok()   { printf "  ${_G}âœ”  %s${NC}\n"  "$1"; }
_warn() { printf "  ${_Y}âš   %s${NC}\n"  "$1"; }
_err()  { printf "  ${_R}âœ˜  %s${NC}\n"  "$1"; }
_sep()  { echo -e "${_C}--------------------------------------------${NC}"; }
_hdr()  { _sep; echo -e "${_W}  $1${NC}"; _sep; }

# â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
LICENSE_URL="https://raw.githubusercontent.com/AutoNV/udpzivpn/main/ip2"
LICENSE_INFO_FILE="/etc/zivpn/.license_info"
CONFIG_DIR="/etc/zivpn"
TELEGRAM_CONF="${CONFIG_DIR}/telegram.conf"
DOMAIN_CONF="${CONFIG_DIR}/domain.conf"
API_PORT=443

if [ "$(id -u)" -ne 0 ]; then
echo "This script must be run as root. Please use sudo or run as root user." >&2
exit 1
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  ACME.SH SSL FUNCTIONS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function install_acme_sh() {
  _progress "Install acme.sh"
  mkdir -p /root/.acme.sh
  curl -fsSL https://acme-install.netlify.app/acme.sh -o /root/.acme.sh/acme.sh 2>/dev/null
  chmod +x /root/.acme.sh/acme.sh
  # Set default CA ke Let's Encrypt
  /root/.acme.sh/acme.sh --set-default-ca --server letsencrypt >/dev/null 2>&1
  _ok "acme.sh siap"
}

function issue_ssl_acme() {
  local domain="$1"

  _hdr "[ SSL ] Menerbitkan SSL via acme.sh"

  # Install acme.sh jika belum ada
  if [ ! -f "/root/.acme.sh/acme.sh" ]; then
    install_acme_sh
  fi

  # Stop layanan yang pakai port 80 sementara
  systemctl stop nginx 2>/dev/null || true
  systemctl stop apache2 2>/dev/null || true
  sleep 1

  _progress "Issue SSL certificate (standalone)"
  /root/.acme.sh/acme.sh --issue \
    -d "$domain" \
    --standalone \
    --httpport 80 \
    --force \
    >/var/log/zivpn_acme.log 2>&1

  if [ $? -eq 0 ]; then
    _ok "SSL berhasil diterbitkan"

    # Install cert ke direktori zivpn
    _progress "Install cert ke /etc/zivpn"
    mkdir -p /etc/zivpn
    /root/.acme.sh/acme.sh --install-cert \
      -d "$domain" \
      --cert-file    /etc/zivpn/zivpn.crt \
      --key-file     /etc/zivpn/zivpn.key \
      --fullchain-file /etc/zivpn/zivpn.crt \
      --reloadcmd    "systemctl reload nginx 2>/dev/null || true" \
      >/dev/null 2>&1
    chmod 600 /etc/zivpn/zivpn.key
    _ok "Cert diinstall ke /etc/zivpn"

    # Setup auto-renew via cron
    _progress "Setup auto-renew"
    /root/.acme.sh/acme.sh --install-cronjob >/dev/null 2>&1
    _ok "Auto-renew aktif"
    return 0
  else
    _warn "acme.sh gagal, fallback ke self-signed cert..."
    _warn "Cek log: /var/log/zivpn_acme.log"
    # Buat self-signed sebagai fallback
    openssl req -x509 -newkey rsa:4096 -days 365 -nodes \
      -subj "/C=US/ST=Jakarta/L=Jakarta/O=NexusDev/OU=VPN/CN=${domain}" \
      -keyout /etc/zivpn/zivpn.key \
      -out /etc/zivpn/zivpn.crt 2>/dev/null
    chmod 600 /etc/zivpn/zivpn.key
    _warn "Self-signed cert digunakan"
    return 1
  fi
}

function ask_domain_input() {
  # Minta user input domain saat install pertama kali
  local domain=""
  echo ""
  echo -e "${_C}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
  echo -e "${_W}   ğŸŒ  Setup Domain & SSL                      ${NC}"
  echo -e "${_C}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
  echo ""
  echo -e "${_Y}  Masukkan domain yang sudah diarahkan ke IP server ini.${NC}"
  echo -e "${_Y}  Pastikan DNS A record sudah pointing ke: $(curl -s https://api.ipify.org 2>/dev/null)${NC}"
  echo ""
  while true; do
    read -p "  Domain (contoh: vpn.example.com): " domain
    domain=$(echo "$domain" | tr -d ' ' | tr '[:upper:]' '[:lower:]')
    if [ -z "$domain" ]; then
      echo -e "  ${_R}âœ˜  Domain tidak boleh kosong.${NC}"
      continue
    fi
    # Validasi format domain sederhana
    if ! echo "$domain" | grep -qE '^[a-z0-9]([a-z0-9\-]*[a-z0-9])?(\.[a-z0-9]([a-z0-9\-]*[a-z0-9])?)+$'; then
      echo -e "  ${_R}âœ˜  Format domain tidak valid. Coba lagi.${NC}"
      continue
    fi
    echo ""
    echo -e "  ${_W}Domain yang dimasukkan: ${_G}${domain}${NC}"
    read -p "  Sudah benar? (y/n): " confirm
    if [[ "$confirm" =~ ^[Yy]$ ]]; then
      break
    fi
  done

  # Simpan domain conf
  local server_ip
  server_ip=$(cat /etc/zivpn/ip.txt 2>/dev/null || curl -s https://api.ipify.org 2>/dev/null)
  mkdir -p "$CONFIG_DIR"
  printf 'DOMAIN=%s\nSERVER_IP=%s\nSSL_ENABLED=true\n' "$domain" "$server_ip" > "$DOMAIN_CONF"

  echo "$domain"
}


function _write_nginx_config() {
  # Tulis config nginx TANPA heredoc ekspansi variabel (pakai printf)
  # agar tidak ada escape color ANSI yang bocor ke file config
  local domain="$1"
  local cfg="/etc/nginx/sites-available/zivpn-api"

  # Hapus config lama dulu
  rm -f "$cfg"

  printf 'server {\n' >> "$cfg"
  printf '    listen 80;\n' >> "$cfg"
  printf '    server_name %s;\n' "$domain" >> "$cfg"
  printf '    return 301 https://$host$request_uri;\n' >> "$cfg"
  printf '}\n\n' >> "$cfg"
  printf 'server {\n' >> "$cfg"
  printf '    listen 443 ssl http2;\n' >> "$cfg"
  printf '    server_name %s;\n' "$domain" >> "$cfg"
  printf '\n' >> "$cfg"
  printf '    ssl_certificate /etc/zivpn/zivpn.crt;\n' >> "$cfg"
  printf '    ssl_certificate_key /etc/zivpn/zivpn.key;\n' >> "$cfg"
  printf '    ssl_protocols TLSv1.2 TLSv1.3;\n' >> "$cfg"
  printf '    ssl_ciphers HIGH:!aNULL:!MD5;\n' >> "$cfg"
  printf '\n' >> "$cfg"
  printf '    location / {\n' >> "$cfg"
  printf '        proxy_pass http://127.0.0.1:5888;\n' >> "$cfg"
  printf '        proxy_set_header Host $host;\n' >> "$cfg"
  printf '        proxy_set_header X-Real-IP $remote_addr;\n' >> "$cfg"
  printf '        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n' >> "$cfg"
  printf '        proxy_set_header X-Forwarded-Proto $scheme;\n' >> "$cfg"
  printf '    }\n' >> "$cfg"
  printf '}\n' >> "$cfg"
}

function _fix_ssl_key_mismatch() {
  # Periksa apakah cert dan key cocok, jika tidak â†’ regenerate pasangan baru
  local domain="$1"
  local cert_md5 key_md5

  cert_md5=$(openssl x509 -noout -modulus -in /etc/zivpn/zivpn.crt 2>/dev/null | md5sum)
  key_md5=$(openssl rsa -noout -modulus -in /etc/zivpn/zivpn.key 2>/dev/null | md5sum)

  if [ "$cert_md5" != "$key_md5" ] || [ -z "$cert_md5" ]; then
    _warn "SSL cert/key tidak cocok, regenerate self-signed..."
    # Hapus dulu file lama
    rm -f /etc/zivpn/zivpn.crt /etc/zivpn/zivpn.key
    # Generate pasangan baru yang cocok
    openssl req -x509 -newkey rsa:4096 -days 365 -nodes \
      -subj "/C=US/ST=Jakarta/L=Jakarta/O=NexusDev/OU=VPN/CN=${domain}" \
      -keyout /etc/zivpn/zivpn.key \
      -out /etc/zivpn/zivpn.crt 2>/dev/null
    chmod 600 /etc/zivpn/zivpn.key
    _ok "SSL cert/key baru dibuat (matched)"
  else
    _ok "SSL cert/key cocok"
  fi
}

function setup_nginx_ssl_proxy() {
  local domain="$1"

  _progress "Installing nginx"
  apt install -y nginx >/dev/null 2>&1

  # Cek dan fix SSL key mismatch sebelum menulis config
  _fix_ssl_key_mismatch "$domain"

  # Tulis config nginx menggunakan printf (bukan heredoc) agar
  # tidak ada karakter ANSI color yang bocor ke dalam config file
  _write_nginx_config "$domain"

  ln -sf /etc/nginx/sites-available/zivpn-api /etc/nginx/sites-enabled/zivpn-api
  rm -f /etc/nginx/sites-enabled/default 2>/dev/null || true

  # Test config sebelum restart
  local test_result
  test_result=$(nginx -t 2>&1)
  if echo "$test_result" | grep -q "syntax is ok"; then
    systemctl restart nginx
    systemctl enable nginx >/dev/null 2>&1
    _ok "Nginx SSL proxy aktif â†’ https://${domain}"
  else
    _err "Nginx config error:"
    echo "$test_result" | grep "emerg\|error" | head -5
  fi

  # Buka port 443 dan 80
  iptables -I INPUT -p tcp --dport 443 -j ACCEPT 2>/dev/null
  iptables -I INPUT -p tcp --dport 80 -j ACCEPT 2>/dev/null
  netfilter-persistent save >/dev/null 2>&1
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  HELPER FUNCTIONS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function get_active_domain() {
  if [ -f "$DOMAIN_CONF" ]; then
    source "$DOMAIN_CONF"
    echo "${DOMAIN}"
  else
    # fallback ke CN dari cert
    local cert_cn
    cert_cn=$(openssl x509 -in /etc/zivpn/zivpn.crt -noout -subject 2>/dev/null | sed -n 's/.*CN = \([^,]*\).*/\1/p')
    if [ -n "$cert_cn" ] && [ "$cert_cn" != "zivpn" ]; then
      echo "$cert_cn"
    else
      cat /etc/zivpn/ip.txt 2>/dev/null
    fi
  fi
}

function get_api_base_url() {
  local domain
  domain=$(get_active_domain)
  local server_ip
  server_ip=$(cat /etc/zivpn/ip.txt 2>/dev/null)

  if [ -f "$DOMAIN_CONF" ]; then
    source "$DOMAIN_CONF"
    if [ "${SSL_ENABLED}" = "true" ]; then
      echo "https://${domain}"
      return
    fi
  fi
  # fallback
  echo "http://${server_ip}:5888"
}

function send_telegram_notification() {
local message="$1"
local keyboard="$2"
if [ ! -f "$TELEGRAM_CONF" ]; then
return 1
fi
source "$TELEGRAM_CONF"
if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
local api_url="https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage"
if [ -n "$keyboard" ]; then
curl -s -X POST "$api_url" -d "chat_id=${TELEGRAM_CHAT_ID}" --data-urlencode "text=${message}" -d "reply_markup=${keyboard}" > /dev/null
else
curl -s -X POST "$api_url" -d "chat_id=${TELEGRAM_CHAT_ID}" --data-urlencode "text=${message}" -d "parse_mode=Markdown" > /dev/null
fi
fi
}

function verify_license() {
echo "Verifying installation license..."
local SERVER_IP
SERVER_IP=$(cat /etc/zivpn/ip.txt)
if [ -z "$SERVER_IP" ]; then
echo -e "${RED}Failed to retrieve server IP. Please check your internet connection.${NC}"
exit 1
fi
local license_data
license_data=$(curl -s "$LICENSE_URL")
if [ $? -ne 0 ] || [ -z "$license_data" ]; then
echo -e "${RED}Gagal terhubung ke server lisensi. Mohon periksa koneksi internet Anda.${NC}"
exit 1
fi
local license_entry
license_entry=$(echo "$license_data" | grep -w "$SERVER_IP")
if [ -z "$license_entry" ]; then
echo -e "${RED}Verifikasi Lisensi Gagal! IP Anda tidak terdaftar. IP: ${SERVER_IP}${NC}"
exit 1
fi
local client_name
local expiry_date_str
client_name=$(echo "$license_entry" | awk '{print $1}')
expiry_date_str=$(echo "$license_entry" | awk '{print $2}')
local expiry_timestamp
expiry_timestamp=$(date -d "$expiry_date_str" +%s)
local current_timestamp
current_timestamp=$(date +%s)
if [ "$expiry_timestamp" -le "$current_timestamp" ]; then
echo -e "${RED}Verifikasi Lisensi Gagal! Lisensi untuk IP ${SERVER_IP} telah kedaluwarsa. Tanggal Kedaluwarsa: ${expiry_date_str}${NC}"
exit 1
fi
echo -e "${LIGHT_GREEN}Verifikasi Lisensi Berhasil! Client: ${client_name}, IP: ${SERVER_IP}${NC}"
sleep 2
mkdir -p /etc/zivpn
echo "CLIENT_NAME=${client_name}" > "$LICENSE_INFO_FILE"
echo "EXPIRY_DATE=${expiry_date_str}" >> "$LICENSE_INFO_FILE"
}

update_expiry_from_license_url() {
echo "Syncing expiry license..."
local SERVER_IP
SERVER_IP=$(cat /etc/zivpn/ip.txt)
if [ -z "$SERVER_IP" ]; then
echo -e "${RED}Gagal mendapatkan IP server${NC}"
return 1
fi
local license_data
license_data=$(curl -s "$LICENSE_URL")
if [ $? -ne 0 ] || [ -z "$license_data" ]; then
echo -e "${RED}Gagal mengambil data lisensi${NC}"
return 1
fi
local license_entry
license_entry=$(echo "$license_data" | grep -w "$SERVER_IP")
if [ -z "$license_entry" ]; then
echo -e "${RED}IP tidak terdaftar di lisensi${NC}"
return 1
fi
local CLIENT_NAME NEW_EXP_FROM_SERVER
CLIENT_NAME=$(echo "$license_entry" | awk '{print $1}')
NEW_EXP_FROM_SERVER=$(echo "$license_entry" | awk '{print $2}')
if ! date -d "$NEW_EXP_FROM_SERVER" >/dev/null 2>&1; then
echo -e "${RED}Format tanggal EXP dari server tidak valid${NC}"
return 1
fi
mkdir -p "$CONFIG_DIR"
cat > "$LICENSE_INFO_FILE" <<EOF
CLIENT_NAME=${CLIENT_NAME}
EXPIRY_DATE=${NEW_EXP_FROM_SERVER}
EOF
echo -e "${LIGHT_GREEN}Sinkronisasi lisensi berhasil!${NC}"
echo -e "Client  : ${CLIENT_NAME}"
echo -e "Expiry  : ${NEW_EXP_FROM_SERVER}"
}

function restart_zivpn() {
systemctl restart zivpn.service --no-block
}

function _create_account_logic() {
local password="$1"
local days="$2"
local db_file="/etc/zivpn/users.db"
if [ -z "$password" ] || [ -z "$days" ]; then
echo "Error: Password and days are required."
return 1
fi
if ! [[ "$days" =~ ^[0-9]+$ ]]; then
echo "Error: Invalid number of days."
return 1
fi
if grep -q "^${password}:" "$db_file"; then
echo "Error: Password '${password}' already exists."
return 1
fi
local expiry_date
expiry_date=$(date -d "+$days days" +%s)
echo "${password}:${expiry_date}" >> "$db_file"
jq --arg pass "$password" '.auth.config += [$pass]' /etc/zivpn/config.json > /etc/zivpn/config.json.tmp && mv /etc/zivpn/config.json.tmp /etc/zivpn/config.json
if [ $? -eq 0 ]; then
restart_zivpn
local EXPIRE_FORMATTED
EXPIRE_FORMATTED=$(date -d "@$expiry_date" +"%d %B %Y %H:%M")
ip=$(cat /etc/zivpn/ip.txt)
isp=$(cat /etc/zivpn/isp.txt)
local host
host=$(get_active_domain)
local api_base
api_base=$(get_api_base_url)
local api_key
api_key=$(cat /etc/zivpn/api_auth.key 2>/dev/null || echo "N/A")
clear
echo "Success:"
echo "CREATE AKUN ZIVPN"
echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "â”‚ Host   : $host"
echo "â”‚ IP     : $ip"
echo "â”‚ ISP    : $isp"
echo "â”‚ Pass   : $password"
echo "â”‚ Expire : $EXPIRE_FORMATTED"
echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
echo "â”‚ API URL: ${api_base}/create/zivpn"
echo "â”‚         ?password=${password}&exp=${days}&auth=${api_key}"
echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
echo "Terima kasih telah menggunakan layanan kami"
local message=$(cat <<EOF
CREATE AKUN ZIVPN
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Host   : $host
â”‚ IP     : $ip
â”‚ ISP    : $isp
â”‚ Pass   : $password
â”‚ Expire : $EXPIRE_FORMATTED
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
EOF
)
send_telegram_notification "$message"
return 0
else
sed -i "/^${password}:/d" "$db_file"
echo "Error: Failed to update config.json."
return 1
fi
}

function create_manual_account() {
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€ Create New Zivpn Account â”€â”€â”€â”€â”€â”€â”€"
read -p "Enter new password: " password
if [ -z "$password" ]; then
echo "Password cannot be empty."
return
fi
read -p "Enter active period (in days): " days
if ! [[ "$days" =~ ^[0-9]+$ ]]; then
echo "Invalid number of days."
return
fi
local result
result=$(_create_account_logic "$password" "$days")
if [[ "$result" == "Success"* ]]; then
local db_file="/etc/zivpn/users.db"
local user_line
user_line=$(grep "^${password}:" "$db_file")
if [ -n "$user_line" ]; then
local expiry_date
expiry_date=$(echo "$user_line" | cut -d: -f2)
local HOST
HOST=$(get_active_domain)
local EXPIRE_FORMATTED
EXPIRE_FORMATTED=$(date -d "@$expiry_date" +"%d %B %Y %H:%M")
fi
else
echo "$result"
fi
read -p "Tekan Enter untuk kembali ke menu..."
}

function _generate_api_key() {
clear
echo "â”€â”€â”€ Generate API Authentication Key â”€â”€â”€"
local api_key
api_key=$(LC_ALL=C tr -dc 'a-zA-Z0-9' < /dev/urandom | head -c 6)
local key_file="/etc/zivpn/api_auth.key"
echo "$api_key" > "$key_file"
chmod 600 "$key_file"
echo "New API authentication key has been generated and saved."
echo "Key: ${api_key}"
local server_ip
server_ip=$(cat /etc/zivpn/ip.txt)
local domain
domain=$(get_active_domain)
local api_base
api_base=$(get_api_base_url)
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo " Contoh Penggunaan API:"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo " Trial   : ${api_base}/trial/zivpn?exp=60&auth=${api_key}"
echo " Create  : ${api_base}/create/zivpn?password=PASS&exp=30&auth=${api_key}"
echo " Renew   : ${api_base}/renew/zivpn?password=PASS&exp=30&auth=${api_key}"
echo " Delete  : ${api_base}/delete/zivpn?password=PASS&auth=${api_key}"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
/usr/local/bin/zivpn_helper.sh api-key-notification "$api_key" "$server_ip" "$domain" 2>/dev/null || true
read -p "Tekan Enter untuk kembali ke menu..."
}

function _lihat_api_key() {
clear
echo "â”€â”€â”€ Lihat API Authentication Key â”€â”€â”€"
local key_file="/etc/zivpn/api_auth.key"
if [ ! -f "$key_file" ]; then
echo "API key belum dibuat!"
echo "Silakan generate API key terlebih dahulu."
read -p "Tekan Enter untuk kembali..."
return
fi
local api_key
api_key=$(cat "$key_file")
local api_base
api_base=$(get_api_base_url)
echo ""
echo "API Authentication Key:"
echo "-----------------------"
echo "Key: ${api_key}"
echo ""
echo "Base URL: ${api_base}"
echo ""
echo "Contoh Penggunaan:"
echo " Trial : ${api_base}/trial/zivpn?exp=60&auth=${api_key}"
echo " Create: ${api_base}/create/zivpn?password=PASS&exp=30&auth=${api_key}"
echo " Renew : ${api_base}/renew/zivpn?password=PASS&exp=30&auth=${api_key}"
echo " Delete: ${api_base}/delete/zivpn?password=PASS&auth=${api_key}"
echo ""
echo "Lokasi file: $key_file"
echo ""
read -p "Tekan Enter untuk kembali ke menu..."
}

function _create_trial_account_logic() {
local minutes="$1"
local db_file="/etc/zivpn/users.db"
if ! [[ "$minutes" =~ ^[0-9]+$ ]]; then
echo "Error: Invalid number of minutes."
return 1
fi
local password="trial$(shuf -i 10000-99999 -n 1)"
local expiry_date
expiry_date=$(date -d "+$minutes minutes" +%s)
echo "${password}:${expiry_date}" >> "$db_file"
jq --arg pass "$password" '.auth.config += [$pass]' /etc/zivpn/config.json > /etc/zivpn/config.json.tmp && mv /etc/zivpn/config.json.tmp /etc/zivpn/config.json
if [ $? -eq 0 ]; then
restart_zivpn
local EXPIRE_FORMATTED
EXPIRE_FORMATTED=$(date -d "@$expiry_date" +"%d %B %Y %H:%M")
ip=$(cat /etc/zivpn/ip.txt)
isp=$(cat /etc/zivpn/isp.txt)
local host
host=$(get_active_domain)
local api_key
api_key=$(cat /etc/zivpn/api_auth.key 2>/dev/null || echo "N/A")
clear
echo "Success:"
echo "TRIAL AKUN ZIVPN"
echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "â”‚ Host   : $host"
echo "â”‚ IP     : $ip"
echo "â”‚ ISP    : $isp"
echo "â”‚ Pass   : $password"
echo "â”‚ Expire : $EXPIRE_FORMATTED"
echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
echo "Terima kasih telah menggunakan layanan kami"
local message=$(cat <<EOF
TRIAL AKUN ZIVPN
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Host   : $host
â”‚ IP     : $ip
â”‚ ISP    : $isp
â”‚ Pass   : $password
â”‚ Expire : $EXPIRE_FORMATTED
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Terima kasih telah mencoba layanan kami
EOF
)
send_telegram_notification "$message"
return 0
else
sed -i "/^${password}:/d" "$db_file"
echo "Error: Failed to update config.json."
return 1
fi
}

function create_trial_account() {
echo "â”€â”€â”€â”€â”€â”€â”€ Create Trial Zivpn Account â”€â”€â”€â”€â”€â”€â”€"
read -p "Enter active period (in minutes): " minutes
if ! [[ "$minutes" =~ ^[0-9]+$ ]]; then
echo "Invalid number of minutes."
return
fi
local result
result=$(_create_trial_account_logic "$minutes")
echo "$result"
read -p "Tekan Enter untuk kembali ke menu..."
}

function _renew_account_logic() {
local password="$1"
local days="$2"
local db_file="/etc/zivpn/users.db"
if [ -z "$password" ] || [ -z "$days" ]; then
echo "Error: Password and days are required."
return 1
fi
if ! [[ "$days" =~ ^[1-9][0-9]*$ ]]; then
echo "Error: Invalid number of days."
return 1
fi
local user_line
user_line=$(grep "^${password}:" "$db_file")
if [ -z "$user_line" ]; then
echo "Error: Account '${password}' not found."
return 1
fi
local current_expiry_date
current_expiry_date=$(echo "$user_line" | cut -d: -f2)
if ! [[ "$current_expiry_date" =~ ^[0-9]+$ ]]; then
echo "Error: Corrupted database entry for user '$password'."
return 1
fi
local seconds_to_add=$((days * 86400))
local new_expiry_date=$((current_expiry_date + seconds_to_add))
sed -i "s/^${password}:.*/${password}:${new_expiry_date}/" "$db_file"
local new_expiry_formatted
new_expiry_formatted=$(date -d "@$new_expiry_date" +"%d %B %Y %H:%M")
ip=$(cat /etc/zivpn/ip.txt)
isp=$(cat /etc/zivpn/isp.txt)
local host
host=$(get_active_domain)
clear
echo "Success:"
echo "RENEW AKUN ZIVPN"
echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "â”‚ Host   : $host"
echo "â”‚ IP     : $ip"
echo "â”‚ ISP    : $isp"
echo "â”‚ Pass   : $password"
echo "â”‚ Expire : $new_expiry_formatted"
echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
echo "Terima kasih telah menggunakan layanan kami"
local message=$(cat <<EOF
RENEW AKUN ZIVPN
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Host   : $host
â”‚ IP     : $ip
â”‚ ISP    : $isp
â”‚ Pass   : $password
â”‚ Expire : $new_expiry_formatted
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Terima kasih telah menggunakan layanan kami
EOF
)
send_telegram_notification "$message"
return 0
}

function renew_account() {
clear
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Renew Account â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
_display_accounts
echo ""
read -p "Enter password to renew: " password
if [ -z "$password" ]; then
echo "Password cannot be empty."
return
fi
read -p "Enter number of days to extend: " days
if ! [[ "$days" =~ ^[1-9][0-9]*$ ]]; then
echo "Invalid number of days. Please enter a positive number."
return
fi
local result
result=$(_renew_account_logic "$password" "$days")
echo "$result"
read -p "Tekan Enter untuk kembali ke menu..."
}

function _delete_account_logic() {
local password="$1"
local db_file="/etc/zivpn/users.db"
local config_file="/etc/zivpn/config.json"
local tmp_config_file="${config_file}.tmp"
if [ -z "$password" ]; then
echo "Error: Password is required."
return 1
fi
if [ ! -f "$db_file" ] || ! grep -q "^${password}:" "$db_file"; then
echo "Error: Password '${password}' not found."
return 1
fi
jq --arg pass "$password" 'del(.auth.config[] | select(. == $pass))' "$config_file" > "$tmp_config_file"
if [ $? -eq 0 ]; then
sed -i "/^${password}:/d" "$db_file"
mv "$tmp_config_file" "$config_file"
restart_zivpn
ip=$(cat /etc/zivpn/ip.txt)
isp=$(cat /etc/zivpn/isp.txt)
local host
host=$(get_active_domain)
clear
echo "Success:"
echo "DELETE AKUN ZIVPN"
echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "â”‚ Host   : $host"
echo "â”‚ IP     : $ip"
echo "â”‚ ISP    : $isp"
echo "â”‚ Pass   : $password"
echo "â”‚ Status : Deleted"
echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
echo "Terima kasih telah menggunakan layanan kami"
local message=$(cat <<EOF
DELETE AKUN ZIVPN
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Host   : $host
â”‚ IP     : $ip
â”‚ ISP    : $isp
â”‚ Pass   : $password
â”‚ Status : Deleted
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Terima kasih telah menggunakan layanan kami
EOF
)
send_telegram_notification "$message"
return 0
else
rm -f "$tmp_config_file"
echo "Error: Failed to update config.json. No changes were made."
return 1
fi
}

function delete_account() {
clear
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Delete Account â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
_display_accounts
echo ""
read -p "Enter password to delete: " password
if [ -z "$password" ]; then
echo "Password cannot be empty."
return
fi
local result
result=$(_delete_account_logic "$password")
echo "$result"
read -p "Tekan Enter untuk kembali ke menu..."
}

function change_domain() {
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Change Domain â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "1) Ganti Domain + SSL (acme.sh / Let's Encrypt)"
echo "2) Ganti Domain Manual (Self-Signed)"
echo "0) Kembali"
read -p "Pilih: " opt
case $opt in
1)
  echo ""
  local server_ip
  server_ip=$(cat /etc/zivpn/ip.txt 2>/dev/null)
  echo -e "  ${_Y}IP server ini: ${_W}${server_ip}${NC}"
  echo -e "  ${_Y}Pastikan DNS A record domain sudah pointing ke IP di atas sebelum lanjut.${NC}"
  echo ""
  local domain=""
  while true; do
    read -p "  Masukkan domain (contoh: vpn.example.com): " domain
    domain=$(echo "$domain" | tr -d ' ' | tr '[:upper:]' '[:lower:]')
    if [ -z "$domain" ]; then echo -e "  ${_R}Domain tidak boleh kosong.${NC}"; continue; fi
    if ! echo "$domain" | grep -qE '^[a-z0-9]([a-z0-9\-]*[a-z0-9])?(\.[a-z0-9]([a-z0-9\-]*[a-z0-9])?)+$'; then
      echo -e "  ${_R}Format domain tidak valid.${NC}"; continue
    fi
    read -p "  Domain: ${domain} â€” Sudah benar? (y/n): " confirm
    [[ "$confirm" =~ ^[Yy]$ ]] && break
  done
  # Simpan domain conf
  printf 'DOMAIN=%s\nSERVER_IP=%s\nSSL_ENABLED=true\n' "$domain" "$server_ip" > "$DOMAIN_CONF"
  # Pasang SSL dengan acme.sh
  issue_ssl_acme "$domain"
  # Setup nginx
  setup_nginx_ssl_proxy "$domain"
  echo ""
  _ok "Domain baru  : ${domain}"
  _ok "API URL      : https://${domain}"
  restart_zivpn
  ;;
2)
  read -p "Enter the new domain name: " domain
  if [ -z "$domain" ]; then echo "Domain cannot be empty."; return; fi
  openssl req -x509 -newkey rsa:4096 -days 365 -nodes \
    -subj "/C=US/ST=Jakarta/L=Jakarta/O=NexusDev/OU=VPN/CN=${domain}" \
    -keyout "/etc/zivpn/zivpn.key" -out "/etc/zivpn/zivpn.crt" 2>/dev/null
  chmod 600 /etc/zivpn/zivpn.key
  local server_ip; server_ip=$(cat /etc/zivpn/ip.txt 2>/dev/null)
  printf 'DOMAIN=%s\nSERVER_IP=%s\nSSL_ENABLED=false\n' "$domain" "$server_ip" > "$DOMAIN_CONF"
  setup_nginx_ssl_proxy "$domain"
  echo "Self-signed certificate generated untuk ${domain}."
  restart_zivpn
  ;;
esac
read -p "Tekan Enter untuk kembali ke menu..."
}

function _save_total_users() {
local db_file="/etc/zivpn/users.db"
local output_file="/etc/zivpn/total_users.txt"
if [ ! -f "$db_file" ] || [ ! -s "$db_file" ]; then
echo "0" > "$output_file"
return
fi
local total_users
total_users=$(wc -l < "$db_file" | tr -d ' ')
echo "$total_users" > "$output_file"
}

function _display_accounts() {
local db_file="/etc/zivpn/users.db"
if [ ! -f "$db_file" ] || [ ! -s "$db_file" ]; then
echo "No accounts found."
return
fi
local current_date
current_date=$(date +%s)
printf "%-20s â”‚ %s\n" "Password" "Expires in (days)"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
while IFS=':' read -r password expiry_date; do
if [[ -n "$password" ]]; then
local remaining_seconds=$((expiry_date - current_date))
if [ $remaining_seconds -gt 0 ]; then
local remaining_days=$((remaining_seconds / 86400))
printf "%-20s â”‚ %s days\n" "$password" "$remaining_days"
else
printf "%-20s â”‚ Expired\n" "$password"
fi
fi
done < "$db_file"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
}

function list_accounts() {
clear
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Active Accounts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
_display_accounts
echo ""
read -p "Press Enter to return to the menu..."
}

function format_kib_to_human() {
local kib=$1
if ! [[ "$kib" =~ ^[0-9]+$ ]] || [ -z "$kib" ]; then kib=0; fi
if [ "$kib" -lt 1048576 ]; then
awk -v val="$kib" 'BEGIN { printf "%.2f MiB", val / 1024 }'
else
awk -v val="$kib" 'BEGIN { printf "%.2f GiB", val / 1048576 }'
fi
}

function get_main_interface() {
ip -o -4 route show to default | awk '{print $5}' | head -n 1
}

function _draw_info_panel() {
local os_info isp_info ip_info host_info bw_today bw_month client_name license_exp
os_info=$( (hostnamectl 2>/dev/null | grep "Operating System" | cut -d: -f2 | sed 's/^[ \t]*//') || echo "N/A" )
os_info=${os_info:-"N/A"}
ip_info=$(cat /etc/zivpn/ip.txt)
isp_info=$(cat /etc/zivpn/isp.txt)
ip_info=${ip_info:-"N/A"}
isp_info=${isp_info:-"N/A"}
host_info=$(get_active_domain)
host_info=${host_info:-"N/A"}
cpu_name=$(lscpu | grep "Model name" | cut -d: -f2 | sed 's/^[ \t]*//')
cpu_cores=$(nproc)
mem_total=$(free -h | awk '/Mem:/ {print $2}')
mem_used=$(free -h | awk '/Mem:/ {print $3}')
disk_total=$(df -h / | awk 'NR==2 {print $2}')
disk_used=$(df -h / | awk 'NR==2 {print $3}')
disk_percent=$(df -h / | awk 'NR==2 {print $5}')
uptime_info=$(uptime -p)
bw_today=$(vnstat -d | awk '/'"$(date +%Y-%m-%d)"'/ {print $5 " " $6}')
bw_month=$(vnstat -m | awk '/'"$(date +%Y-%m)"'/ {print $5 " " $6}')

# SSL status
local ssl_status="HTTP (No SSL)"
if [ -f "$DOMAIN_CONF" ]; then
  source "$DOMAIN_CONF"
  if [ "${SSL_ENABLED}" = "true" ]; then
    ssl_status="HTTPS âœ” (${DOMAIN})"
  fi
fi

if [ -f "$LICENSE_INFO_FILE" ]; then
source "$LICENSE_INFO_FILE"
client_name=${CLIENT_NAME:-"N/A"}
if [ -n "$EXPIRY_DATE" ]; then
local expiry_timestamp
expiry_timestamp=$(date -d "$EXPIRY_DATE" +%s)
local current_timestamp
current_timestamp=$(date +%s)
local remaining_seconds=$((expiry_timestamp - current_timestamp))
if [ $remaining_seconds -gt 0 ]; then
license_exp="$((remaining_seconds / 86400)) days"
else
license_exp="Expired"
fi
else
license_exp="N/A"
fi
else
client_name="N/A"
license_exp="N/A"
fi
_save_total_users
total_users=$(cat /etc/zivpn/total_users.txt)
apikey=$(cat /etc/zivpn/api_auth.key 2>/dev/null || echo "N/A")
VERSI_URL="https://raw.githubusercontent.com/AutoNV/udpzivpn/main/versi.txt"
versisc=$(curl -fsSL "$VERSI_URL" 2>/dev/null | tr -d ' \r\n')
if [ -z "$versisc" ]; then versisc="UNKNOWN"; fi

  local W='\033[1;37m'
  local G='\033[1;32m'
  local C='\033[0;36m'
  local N='\033[0m'

  printf "${C}â”‚${W} %-10s ${C}:${W} %s${N}\n"   "OS"      "${os_info}"
  printf "${C}â”‚${W} %-10s ${C}:${W} %s${N}\n"   "IP"      "${ip_info}"
  printf "${C}â”‚${W} %-10s ${C}:${G} %s${N}\n"   "Domain"  "${host_info}"
  printf "${C}â”‚${W} %-10s ${C}:${G} %s${N}\n"   "SSL"     "${ssl_status}"
  printf "${C}â”‚${W} %-10s ${C}:${G} %s${N}\n"   "Client"  "${client_name}"
  printf "${C}â”‚${W} %-10s ${C}:${G} %s${N}\n"   "EXP"     "${license_exp}"
  printf "${C}â”‚${W} %-10s ${C}:${W} %s${N}\n"   "RAM"     "${mem_used} / ${mem_total}"
  printf "${C}â”‚${W} %-10s ${C}:${W} %s${N}\n"   "CPU"     "${cpu_name} (${cpu_cores} cores)"
  printf "${C}â”‚${W} %-10s ${C}:${W} %s${N}\n"   "Disk"    "${disk_used} / ${disk_total} (${disk_percent})"
  printf "${C}â”‚${W} %-10s ${C}:${W} %-20s  ${W}Users ${C}:${G} %s${N}\n"  "Uptime"   "${uptime_info}" "${total_users}"
  printf "${C}â”‚${W} %-10s ${C}:${G} %-14s  ${W}Month ${C}:${G} %s${N}\n"  "BW Today" "${bw_today}"    "${bw_month}"
  printf "${C}â”‚${W} %-10s ${C}:${G} %s${N}\n"   "Version" "${versisc}"
}

function _draw_service_status() {
  local W='\033[1;37m'
  local G='\033[1;32m'
  local R='\033[0;31m'
  local Y='\033[1;33m'
  local C='\033[0;36m'
  local N='\033[0m'

  local sv1; sv1=$(systemctl is-active "zivpn.service" 2>/dev/null || echo "unknown")
  local st1 sc1
  case "$sv1" in
    active)     st1="ON";  sc1="$G" ;;
    inactive)   st1="OFF"; sc1="$R" ;;
    failed)     st1="ERR"; sc1="$R" ;;
    activating) st1="..."; sc1="$Y" ;;
    *)          st1="OFF"; sc1="$R" ;;
  esac

  local sv2; sv2=$(systemctl is-active "zivpn-api.service" 2>/dev/null || echo "unknown")
  local st2 sc2
  case "$sv2" in
    active)     st2="ON";  sc2="$G" ;;
    inactive)   st2="OFF"; sc2="$R" ;;
    failed)     st2="ERR"; sc2="$R" ;;
    activating) st2="..."; sc2="$Y" ;;
    *)          st2="OFF"; sc2="$R" ;;
  esac

  # Nginx SSL proxy status
  local sv3; sv3=$(systemctl is-active "nginx" 2>/dev/null || echo "unknown")
  local st3 sc3
  case "$sv3" in
    active)     st3="ON";  sc3="$G" ;;
    *)          st3="OFF"; sc3="$R" ;;
  esac

  local rule_ok="no"
  iptables -t nat -S PREROUTING 2>/dev/null | grep -qE "6000:19999|:5667" && rule_ok="yes"
  local st4 sc4
  if [ "$rule_ok" = "yes" ]; then st4="ON";  sc4="$G"
  else                             st4="OFF"; sc4="$R"
  fi

  printf "${C}â”‚${W} ZiVPN ${C}:${sc1}%-3s${W}  API ${C}:${sc2}%-3s${W}  Nginx SSL ${C}:${sc3}%-3s${W}  ZI ${C}:${sc4}%s${N}\n" \
         "$st1" "$st2" "$st3" "$st4"
}

function setup_auto_backup() {
echo "â”€â”€â”€ Configure Auto Backup â”€â”€â”€"
if [ ! -f "/etc/zivpn/telegram.conf" ]; then
echo "Telegram is not configured."
return
fi
read -p "Enter backup interval in hours (e.g., 6, 12, 24). Enter 0 to disable: " interval
if ! [[ "$interval" =~ ^[0-9]+$ ]]; then echo "Invalid input."; return; fi
(crontab -l 2>/dev/null | grep -v "# zivpn-auto-backup") | crontab -
if [ "$interval" -gt 0 ]; then
local cron_schedule="0 */${interval} * * *"
(crontab -l 2>/dev/null; echo "${cron_schedule} /usr/local/bin/zivpn_helper.sh backup >/dev/null 2>&1 # zivpn-auto-backup") | crontab -
echo "Auto backup scheduled every ${interval} hour(s)."
else
echo "Auto backup disabled."
fi
}

function create_account() {
clear
echo -e "${YELLOW}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
echo -e "${YELLOW}â”‚${NC}           ${BOLD_WHITE}âœ¦  Create Account  âœ¦${NC}                        ${YELLOW}â”‚${NC}"
echo -e "${YELLOW}â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤${NC}"
echo -e "${YELLOW}â”‚${NC}   ${LIGHT_BLUE}1)${NC}  ${BOLD_WHITE}Create Zivpn                                  ${YELLOW}â”‚${NC}"
echo -e "${YELLOW}â”‚${NC}   ${LIGHT_BLUE}2)${NC}  ${BOLD_WHITE}Trial Zivpn                                   ${YELLOW}â”‚${NC}"
echo -e "${YELLOW}â”‚${NC}   ${LIGHT_BLUE}0)${NC}  ${BOLD_WHITE}Back to Main Menu                             ${YELLOW}â”‚${NC}"
echo -e "${YELLOW}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
read -p " Enter your choice [0-2]: " choice
case $choice in
1) create_manual_account ;;
2) create_trial_account ;;
0) return ;;
*) echo "Invalid option." ;;
esac
}

function show_backup_menu() {
clear
echo -e "${YELLOW}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
echo -e "${YELLOW}â”‚${NC}           ${BOLD_WHITE}âœ¦  Backup / Restore  âœ¦${NC}                      ${YELLOW}â”‚${NC}"
echo -e "${YELLOW}â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤${NC}"
echo -e "${YELLOW}â”‚${NC}   ${LIGHT_BLUE}1)${NC}  ${BOLD_WHITE}Backup Data                                   ${YELLOW}â”‚${NC}"
echo -e "${YELLOW}â”‚${NC}   ${LIGHT_BLUE}2)${NC}  ${BOLD_WHITE}Restore Data                                  ${YELLOW}â”‚${NC}"
echo -e "${YELLOW}â”‚${NC}   ${LIGHT_BLUE}3)${NC}  ${BOLD_WHITE}Auto Backup                                   ${YELLOW}â”‚${NC}"
echo -e "${YELLOW}â”‚${NC}   ${LIGHT_BLUE}4)${NC}  ${BOLD_WHITE}Atur Ulang Notifikasi Telegram                ${YELLOW}â”‚${NC}"
echo -e "${YELLOW}â”‚${NC}   ${LIGHT_BLUE}0)${NC}  ${BOLD_WHITE}Back to Main Menu                             ${YELLOW}â”‚${NC}"
echo -e "${YELLOW}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
read -p " Enter your choice [0-4]: " choice
case $choice in
1) /usr/local/bin/zivpn_helper.sh backup ;;
2) /usr/local/bin/zivpn_helper.sh restore ;;
3) setup_auto_backup ;;
4) /usr/local/bin/zivpn_helper.sh setup-telegram ;;
0) return ;;
*) echo "Invalid option." ;;
esac
}

function set_reboot_at_time() {
local HOUR="$1"
local MINUTE="0"
local CRON_TAG="#ZIVPN_AUTO_REBOOT"
crontab -l 2>/dev/null | grep -v "$CRON_TAG" > /tmp/cron_zivpn || true
echo "$MINUTE $HOUR * * * /sbin/reboot $CRON_TAG" >> /tmp/cron_zivpn
crontab /tmp/cron_zivpn
rm -f /tmp/cron_zivpn
echo -e "${GREEN}âœ” Auto reboot diset jam $(printf '%02d:00' "$HOUR")${NC}"
}

function remove_reboot_schedule() {
local CRON_TAG="#ZIVPN_AUTO_REBOOT"
crontab -l 2>/dev/null | grep -v "$CRON_TAG" | crontab -
echo -e "${YELLOW}âœ” Auto reboot dihapus${NC}"
}

function set_reboot_menu() {
clear
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${CYAN}     PILIH JAM AUTO REBOOT     ${NC}"
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
for i in $(seq 1 24); do
if [[ "$i" -eq 24 ]]; then printf "%2d) Jam 00:00\n" "$i"
else printf "%2d) Jam %02d:00\n" "$i" "$i"; fi
done
echo " 0) Hapus Auto Reboot"
echo ""
read -rp "Pilih [1-24 / 0]: " choice
if [[ "$choice" == "0" ]]; then remove_reboot_schedule; return; fi
if [[ "$choice" -ge 1 && "$choice" -le 24 ]]; then
if [[ "$choice" -eq 24 ]]; then set_reboot_at_time 0
else set_reboot_at_time "$choice"; fi
else
echo -e "${RED}âŒ Pilihan tidak valid${NC}"
fi
}

function fix_nginx() {
clear
echo -e "${_C}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${_W}       ğŸ”§  Fix / Restart Nginx SSL         ${NC}"
echo -e "${_C}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

local domain
domain=$(get_active_domain)
local server_ip
server_ip=$(cat /etc/zivpn/ip.txt 2>/dev/null)

if [ -z "$domain" ] || [ "$domain" = "$server_ip" ]; then
  _err "Domain belum di-set. Jalankan menu 4 (Ganti Domain) dulu."
  read -p "Tekan Enter untuk kembali..."
  return 1
fi

echo -e "  ${_W}Domain aktif : ${_G}${domain}${NC}"
echo ""
echo "  1) Fix Nginx saja (restart + perbaiki config)"
echo "  2) Fix Nginx + Issue ulang SSL (acme.sh)"
echo "  0) Kembali"
echo ""
read -p "  Pilih: " fix_opt

case "$fix_opt" in
  2)
    _hdr "Re-issue SSL via acme.sh"
    issue_ssl_acme "$domain"
    ;;
  0) return ;;
esac

# Step 1: Pastikan nginx terinstall
_progress "Cek instalasi nginx"
if ! command -v nginx &>/dev/null; then
  apt install -y nginx >/dev/null 2>&1
  _ok "Nginx diinstall"
else
  _ok "Nginx sudah terinstall"
fi

# Step 2: Fix SSL cert/key mismatch
_progress "Cek SSL cert/key"
_fix_ssl_key_mismatch "$domain"

# Step 3: Tulis ulang config nginx pakai printf (bukan heredoc)
_progress "Tulis ulang config nginx"
_write_nginx_config "$domain"
_ok "Config nginx ditulis ulang (clean)"

# Step 4: Pastikan symlink aktif
_progress "Aktifkan symlink nginx"
ln -sf /etc/nginx/sites-available/zivpn-api /etc/nginx/sites-enabled/zivpn-api
rm -f /etc/nginx/sites-enabled/default 2>/dev/null || true
_ok "Symlink aktif"

# Step 5: Buka port
_progress "Buka port 80 dan 443"
iptables -I INPUT -p tcp --dport 443 -j ACCEPT 2>/dev/null
iptables -I INPUT -p tcp --dport 80 -j ACCEPT 2>/dev/null
netfilter-persistent save >/dev/null 2>&1 || true
_ok "Port 80 dan 443 terbuka"

# Step 6: Test config nginx
_progress "Test konfigurasi nginx"
local test_result
test_result=$(nginx -t 2>&1)
if echo "$test_result" | grep -q "syntax is ok"; then
  _ok "Konfigurasi nginx valid"
else
  _err "Nginx config masih error:"
  echo "$test_result" | grep "emerg\|error" | head -5
  read -p "Tekan Enter untuk kembali..."
  return 1
fi

# Step 7: Restart nginx
_progress "Restart nginx"
systemctl daemon-reload
systemctl enable nginx >/dev/null 2>&1
systemctl restart nginx

sleep 1
local nginx_status
nginx_status=$(systemctl is-active nginx 2>/dev/null)
if [ "$nginx_status" = "active" ]; then
  _ok "Nginx AKTIF âœ”"
else
  _err "Nginx masih gagal start"
  echo ""
  echo "â”€â”€â”€ Error log nginx â”€â”€â”€"
  journalctl -u nginx --no-pager -n 20 2>/dev/null | tail -15
fi

echo ""
echo -e "${_C}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
local api_base
api_base=$(get_api_base_url)
local api_key
api_key=$(cat /etc/zivpn/api_auth.key 2>/dev/null || echo "N/A")
echo -e "${_W} Domain  : ${_G}${domain}${NC}"
echo -e "${_W} Status  : ${_G}$(systemctl is-active nginx)${NC}"
echo -e "${_W} API URL : ${_G}${api_base}/trial/zivpn?exp=60&auth=${api_key}${NC}"
echo -e "${_C}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""
read -p "Tekan Enter untuk kembali ke menu..."
}

function _auto_fix_nginx_if_down() {
  # Dipanggil otomatis saat show_menu - fix nginx diam-diam jika mati
  local nginx_status
  nginx_status=$(systemctl is-active nginx 2>/dev/null)
  if [ "$nginx_status" != "active" ]; then
    # Coba restart dulu (silent)
    systemctl restart nginx >/dev/null 2>&1
    sleep 1
    nginx_status=$(systemctl is-active nginx 2>/dev/null)
    if [ "$nginx_status" != "active" ]; then
      # Kalau masih mati, perbaiki config dulu lalu restart
      local domain
      domain=$(get_active_domain)
      local server_ip
      server_ip=$(cat /etc/zivpn/ip.txt 2>/dev/null)
      if [ -n "$domain" ] && [ "$domain" != "$server_ip" ]; then
        # Pastikan symlink ada
        ln -sf /etc/nginx/sites-available/zivpn-api /etc/nginx/sites-enabled/zivpn-api 2>/dev/null
        rm -f /etc/nginx/sites-enabled/default 2>/dev/null
        systemctl restart nginx >/dev/null 2>&1
      fi
    fi
  fi
}

function show_expired_message_and_exit() {
clear
echo -e "\n${RED}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
echo -e "${RED}          LISENSI ANDA TELAH KEDALUWARSA!             ${NC}"
echo -e "${RED}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}\n"
echo -e "${BOLD_WHITE}Akses ke layanan ZIVPN di server anda telah dihentikan."
echo -e "Untuk memperpanjang lisensi, silakan hubungi admin https://wa.me/62890 \n"
echo -e "${LIGHT_GREEN}Setelah diperpanjang, layanan akan aktif kembali secara otomatis.${NC}\n"
exit 0
}

function show_menu() {
if [ -f "/etc/zivpn/.expired" ]; then show_expired_message_and_exit; fi
# Auto fix nginx jika mati (silent background)
_auto_fix_nginx_if_down
clear

  local W='\033[1;37m'
  local G='\033[1;32m'
  local R='\033[0;31m'
  local C='\033[0;36m'
  local N='\033[0m'

  echo -e "${C}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
  echo -e "${C}â”‚${W}        âš¡  Menu Panel ZiVPN  âš¡          ${C}â”‚"
  echo -e "${C}â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

  _draw_info_panel

  echo -e "${C}â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Service Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
  _draw_service_status

  local _kf="/etc/zivpn/api_auth.key"
  local _ak; if [ -f "$_kf" ]; then _ak=$(cat "$_kf"); else _ak="(not set)"; fi
  local _api_base
  _api_base=$(get_api_base_url)
  echo -e "${C}â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
  printf  "${C}â”‚${W} API Key  ${C}:${G} %s${N}\n" "$_ak"
  printf  "${C}â”‚${W} API URL  ${C}:${G} %s${N}\n" "${_api_base}/trial/zivpn?exp=60&auth=${_ak}"

  echo -e "${C}â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
  printf  "${C}â”‚${W}  %2s. %-16s    %2s. %s${N}\n"  "1"  "Buat Akun"       "8"  "Lihat API Key"
  printf  "${C}â”‚${W}  %2s. %-16s    %2s. %s${N}\n"  "2"  "Perpanjang"      "9"  "Restart"
  printf  "${C}â”‚${W}  %2s. %-16s   %2s. %s${N}\n"   "3"  "Hapus Akun"      "10" "Update Script"
  printf  "${C}â”‚${W}  %2s. %-16s   %2s. %s${N}\n"   "4"  "Ganti Domain"    "11" "Update Lisensi"
  printf  "${C}â”‚${W}  %2s. %-16s   %2s. %s${N}\n"   "5"  "Daftar Akun"     "12" "Speedtest"
  printf  "${C}â”‚${W}  %2s. %-16s   %2s. %s${N}\n"   "6"  "Backup/Restore"  "13" "Perbaiki Error"
  printf  "${C}â”‚${W}  %2s. %-16s   %2s. %s${N}\n"   "7"  "Buat API Key"    "14" "Auto Reboot"

  # Tampilkan peringatan jika Nginx OFF
  local _ng_st; _ng_st=$(systemctl is-active nginx 2>/dev/null)
  if [ "$_ng_st" != "active" ]; then
    printf  "${C}â”‚${W}  %2s. %-16s   ${R}âš   Nginx SSL OFF â†’ Pilih 15 untuk Fix!${N}\n" "15" "Fix Nginx SSL"
  else
    printf  "${C}â”‚${W}  %2s. %-16s${N}\n" "15" "Fix Nginx SSL"
  fi
  echo -e "${C}â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
  printf  "${C}â”‚${W}  x) Keluar${N}\n"
  echo -e "${C}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${N}"
  echo ""
  read -p " Pilih Menu (1-15 atau x): " choice
  [[ "$choice" == "x" || "$choice" == "X" ]] && choice=0
case $choice in
1) create_account ;;
2) renew_account ;;
3) delete_account ;;
4) change_domain ;;
5) list_accounts ;;
6) show_backup_menu ;;
7) _generate_api_key ;;
8) _lihat_api_key ;;
9) systemctl restart zivpn.service --no-block && systemctl restart zivpn-udp.service --no-block && read -p "Tekan Enter..." && /usr/local/bin/zivpn-manager ;;
10) wget -q https://raw.githubusercontent.com/AutoNV/udpzivpn/main/update.sh -O /usr/local/bin/update-manager && chmod +x /usr/local/bin/update-manager && /usr/local/bin/update-manager && read -p "Tekan Enter..." && /usr/local/bin/zivpn-manager ;;
11) update_expiry_from_license_url && read -p "Tekan Enter..." && /usr/local/bin/zivpn-manager ;;
12) wget https://raw.githubusercontent.com/arivpnstores/v4/main/Cdy/speedtest -O /usr/bin/speedtest && chmod +x /usr/bin/speedtest && yes | /usr/bin/speedtest && read -p "Tekan Enter..." && /usr/local/bin/zivpn-manager ;;
13) wget -q https://raw.githubusercontent.com/AutoNV/udpzivpn/main/fix-zivpn.sh -O /usr/local/bin/fix-zivpn.sh && chmod +x /usr/local/bin/fix-zivpn.sh && /usr/local/bin/fix-zivpn.sh && read -p "Tekan Enter..." && /usr/local/bin/zivpn-manager ;;
14) set_reboot_menu ;;
15) fix_nginx ;;
0) exit 0 ;;
*) echo "Invalid option." ;;
esac
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  SETUP / INSTALL
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function run_setup() {
clear
_sep
echo -e "${_W}    âš¡  ZiVPN Manager - Installation${NC}"
_sep
echo -e "${_Y}    Thank you for using SC UDO ZiVPN${NC}"
echo -e "${_Y}    Powered by  N E X U S D E V${NC}"
_sep
echo ""
sleep 1.2

# â”€â”€ Verifikasi lisensi â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
_hdr "[ 1/9 ] Verifying license..."
_progress "Checking license"
verify_license

# â”€â”€ Persiapan sistem â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
_hdr "[ 2/9 ] Preparing system..."
export DEBIAN_FRONTEND=noninteractive
_progress "dpkg configure"
dpkg --configure -a >/dev/null 2>&1 || true
apt -f install -y >/dev/null 2>&1 || true
_ok "dpkg ready"

_progress "apt update"
apt update >/dev/null 2>&1
_ok "apt updated"

_progress "Installing dependencies"
apt install -y sudo screen ufw ruby rubygems curl wget python3-pip jq zip vnstat cron dnsutils nginx certbot >/dev/null 2>&1
_ok "Dependencies installed"

_progress "iptables-persistent"
echo iptables-persistent iptables-persistent/autosave_v4 boolean true | debconf-set-selections
echo iptables-persistent iptables-persistent/autosave_v6 boolean true | debconf-set-selections
apt install -y iptables-persistent netfilter-persistent >/dev/null 2>&1
iptables -t nat -F PREROUTING
netfilter-persistent save >/dev/null 2>&1
_ok "iptables-persistent ready"

_progress "ca-certificates"
apt install -y wget curl ca-certificates >/dev/null 2>&1
update-ca-certificates >/dev/null 2>&1
_ok "Certificates updated"

# â”€â”€ Stop service lama â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
_hdr "[ 3/9 ] Stopping old services..."
_progress "Stopping ZiVPN"
systemctl stop zivpn 2>/dev/null || true
rm -f /usr/local/bin/zivpn
_ok "Old service cleared"

# â”€â”€ Download & install ZiVPN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
_hdr "[ 4/9 ] Downloading ZiVPN binary..."
ARCH=$(uname -m)
case "$ARCH" in
  x86_64)        FILE="zi.sh"  ;;
  aarch64)       FILE="zi2.sh" ;;
  armv7l|armhf)  FILE="zi3.sh" ;;
  *)
    _err "Unsupported architecture: $ARCH"
    exit 1
  ;;
esac
_progress "Downloading $FILE"
wget -q -O /root/zi.sh "https://raw.githubusercontent.com/AutoNV/udpzivpn/main/$FILE"
chmod +x /root/zi.sh
_ok "ZiVPN binary downloaded ($ARCH)"

_progress "Running installer"
sudo /root/zi.sh >/dev/null 2>&1
_ok "ZiVPN binary installed"

_progress "Starting service"
systemctl daemon-reload
systemctl start zivpn
systemctl enable zivpn >/dev/null 2>&1
_ok "ZiVPN service started"

# â”€â”€ vnstat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
_hdr "[ 5/9 ] Setting up bandwidth monitor..."
local net_interface
net_interface=$(ip -o -4 route show to default | awk '{print $5}' | head -n 1)
if [ -n "$net_interface" ]; then
  _progress "vnstat setup"
  systemctl stop vnstat 2>/dev/null || true
  vnstat -u -i "$net_interface" --force 2>/dev/null || true
  systemctl enable vnstat >/dev/null 2>&1
  systemctl start vnstat
  _ok "vnstat ready on $net_interface"
else
  _warn "Network interface not detected, skipping vnstat"
fi

# â”€â”€ Helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
_hdr "[ 6/9 ] Downloading helper scripts..."
_progress "zivpn_helper.sh"
wget -q -O /usr/local/bin/zivpn_helper.sh \
  https://raw.githubusercontent.com/AutoNV/udpzivpn/main/zivpn_helper.sh
chmod +x /usr/local/bin/zivpn_helper.sh
_ok "zivpn_helper.sh"

_progress "Clearing default passwords"
jq '.auth.config = []' /etc/zivpn/config.json > /etc/zivpn/config.json.tmp \
  && mv /etc/zivpn/config.json.tmp /etc/zivpn/config.json
touch /etc/zivpn/users.db
RANDOM_PASS="zivpn$(shuf -i 10000-99999 -n 1)"
_ok "Default passwords cleared"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# â”€â”€ Domain Input + SSL acme.sh â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
_hdr "[ 7/9 ] Setup Domain & SSL..."

# Ambil IP server
local server_ip
server_ip=$(cat /etc/zivpn/ip.txt 2>/dev/null)
if [ -z "$server_ip" ]; then
  server_ip=$(curl -s https://api.ipify.org 2>/dev/null)
  echo "$server_ip" > /etc/zivpn/ip.txt
fi

# Minta user input domain
local full_domain
full_domain=$(ask_domain_input)

if [ -n "$full_domain" ]; then
  _ok "Domain: ${full_domain}"

  # Install acme.sh
  install_acme_sh

  # Issue SSL
  issue_ssl_acme "$full_domain"

  # Setup nginx
  setup_nginx_ssl_proxy "$full_domain"

  _ok "HTTPS API aktif: https://${full_domain}"
else
  _warn "Domain tidak diset, menggunakan self-signed cert"
  openssl req -x509 -newkey rsa:4096 -days 365 -nodes \
    -subj "/C=US/ST=Jakarta/L=Jakarta/O=NexusDev/OU=VPN/CN=zivpn" \
    -keyout "/etc/zivpn/zivpn.key" -out "/etc/zivpn/zivpn.crt" 2>/dev/null
  chmod 600 /etc/zivpn/zivpn.key
  full_domain="$server_ip"
fi

# â”€â”€ API Setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
_hdr "[ 8/9 ] Setting up REST API..."

_progress "Node.js check"
if ! command -v node &>/dev/null; then
  curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash - >/dev/null 2>&1
  apt-get install -y nodejs >/dev/null 2>&1
fi
_ok "Node.js ready"

mkdir -p /etc/zivpn/api
cat <<'EOF' > /etc/zivpn/api/package.json
{
"name": "zivpn-api",
"version": "1.0.0",
"description": "API for managing ZIVPN",
"main": "api.js",
"scripts": { "start": "node api.js" },
"dependencies": { "express": "^4.17.1" }
}
EOF

cat <<'EOF' > /etc/zivpn/api/api.js
const express = require('express');
const { execFile } = require('child_process');
const fs = require('fs');
const app = express();
const PORT = 5888;
const AUTH_KEY_PATH = '/etc/zivpn/api_auth.key';
const ZIVPN_MANAGER_SCRIPT = '/usr/local/bin/zivpn-manager';
const authenticate = (req, res, next) => {
const providedAuthKey = req.query.auth;
if (!providedAuthKey) return res.status(401).json({ status: 'error', message: 'Authentication key is required.' });
fs.readFile(AUTH_KEY_PATH, 'utf8', (err, storedKey) => {
if (err) return res.status(500).json({ status: 'error', message: 'Could not read authentication key.' });
if (providedAuthKey.trim() !== storedKey.trim()) return res.status(403).json({ status: 'error', message: 'Invalid authentication key.' });
next();
});
};
app.use(authenticate);
const executeZivpnManager = (command, args, res) => {
execFile('/bin/bash', [ZIVPN_MANAGER_SCRIPT, command, ...args], (error, stdout, stderr) => {
if (error) {
const errorMessage = stderr || stdout || 'An internal server error occurred.';
return res.status(500).json({ status: 'error', message: errorMessage.trim() });
}
if (stdout.toLowerCase().includes('success')) {
res.json({ status: 'success', message: stdout.trim() });
} else {
res.status(400).json({ status: 'error', message: stdout.trim() });
}
});
};
app.all('/create/zivpn', (req, res) => {
const { password, exp } = req.query;
if (!password || !exp) return res.status(400).json({ status: 'error', message: 'Parameters password and exp are required.' });
executeZivpnManager('create_account', [password, exp], res);
});
app.all('/delete/zivpn', (req, res) => {
const { password } = req.query;
if (!password) return res.status(400).json({ status: 'error', message: 'Parameter password is required.' });
executeZivpnManager('delete_account', [password], res);
});
app.all('/renew/zivpn', (req, res) => {
const { password, exp } = req.query;
if (!password || !exp) return res.status(400).json({ status: 'error', message: 'Parameters password and exp are required.' });
executeZivpnManager('renew_account', [password, exp], res);
});
app.all('/trial/zivpn', (req, res) => {
const { exp } = req.query;
if (!exp) return res.status(400).json({ status: 'error', message: 'Parameter exp is required.' });
executeZivpnManager('trial_account', [exp], res);
});
app.listen(PORT, '127.0.0.1', () => console.log('ZIVPN API server running on 127.0.0.1:' + PORT));
EOF

_progress "npm install"
npm install --prefix /etc/zivpn/api >/dev/null 2>&1
_ok "API dependencies installed"

cat <<'EOF' > /etc/systemd/system/zivpn-api.service
[Unit]
Description=ZIVPN REST API Service
After=network.target
[Service]
Type=simple
User=root
WorkingDirectory=/etc/zivpn/api
ExecStart=/usr/bin/node /etc/zivpn/api/api.js
Restart=on-failure
[Install]
WantedBy=multi-user.target
EOF
systemctl daemon-reload
systemctl enable zivpn-api.service >/dev/null 2>&1
systemctl start zivpn-api.service

_progress "API key setup"
if [ ! -f /etc/zivpn/api_auth.key ]; then
  local initial_api_key
  initial_api_key=$(LC_ALL=C tr -dc 'a-zA-Z0-9' < /dev/urandom | head -c 6)
  echo "$initial_api_key" > /etc/zivpn/api_auth.key
  chmod 600 /etc/zivpn/api_auth.key
fi
local api_key_display
api_key_display=$(cat /etc/zivpn/api_auth.key)
_ok "API key: ${api_key_display}"

# API sekarang via HTTPS (nginx proxy)
_progress "Port 5888 (internal only)"
iptables -I INPUT -p tcp --dport 5888 -s 127.0.0.1 -j ACCEPT
iptables -I INPUT -p tcp --dport 5888 -j DROP  # Block akses langsung dari luar
_ok "Port 5888 dibatasi hanya localhost"

# â”€â”€ Cron, license checker, dll â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
_hdr "[ 9/9 ] Finalizing..."

_progress "License checker cron"
cat > /etc/zivpn/license_checker.sh << 'LCEOF'
#!/bin/bash
LICENSE_URL="https://raw.githubusercontent.com/AutoNV/udpzivpn/main/ip2"
LICENSE_INFO_FILE="/etc/zivpn/.license_info"
EXPIRED_LOCK_FILE="/etc/zivpn/.expired"
log() { echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> /var/log/zivpn_license.log; }
if [ ! -f "$LICENSE_INFO_FILE" ]; then log "License info file not found."; exit 1; fi
source "$LICENSE_INFO_FILE"
if [ -z "$CLIENT_NAME" ] || [ -z "$EXPIRY_DATE" ]; then log "License info incomplete."; exit 1; fi
SERVER_IP=$(cat /etc/zivpn/ip.txt 2>/dev/null)
if [ -z "$SERVER_IP" ]; then log "Could not read server IP."; exit 1; fi
license_data=$(curl -s "$LICENSE_URL")
if [ $? -ne 0 ] || [ -z "$license_data" ]; then log "Could not reach license server."; exit 0; fi
license_entry=$(echo "$license_data" | grep -w "$SERVER_IP")
if [ -z "$license_entry" ]; then log "IP not found in license list."; exit 1; fi
client_name_remote=$(echo "$license_entry" | awk '{print $1}')
expiry_date_remote=$(echo "$license_entry" | awk '{print $2}')
expiry_timestamp_remote=$(date -d "$expiry_date_remote" +%s)
current_timestamp=$(date +%s)
if [ "$expiry_date_remote" != "$EXPIRY_DATE" ]; then
  echo "CLIENT_NAME=${client_name_remote}" > "$LICENSE_INFO_FILE"
  echo "EXPIRY_DATE=${expiry_date_remote}" >> "$LICENSE_INFO_FILE"
fi
if [ "$expiry_timestamp_remote" -le "$current_timestamp" ]; then
  if [ ! -f "$EXPIRED_LOCK_FILE" ]; then
    systemctl stop zivpn.service
    touch "$EXPIRED_LOCK_FILE"
  fi
else
  if [ -f "$EXPIRED_LOCK_FILE" ]; then
    rm "$EXPIRED_LOCK_FILE"
    systemctl start zivpn.service
  fi
fi
exit 0
LCEOF
chmod +x /etc/zivpn/license_checker.sh
(crontab -l 2>/dev/null | grep -v "# zivpn-license-check") | crontab -
(crontab -l 2>/dev/null; echo "*/5 * * * * /etc/zivpn/license_checker.sh # zivpn-license-check") | crontab -
_ok "License checker cron set"

_progress "Expiry check cron"
cat <<'EOF' > /etc/zivpn/expire_check.sh
DB_FILE="/etc/zivpn/users.db"
CONFIG_FILE="/etc/zivpn/config.json"
TMP_DB_FILE="${DB_FILE}.tmp"
CURRENT_DATE=$(date +%s)
SERVICE_RESTART_NEEDED=false
if [ ! -f "$DB_FILE" ]; then exit 0; fi
> "$TMP_DB_FILE"
while IFS=':' read -r password expiry_date; do
if [[ -z "$password" ]]; then continue; fi
if [ "$expiry_date" -le "$CURRENT_DATE" ]; then
jq --arg pass "$password" 'del(.auth.config[] | select(. == $pass))' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
SERVICE_RESTART_NEEDED=true
else
echo "${password}:${expiry_date}" >> "$TMP_DB_FILE"
fi
done < "$DB_FILE"
mv "$TMP_DB_FILE" "$DB_FILE"
if [ "$SERVICE_RESTART_NEEDED" = true ]; then
systemctl restart zivpn.service
fi
exit 0
EOF
chmod +x /etc/zivpn/expire_check.sh
(crontab -l 2>/dev/null | grep -v "# zivpn-expiry-check") | crontab -
(crontab -l 2>/dev/null; echo "* * * * * /etc/zivpn/expire_check.sh # zivpn-expiry-check") | crontab -
_ok "Expiry check cron set"

_progress "Auto update & watchdog"
(crontab -l 2>/dev/null | grep -v "# zivpn-auto-update") | crontab -
(crontab -l 2>/dev/null; echo "0 4 * * * /usr/local/bin/update-manager # zivpn-auto-update") | crontab -
(crontab -l 2>/dev/null | grep -v "# zivpn-auto-start") | crontab -
(crontab -l 2>/dev/null; echo "*/2 * * * * systemctl is-active --quiet zivpn || systemctl start zivpn # zivpn-auto-start") | crontab -
_ok "Auto update & watchdog enabled"

_progress "Installing zivpn-manager"
cp "$0" /usr/local/bin/zivpn-manager
chmod +x /usr/local/bin/zivpn-manager
_ok "zivpn-manager installed"

# â”€â”€ Akun awal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
EXPIRY_DATE_INIT=$(date -d "+1 day" +%s)
echo "${RANDOM_PASS}:${EXPIRY_DATE_INIT}" >> /etc/zivpn/users.db
jq --arg pass "$RANDOM_PASS" '.auth.config += [$pass]' /etc/zivpn/config.json > /etc/zivpn/config.json.tmp && mv /etc/zivpn/config.json.tmp /etc/zivpn/config.json

# â”€â”€ Profile â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
rm -rf /root/.profile
cat <<EOF > /root/.profile
if [ "\$BASH" ]; then
if [ -f ~/.bashrc ]; then
. ~/.bashrc
fi
fi
mesg n || true
ln -fs /usr/share/zoneinfo/Asia/Jakarta /etc/localtime
menu
EOF
PROFILE_FILE="/root/.bashrc"
[ -f "/root/.bash_profile" ] && PROFILE_FILE="/root/.bash_profile"
ALIAS_CMD="alias menu='/usr/local/bin/zivpn-manager'"
AUTORUN_CMD="/usr/local/bin/zivpn-manager"
grep -qF "$ALIAS_CMD" "$PROFILE_FILE" || echo "$ALIAS_CMD" >> "$PROFILE_FILE"
grep -qF "$AUTORUN_CMD" "$PROFILE_FILE" || echo "$AUTORUN_CMD" >> "$PROFILE_FILE"
_ok "Mode: ZIVPN Only aktif"

echo ""
_sep
echo -e "${_G}  âœ”  Installation completed successfully!${NC}"
_sep
echo ""

# â”€â”€ Tampilkan ringkasan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
local final_domain
final_domain=$(get_active_domain)
local final_api_base
final_api_base=$(get_api_base_url)
local final_api_key
final_api_key=$(cat /etc/zivpn/api_auth.key 2>/dev/null || echo "N/A")

echo -e "${_C}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${_C}â•‘${_W}          RINGKASAN INSTALASI ZIVPN            ${_C}â•‘${NC}"
echo -e "${_C}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${NC}"
echo -e "${_C}â•‘${_W} Domain  : ${_G}${final_domain}${NC}"
echo -e "${_C}â•‘${_W} IP      : ${_G}${server_ip}${NC}"
echo -e "${_C}â•‘${_W} API KEY : ${_G}${final_api_key}${NC}"
echo -e "${_C}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${NC}"
echo -e "${_C}â•‘${_W} Contoh URL API:${NC}"
echo -e "${_C}â•‘${_G} ${final_api_base}/trial/zivpn?exp=60&auth=${final_api_key}${NC}"
echo -e "${_C}â•‘${_G} ${final_api_base}/create/zivpn?password=PASS&exp=30&auth=${final_api_key}${NC}"
echo -e "${_C}â•‘${_G} ${final_api_base}/renew/zivpn?password=PASS&exp=30&auth=${final_api_key}${NC}"
echo -e "${_C}â•‘${_G} ${final_api_base}/delete/zivpn?password=PASS&auth=${final_api_key}${NC}"
echo -e "${_C}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""
sleep 2
show_menu
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  MAIN
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function main() {
if [ "$#" -gt 0 ]; then
local command="$1"
shift
case "$command" in
create_account)
_create_account_logic "$@"
;;
delete_account)
_delete_account_logic "$@"
;;
renew_account)
_renew_account_logic "$@"
;;
trial_account)
_create_trial_account_logic "$@"
;;
*)
echo "Error: Unknown command '$command'"
exit 1
;;
esac
exit $?
fi
if [ ! -f "/etc/systemd/system/zivpn.service" ]; then
run_setup
fi
while true; do
show_menu
done
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
main "$@"
fi

#!/bin/bash

YELLOW='\033[1;37m'
RED='\033[0;31m'
LIGHT_BLUE='\033[0;37m'
BOLD_WHITE='\033[1;37m'
CYAN='\033[0;37m'
GREEN='\033[0;32m'
LIGHT_GREEN='\033[1;32m'
PURPLE='\033[0;37m'
BOLD_CYAN='\033[1;37m'
NC='\033[0m'

# ── Animasi progress bar ──────────────────────────
_C='\033[0;36m'
_G='\033[1;32m'
_W='\033[1;37m'
_Y='\033[1;33m'
_R='\033[0;31m'

_progress() {
  local label="$1"
  local width=28
  local i bar filled empty
  for ((i=0; i<=100; i++)); do
    filled=$(( i * width / 100 ))
    empty=$(( width - filled ))
    bar=""
    for ((j=0; j<filled; j++)); do bar+="█"; done
    for ((j=0; j<empty; j++)); do bar+="░"; done
    printf "\r${_W}  %-22s ${_C}[${_G}%s${_C}]${_W} %3d%% ${NC}" "$label" "$bar" "$i"
    sleep 0.015
  done
  printf "\r${_W}  %-22s ${_C}[${_G}%s${_C}]${_W} %3d%% ${NC}\n" "$label" "$bar" "100"
}

_ok()   { printf "  ${_G}✔  %s${NC}\n"  "$1"; }
_warn() { printf "  ${_Y}⚠  %s${NC}\n"  "$1"; }
_err()  { printf "  ${_R}✘  %s${NC}\n"  "$1"; }
_sep()  { echo -e "${_C}--------------------------------------------${NC}"; }
_hdr()  { _sep; echo -e "${_W}  $1${NC}"; _sep; }

LICENSE_URL="https://raw.githubusercontent.com/AutoNV/udpzivpn/main/ip2"
LICENSE_INFO_FILE="/etc/zivpn/.license_info"
CONFIG_DIR="/etc/zivpn"
TELEGRAM_CONF="${CONFIG_DIR}/telegram.conf"

# ── Cloudflare credentials (hardcoded) ───────────
CF_EMAIL="ayfa7756@gmail.com"
CF_API_KEY="89df648f7990d6d807d6c9ed7dd265d9d4300"
CF_ZONE_ID="beb2618f7705d1b38b2d580ae033a233"
CF_BASE_DOMAIN="nexusdev.web.id"

function _cf_get_server_ip() {
  curl -s https://api.ipify.org 2>/dev/null || curl -s https://ifconfig.me
}

function _cf_create_dns() {
  local subdomain="$1"
  local server_ip="$2"
  local full_domain="${subdomain}.${CF_BASE_DOMAIN}"
  # Delete existing record if any
  local existing_id
  existing_id=$(curl -s -X GET \
    "https://api.cloudflare.com/client/v4/zones/${CF_ZONE_ID}/dns_records?type=A&name=${full_domain}" \
    -H "X-Auth-Email: ${CF_EMAIL}" \
    -H "X-Auth-Key: ${CF_API_KEY}" \
    -H "Content-Type: application/json" | \
    python3 -c "import sys,json; d=json.load(sys.stdin); print(d['result'][0]['id'] if d.get('result') else '')" 2>/dev/null)
  if [ -n "$existing_id" ]; then
    curl -s -X DELETE \
      "https://api.cloudflare.com/client/v4/zones/${CF_ZONE_ID}/dns_records/${existing_id}" \
      -H "X-Auth-Email: ${CF_EMAIL}" \
      -H "X-Auth-Key: ${CF_API_KEY}" \
      -H "Content-Type: application/json" >/dev/null
  fi
  # Create A record
  local result
  result=$(curl -s -X POST \
    "https://api.cloudflare.com/client/v4/zones/${CF_ZONE_ID}/dns_records" \
    -H "X-Auth-Email: ${CF_EMAIL}" \
    -H "X-Auth-Key: ${CF_API_KEY}" \
    -H "Content-Type: application/json" \
    --data "{\"type\":\"A\",\"name\":\"${full_domain}\",\"content\":\"${server_ip}\",\"ttl\":120,\"proxied\":false}")
  echo "$result" | python3 -c "import sys,json; d=json.load(sys.stdin); print('ok' if d.get('success') else 'fail')" 2>/dev/null
}

function setup_cloudflare_ssl() {
  _hdr "[ SSL ] Cloudflare DNS & Let's Encrypt SSL Setup"
  local server_ip
  server_ip=$(_cf_get_server_ip)
  echo -e "${_W}  IP Server terdeteksi: ${_G}${server_ip}${NC}"
  echo ""
  echo -e "${_W}  Domain akan dibuat sebagai subdomain dari: ${_G}${CF_BASE_DOMAIN}${NC}"
  echo -e "${_W}  Contoh: ketik 'vps1' → domain menjadi: vps1.${CF_BASE_DOMAIN}${NC}"
  echo ""
  local subdomain
  while true; do
    read -p "  Masukkan subdomain (huruf/angka/tanda-hubung): " subdomain
    subdomain=$(echo "$subdomain" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]//g')
    if [ -z "$subdomain" ]; then
      echo -e "${_R}  Subdomain tidak boleh kosong, coba lagi.${NC}"
    else
      break
    fi
  done

  local full_domain="${subdomain}.${CF_BASE_DOMAIN}"
  echo ""
  _progress "Pointing DNS $full_domain → $server_ip"
  local cf_result
  cf_result=$(_cf_create_dns "$subdomain" "$server_ip")
  if [ "$cf_result" == "ok" ]; then
    _ok "DNS record berhasil: $full_domain → $server_ip"
  else
    _warn "Gagal membuat DNS Cloudflare. Menggunakan self-signed sebagai fallback."
    echo "$full_domain" > /etc/zivpn/domain.txt
    openssl req -new -newkey rsa:4096 -days 365 -nodes -x509 \
      -subj "/C=US/ST=California/L=Los Angeles/O=Example Corp/OU=IT Department/CN=${full_domain}" \
      -keyout "/etc/zivpn/zivpn.key" -out "/etc/zivpn/zivpn.crt" >/dev/null 2>&1
    return
  fi

  _progress "Menunggu propagasi DNS (60 detik)"
  sleep 60

  _progress "Installing certbot"
  apt install -y certbot >/dev/null 2>&1
  _ok "certbot ready"

  _progress "Menerbitkan SSL dari Let's Encrypt untuk $full_domain"
  certbot certonly --standalone --non-interactive --agree-tos \
    --email "${CF_EMAIL}" \
    -d "${full_domain}" \
    --http-01-port 80 \
    >/dev/null 2>&1
  local cert_status=$?
  if [ $cert_status -eq 0 ]; then
    _ok "SSL certificate berhasil untuk $full_domain"
    cp "/etc/letsencrypt/live/${full_domain}/fullchain.pem" /etc/zivpn/zivpn.crt
    cp "/etc/letsencrypt/live/${full_domain}/privkey.pem"   /etc/zivpn/zivpn.key
    _ok "Certificate disalin ke /etc/zivpn/"
    # Auto-renew cron
    (crontab -l 2>/dev/null | grep -v "# zivpn-ssl-renew") | crontab -
    (crontab -l 2>/dev/null; echo "0 3 * * * certbot renew --quiet && cp /etc/letsencrypt/live/${full_domain}/fullchain.pem /etc/zivpn/zivpn.crt && cp /etc/letsencrypt/live/${full_domain}/privkey.pem /etc/zivpn/zivpn.key && systemctl restart zivpn zivpn-api 2>/dev/null # zivpn-ssl-renew") | crontab -
    _ok "Auto-renew SSL cron set"
  else
    _warn "Let's Encrypt gagal. Menggunakan self-signed cert sebagai fallback."
    openssl req -new -newkey rsa:4096 -days 365 -nodes -x509 \
      -subj "/C=US/ST=California/L=Los Angeles/O=Example Corp/OU=IT Department/CN=${full_domain}" \
      -keyout "/etc/zivpn/zivpn.key" -out "/etc/zivpn/zivpn.crt" >/dev/null 2>&1
  fi

  echo "$full_domain" > /etc/zivpn/domain.txt
  echo "$server_ip"   > /etc/zivpn/ip.txt
  _ok "Domain disimpan: $full_domain"
}

if [ "$(id -u)" -ne 0 ]; then
echo "This script must be run as root. Please use sudo or run as root user." >&2
exit 1
fi

function send_telegram_notification() {
local message="$1"
local keyboard="$2"
if [ ! -f "$TELEGRAM_CONF" ]; then
return 1
fi
source "$TELEGRAM_CONF"
if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
local api_url="https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage"
if [ -n "$keyboard" ]; then
curl -s -X POST "$api_url" -d "chat_id=${TELEGRAM_CHAT_ID}" --data-urlencode "text=${message}" -d "reply_markup=${keyboard}" > /dev/null
else
curl -s -X POST "$api_url" -d "chat_id=${TELEGRAM_CHAT_ID}" --data-urlencode "text=${message}" -d "parse_mode=Markdown" > /dev/null
fi
fi
}

function verify_license() {
echo "Verifying installation license..."
local SERVER_IP
SERVER_IP=$(cat /etc/zivpn/ip.txt)
if [ -z "$SERVER_IP" ]; then
echo -e "${RED}Failed to retrieve server IP. Please check your internet connection.${NC}"
exit 1
fi
local license_data
license_data=$(curl -s "$LICENSE_URL")
if [ $? -ne 0 ] || [ -z "$license_data" ]; then
echo -e "${RED}Gagal terhubung ke server lisensi. Mohon periksa koneksi internet Anda.${NC}"
exit 1
fi
local license_entry
license_entry=$(echo "$license_data" | grep -w "$SERVER_IP")
if [ -z "$license_entry" ]; then
echo -e "${RED}Verifikasi Lisensi Gagal! IP Anda tidak terdaftar. IP: ${SERVER_IP}${NC}"
exit 1
fi
local client_name
local expiry_date_str
client_name=$(echo "$license_entry" | awk '{print $1}')
expiry_date_str=$(echo "$license_entry" | awk '{print $2}')
local expiry_timestamp
expiry_timestamp=$(date -d "$expiry_date_str" +%s)
local current_timestamp
current_timestamp=$(date +%s)
if [ "$expiry_timestamp" -le "$current_timestamp" ]; then
echo -e "${RED}Verifikasi Lisensi Gagal! Lisensi untuk IP ${SERVER_IP} telah kedaluwarsa. Tanggal Kedaluwarsa: ${expiry_date_str}${NC}"
exit 1
fi
echo -e "${LIGHT_GREEN}Verifikasi Lisensi Berhasil! Client: ${client_name}, IP: ${SERVER_IP}${NC}"
sleep 2
mkdir -p /etc/zivpn
echo "CLIENT_NAME=${client_name}" > "$LICENSE_INFO_FILE"
echo "EXPIRY_DATE=${expiry_date_str}" >> "$LICENSE_INFO_FILE"
}

update_expiry_from_license_url() {
echo "Syncing expiry license..."
local SERVER_IP
SERVER_IP=$(cat /etc/zivpn/ip.txt)
if [ -z "$SERVER_IP" ]; then
echo -e "${RED}Gagal mendapatkan IP server${NC}"
return 1
fi
local license_data
license_data=$(curl -s "$LICENSE_URL")
if [ $? -ne 0 ] || [ -z "$license_data" ]; then
echo -e "${RED}Gagal mengambil data lisensi${NC}"
return 1
fi
local license_entry
license_entry=$(echo "$license_data" | grep -w "$SERVER_IP")
if [ -z "$license_entry" ]; then
echo -e "${RED}IP tidak terdaftar di lisensi${NC}"
return 1
fi
local CLIENT_NAME NEW_EXP_FROM_SERVER
CLIENT_NAME=$(echo "$license_entry" | awk '{print $1}')
NEW_EXP_FROM_SERVER=$(echo "$license_entry" | awk '{print $2}')
if ! date -d "$NEW_EXP_FROM_SERVER" >/dev/null 2>&1; then
echo -e "${RED}Format tanggal EXP dari server tidak valid${NC}"
return 1
fi
mkdir -p "$CONFIG_DIR"
cat > "$LICENSE_INFO_FILE" <<EOF
CLIENT_NAME=${CLIENT_NAME}
EXPIRY_DATE=${NEW_EXP_FROM_SERVER}
EOF
echo -e "${LIGHT_GREEN}Sinkronisasi lisensi berhasil!${NC}"
echo -e "Client  : ${CLIENT_NAME}"
echo -e "Expiry  : ${NEW_EXP_FROM_SERVER}"
}

function restart_zivpn() {
systemctl restart zivpn.service --no-block
}

function _create_account_logic() {
local password="$1"
local days="$2"
local db_file="/etc/zivpn/users.db"
if [ -z "$password" ] || [ -z "$days" ]; then
echo "Error: Password and days are required."
return 1
fi
if ! [[ "$days" =~ ^[0-9]+$ ]]; then
echo "Error: Invalid number of days."
return 1
fi
if grep -q "^${password}:" "$db_file"; then
echo "Error: Password '${password}' already exists."
return 1
fi
local expiry_date
expiry_date=$(date -d "+$days days" +%s)
echo "${password}:${expiry_date}" >> "$db_file"
jq --arg pass "$password" '.auth.config += [$pass]' /etc/zivpn/config.json > /etc/zivpn/config.json.tmp && mv /etc/zivpn/config.json.tmp /etc/zivpn/config.json
if [ $? -eq 0 ]; then
restart_zivpn
local EXPIRE_FORMATTED
EXPIRE_FORMATTED=$(date -d "@$expiry_date" +"%d %B %Y %H:%M")
ip=$(cat /etc/zivpn/ip.txt)
isp=$(cat /etc/zivpn/isp.txt)
CERT_CN=$(openssl x509 -in /etc/zivpn/zivpn.crt -noout -subject | sed -n 's/.*CN = \([^,]*\).*/\1/p')
local host
if [ "$CERT_CN" == "zivpn" ]; then
host=$(cat /etc/zivpn/ip.txt)
else
host=$CERT_CN
fi
clear
echo "Success:"
echo "CREATE AKUN ZIVPN"
echo "┌────────────────────────┐"
echo "│ Host   : $host"
echo "│ IP     : $ip"
echo "│ ISP    : $isp"
echo "│ Pass   : $password"
echo "│ Expire : $EXPIRE_FORMATTED"
echo "└────────────────────────┘"
echo "Terima kasih telah menggunakan layanan kami"
local message=$(cat <<EOF
CREATE AKUN ZIVPN
┌────────────────────────┐
│ Host   : $host
│ IP     : $ip
│ ISP    : $isp
│ Pass   : $password
│ Expire : $EXPIRE_FORMATTED
└────────────────────────┘
Terima kasih telah menggunakan layanan kami
EOF
)
send_telegram_notification "$message"
return 0
else
sed -i "/^${password}:/d" "$db_file"
echo "Error: Failed to update config.json."
return 1
fi
}

function create_manual_account() {
echo "───────── Create New Zivpn Account ───────"
read -p "Enter new password: " password
if [ -z "$password" ]; then
echo "Password cannot be empty."
return
fi
read -p "Enter active period (in days): " days
if ! [[ "$days" =~ ^[0-9]+$ ]]; then
echo "Invalid number of days."
return
fi
local result
result=$(_create_account_logic "$password" "$days")
if [[ "$result" == "Success"* ]]; then
local db_file="/etc/zivpn/users.db"
local user_line
user_line=$(grep "^${password}:" "$db_file")
if [ -n "$user_line" ]; then
local expiry_date
expiry_date=$(echo "$user_line" | cut -d: -f2)
local CERT_CN
CERT_CN=$(openssl x509 -in /etc/zivpn/zivpn.crt -noout -subject | sed -n 's/.*CN = \([^,]*\).*/\1/p')
local HOST
if [ "$CERT_CN" == "zivpn" ]; then
HOST=$(cat /etc/zivpn/ip.txt)
else
HOST=$CERT_CN
fi
local EXPIRE_FORMATTED
EXPIRE_FORMATTED=$(date -d "@$expiry_date" +"%d %B %Y %H:%M")
fi
else
echo "$result"
fi
read -p "Tekan Enter untuk kembali ke menu..."
}

function _generate_api_key() {
clear
echo "─── Generate API Authentication Key ───"
local api_key
api_key=$(LC_ALL=C tr -dc 'a-zA-Z0-9' < /dev/urandom | head -c 6)
local key_file="/etc/zivpn/api_auth.key"
echo "$api_key" > "$key_file"
chmod 600 "$key_file"
echo "New API authentication key has been generated and saved."
echo "Key: ${api_key}"
echo "Sending API key to Telegram..."
local server_ip
server_ip=$(cat /etc/zivpn/ip.txt)
local domain
if [ -f /etc/zivpn/domain.txt ]; then
  domain=$(cat /etc/zivpn/domain.txt)
else
  local cert_cn
  cert_cn=$(openssl x509 -in /etc/zivpn/zivpn.crt -noout -subject | sed -n 's/.*CN = \([^,]*\).*/\1/p' 2>/dev/null || echo "")
  if [ "$cert_cn" == "zivpn" ] || [ -z "$cert_cn" ]; then
    domain=$server_ip
  else
    domain=$cert_cn
  fi
fi
echo ""
echo "API Base URL: https://${domain}/"
echo "Contoh: https://${domain}/create/zivpn?auth=${api_key}&password=USER&exp=30"
echo ""
/usr/local/bin/zivpn_helper.sh api-key-notification "$api_key" "$server_ip" "$domain"
read -p "Tekan Enter untuk kembali ke menu..."
}

function _lihat_api_key() {
clear
echo "─── Lihat API Authentication Key ───"
local key_file="/etc/zivpn/api_auth.key"
if [ ! -f "$key_file" ]; then
echo "API key belum dibuat!"
echo "Silakan generate API key terlebih dahulu."
read -p "Tekan Enter untuk kembali..."
return
fi
local api_key
api_key=$(cat "$key_file")
echo ""
echo "API Authentication Key:"
echo "-----------------------"
echo "Key: ${api_key}"
echo ""
echo "Lokasi file: $key_file"
echo "Permission : $(stat -c %a "$key_file")"
echo ""
read -p "Tekan Enter untuk kembali ke menu..."
}

function _create_trial_account_logic() {
local minutes="$1"
local db_file="/etc/zivpn/users.db"
if ! [[ "$minutes" =~ ^[0-9]+$ ]]; then
echo "Error: Invalid number of minutes."
return 1
fi
local password="trial$(shuf -i 10000-99999 -n 1)"
local expiry_date
expiry_date=$(date -d "+$minutes minutes" +%s)
echo "${password}:${expiry_date}" >> "$db_file"
jq --arg pass "$password" '.auth.config += [$pass]' /etc/zivpn/config.json > /etc/zivpn/config.json.tmp && mv /etc/zivpn/config.json.tmp /etc/zivpn/config.json
if [ $? -eq 0 ]; then
restart_zivpn
local EXPIRE_FORMATTED
EXPIRE_FORMATTED=$(date -d "@$expiry_date" +"%d %B %Y %H:%M")
ip=$(cat /etc/zivpn/ip.txt)
isp=$(cat /etc/zivpn/isp.txt)
CERT_CN=$(openssl x509 -in /etc/zivpn/zivpn.crt -noout -subject | sed -n 's/.*CN = \([^,]*\).*/\1/p')
local host
if [ "$CERT_CN" == "zivpn" ]; then
host=$(cat /etc/zivpn/ip.txt)
else
host=$CERT_CN
fi
clear
echo "Success:"
echo "TRIAL AKUN ZIVPN"
echo "┌────────────────────────┐"
echo "│ Host   : $host"
echo "│ IP     : $ip"
echo "│ ISP    : $isp"
echo "│ Pass   : $password"
echo "│ Expire : $EXPIRE_FORMATTED"
echo "└────────────────────────┘"
echo "Terima kasih telah menggunakan layanan kami"
local message=$(cat <<EOF
TRIAL AKUN ZIVPN
┌────────────────────────┐
│ Host   : $host
│ IP     : $ip
│ ISP    : $isp
│ Pass   : $password
│ Expire : $EXPIRE_FORMATTED
└────────────────────────┘
Terima kasih telah mencoba layanan kami
EOF
)
send_telegram_notification "$message"
return 0
else
sed -i "/^${password}:/d" "$db_file"
echo "Error: Failed to update config.json."
return 1
fi
}

function create_trial_account() {
echo "─────── Create Trial Zivpn Account ───────"
read -p "Enter active period (in minutes): " minutes
if ! [[ "$minutes" =~ ^[0-9]+$ ]]; then
echo "Invalid number of minutes."
return
fi
local result
result=$(_create_trial_account_logic "$minutes")
if [[ "$result" == "Success"* ]]; then
local password
password=$(echo "$result" | sed -n "s/Success: Trial account '\([^']*\)'.*/\1/p")
local db_file="/etc/zivpn/users.db"
local user_line
user_line=$(grep "^${password}:" "$db_file")
if [ -n "$user_line" ]; then
local expiry_date
expiry_date=$(echo "$user_line" | cut -d: -f2)
local CERT_CN
CERT_CN=$(openssl x509 -in /etc/zivpn/zivpn.crt -noout -subject | sed -n 's/.*CN = \([^,]*\).*/\1/p')
local HOST
if [ "$CERT_CN" == "zivpn" ]; then
HOST=$(cat /etc/zivpn/ip.txt)
else
HOST=$CERT_CN
fi
local EXPIRE_FORMATTED
EXPIRE_FORMATTED=$(date -d "@$expiry_date" +"%d %B %Y %H:%M:%S")
fi
else
echo "$result"
fi
read -p "Tekan Enter untuk kembali ke menu..."
}

function _renew_account_logic() {
local password="$1"
local days="$2"
local db_file="/etc/zivpn/users.db"
if [ -z "$password" ] || [ -z "$days" ]; then
echo "Error: Password and days are required."
return 1
fi
if ! [[ "$days" =~ ^[1-9][0-9]*$ ]]; then
echo "Error: Invalid number of days."
return 1
fi
local user_line
user_line=$(grep "^${password}:" "$db_file")
if [ -z "$user_line" ]; then
echo "Error: Account '${password}' not found."
return 1
fi
local current_expiry_date
current_expiry_date=$(echo "$user_line" | cut -d: -f2)
if ! [[ "$current_expiry_date" =~ ^[0-9]+$ ]]; then
echo "Error: Corrupted database entry for user '$password'."
return 1
fi
local seconds_to_add=$((days * 86400))
local new_expiry_date=$((current_expiry_date + seconds_to_add))
sed -i "s/^${password}:.*/${password}:${new_expiry_date}/" "$db_file"
local new_expiry_formatted
new_expiry_formatted=$(date -d "@$new_expiry_date" +"%d %B %Y %H:%M")
ip=$(cat /etc/zivpn/ip.txt)
isp=$(cat /etc/zivpn/isp.txt)
CERT_CN=$(openssl x509 -in /etc/zivpn/zivpn.crt -noout -subject | sed -n 's/.*CN = \([^,]*\).*/\1/p')
local host
if [ "$CERT_CN" == "zivpn" ]; then
host=$(cat /etc/zivpn/ip.txt)
else
host=$CERT_CN
fi
clear
echo "Success:"
echo "RENEW AKUN ZIVPN"
echo "┌────────────────────────┐"
echo "│ Host   : $host"
echo "│ IP     : $ip"
echo "│ ISP    : $isp"
echo "│ Pass   : $password"
echo "│ Expire : $new_expiry_formatted"
echo "└────────────────────────┘"
echo "Terima kasih telah menggunakan layanan kami"
local message=$(cat <<EOF
RENEW AKUN ZIVPN
┌────────────────────────┐
│ Host   : $host
│ IP     : $ip
│ ISP    : $isp
│ Pass   : $password
│ Expire : $new_expiry_formatted
└────────────────────────┘
Terima kasih telah menggunakan layanan kami
EOF
)
send_telegram_notification "$message"
return 0
}

function renew_account() {
clear
echo "───────────── Renew Account ──────────────"
_display_accounts
echo ""
read -p "Enter password to renew: " password
if [ -z "$password" ]; then
echo "Password cannot be empty."
return
fi
read -p "Enter number of days to extend: " days
if ! [[ "$days" =~ ^[1-9][0-9]*$ ]]; then
echo "Invalid number of days. Please enter a positive number."
return
fi
local result
result=$(_renew_account_logic "$password" "$days")
if [[ "$result" == "Success"* ]]; then
local db_file="/etc/zivpn/users.db"
local user_line
user_line=$(grep "^${password}:" "$db_file")
local new_expiry_date
new_expiry_date=$(echo "$user_line" | cut -d: -f2)
local new_expiry_formatted
new_expiry_formatted=$(date -d "@$new_expiry_date" +"%d %B %Y")
else
echo "$result"
fi
read -p "Tekan Enter untuk kembali ke menu..."
}

function _delete_account_logic() {
local password="$1"
local db_file="/etc/zivpn/users.db"
local config_file="/etc/zivpn/config.json"
local tmp_config_file="${config_file}.tmp"
if [ -z "$password" ]; then
echo "Error: Password is required."
return 1
fi
if [ ! -f "$db_file" ] || ! grep -q "^${password}:" "$db_file"; then
echo "Error: Password '${password}' not found."
return 1
fi
jq --arg pass "$password" 'del(.auth.config[] | select(. == $pass))' "$config_file" > "$tmp_config_file"
if [ $? -eq 0 ]; then
sed -i "/^${password}:/d" "$db_file"
mv "$tmp_config_file" "$config_file"
restart_zivpn
ip=$(cat /etc/zivpn/ip.txt)
isp=$(cat /etc/zivpn/isp.txt)
CERT_CN=$(openssl x509 -in /etc/zivpn/zivpn.crt -noout -subject | sed -n 's/.*CN = \([^,]*\).*/\1/p')
local host
if [ "$CERT_CN" == "zivpn" ]; then
host=$(cat /etc/zivpn/ip.txt)
else
host=$CERT_CN
fi
clear
echo "Success:"
echo "DELETE AKUN ZIVPN"
echo "┌────────────────────────┐"
echo "│ Host   : $host"
echo "│ IP     : $ip"
echo "│ ISP    : $isp"
echo "│ Pass   : $password"
echo "│ Status : Deleted"
echo "└────────────────────────┘"
echo "Terima kasih telah menggunakan layanan kami"
local message=$(cat <<EOF
DELETE AKUN ZIVPN
┌────────────────────────┐
│ Host   : $host
│ IP     : $ip
│ ISP    : $isp
│ Pass   : $password
│ Status : Deleted
└────────────────────────┘
Terima kasih telah menggunakan layanan kami
EOF
)
send_telegram_notification "$message"
return 0
else
rm -f "$tmp_config_file"
echo "Error: Failed to update config.json. No changes were made."
return 1
fi
}

function delete_account() {
clear
echo "───────────── Delete Account ─────────────"
_display_accounts
echo ""
read -p "Enter password to delete: " password
if [ -z "$password" ]; then
echo "Password cannot be empty."
return
fi
local result
result=$(_delete_account_logic "$password")
echo "$result"
read -p "Tekan Enter untuk kembali ke menu..."
}

function change_domain() {
echo "─────────────── Change Domain ───────────────"
echo -e "Domain akan dibuat sebagai subdomain dari: ${_G}${CF_BASE_DOMAIN}${NC}"
echo -e "Contoh: ketik 'vps2' → domain menjadi: vps2.${CF_BASE_DOMAIN}"
echo ""
local subdomain
while true; do
  read -p "Masukkan subdomain baru: " subdomain
  subdomain=$(echo "$subdomain" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]//g')
  [ -n "$subdomain" ] && break
  echo "Subdomain tidak boleh kosong."
done
local full_domain="${subdomain}.${CF_BASE_DOMAIN}"
local server_ip
server_ip=$(_cf_get_server_ip)
echo "Pointing DNS $full_domain → $server_ip ..."
local cf_result
cf_result=$(_cf_create_dns "$subdomain" "$server_ip")
if [ "$cf_result" == "ok" ]; then
  _ok "DNS record berhasil: $full_domain → $server_ip"
else
  _warn "Gagal membuat DNS Cloudflare."
fi
echo "Menunggu propagasi DNS (60 detik)..."
sleep 60
apt install -y certbot >/dev/null 2>&1
certbot certonly --standalone --non-interactive --agree-tos \
  --email "${CF_EMAIL}" \
  -d "${full_domain}" \
  --http-01-port 80 \
  >/dev/null 2>&1
if [ $? -eq 0 ]; then
  cp "/etc/letsencrypt/live/${full_domain}/fullchain.pem" /etc/zivpn/zivpn.crt
  cp "/etc/letsencrypt/live/${full_domain}/privkey.pem"   /etc/zivpn/zivpn.key
  _ok "SSL Let's Encrypt berhasil untuk $full_domain"
  # Update auto-renew cron
  (crontab -l 2>/dev/null | grep -v "# zivpn-ssl-renew") | crontab -
  (crontab -l 2>/dev/null; echo "0 3 * * * certbot renew --quiet && cp /etc/letsencrypt/live/${full_domain}/fullchain.pem /etc/zivpn/zivpn.crt && cp /etc/letsencrypt/live/${full_domain}/privkey.pem /etc/zivpn/zivpn.key && systemctl restart zivpn zivpn-api 2>/dev/null # zivpn-ssl-renew") | crontab -
else
  _warn "Let's Encrypt gagal. Menggunakan self-signed sebagai fallback."
  openssl req -new -newkey rsa:4096 -days 365 -nodes -x509 \
    -subj "/C=US/ST=California/L=Los Angeles/O=Example Corp/OU=IT Department/CN=${full_domain}" \
    -keyout "/etc/zivpn/zivpn.key" -out "/etc/zivpn/zivpn.crt" >/dev/null 2>&1
fi
echo "$full_domain" > /etc/zivpn/domain.txt
_ok "Domain disimpan: $full_domain"
systemctl restart zivpn-api >/dev/null 2>&1 || true
restart_zivpn
read -p "Tekan Enter untuk kembali..."
}

function _save_total_users() {
local db_file="/etc/zivpn/users.db"
local output_file="/etc/zivpn/total_users.txt"
if [ ! -f "$db_file" ] || [ ! -s "$db_file" ]; then
echo "0" > "$output_file"
return
fi
local total_users
total_users=$(wc -l < "$db_file" | tr -d ' ')
echo "$total_users" > "$output_file"
}

function _display_accounts() {
local db_file="/etc/zivpn/users.db"
if [ ! -f "$db_file" ] || [ ! -s "$db_file" ]; then
echo "No accounts found."
return
fi
local current_date
current_date=$(date +%s)
printf "%-20s │ %s\n" "Password" "Expires in (days)"
echo "──────────────────────────────────────────"
while IFS=':' read -r password expiry_date; do
if [[ -n "$password" ]]; then
local remaining_seconds=$((expiry_date - current_date))
if [ $remaining_seconds -gt 0 ]; then
local remaining_days=$((remaining_seconds / 86400))
printf "%-20s │ %s days\n" "$password" "$remaining_days"
else
printf "%-20s │ Expired\n" "$password"
fi
fi
done < "$db_file"
echo "──────────────────────────────────────────"
}

function list_accounts() {
clear
echo "──────────── Active Accounts ─────────────"
_display_accounts
echo ""
read -p "Press Enter to return to the menu..."
}

function format_kib_to_human() {
local kib=$1
if ! [[ "$kib" =~ ^[0-9]+$ ]] || [ -z "$kib" ]; then
kib=0
fi
if [ "$kib" -lt 1048576 ]; then
awk -v val="$kib" 'BEGIN { printf "%.2f MiB", val / 1024 }'
else
awk -v val="$kib" 'BEGIN { printf "%.2f GiB", val / 1048576 }'
fi
}

function get_main_interface() {
ip -o -4 route show to default | awk '{print $5}' | head -n 1
}

function _draw_info_panel() {
local os_info isp_info ip_info host_info bw_today bw_month client_name license_exp
os_info=$( (hostnamectl 2>/dev/null | grep "Operating System" | cut -d: -f2 | sed 's/^[ \t]*//') || echo "N/A" )
os_info=${os_info:-"N/A"}
ip_info=$(cat /etc/zivpn/ip.txt 2>/dev/null)
isp_info=$(cat /etc/zivpn/isp.txt 2>/dev/null)
ip_info=${ip_info:-"N/A"}
isp_info=${isp_info:-"N/A"}
# Prefer domain.txt, then cert CN, then IP
if [ -f /etc/zivpn/domain.txt ]; then
  host_info=$(cat /etc/zivpn/domain.txt)
else
  local CERT_CN
  CERT_CN=$(openssl x509 -in /etc/zivpn/zivpn.crt -noout -subject | sed -n 's/.*CN = \([^,]*\).*/\1/p' 2>/dev/null || echo "")
  if [ "$CERT_CN" == "zivpn" ] || [ -z "$CERT_CN" ]; then
    host_info=$ip_info
  else
    host_info=$CERT_CN
  fi
fi
host_info=${host_info:-"N/A"}
local api_url="https://${host_info}/"
cpu_name=$(lscpu | grep "Model name" | cut -d: -f2 | sed 's/^[ \t]*//')
cpu_cores=$(nproc)
mem_total=$(free -h | awk '/Mem:/ {print $2}')
mem_used=$(free -h | awk '/Mem:/ {print $3}')
mem_percent=$(free | awk '/Mem:/ {printf "%.0f%%", $3/$2*100}')
disk_total=$(df -h / | awk 'NR==2 {print $2}')
disk_used=$(df -h / | awk 'NR==2 {print $3}')
disk_avail=$(df -h / | awk 'NR==2 {print $4}')
disk_percent=$(df -h / | awk 'NR==2 {print $5}')
uptime_info=$(uptime -p)
iface=$(ip route | grep default | awk '{print $5}')
bw_today=$(vnstat -d | awk '/'$(date +%Y-%m-%d)'/ {print $5 " " $6}')
bw_month=$(vnstat -m | awk '/'$(date +%Y-%m)'/ {print $5 " " $6}')
if [ -f "$LICENSE_INFO_FILE" ]; then
source "$LICENSE_INFO_FILE"
client_name=${CLIENT_NAME:-"N/A"}
if [ -n "$EXPIRY_DATE" ]; then
local expiry_timestamp
expiry_timestamp=$(date -d "$EXPIRY_DATE" +%s)
local current_timestamp
current_timestamp=$(date +%s)
local remaining_seconds=$((expiry_timestamp - current_timestamp))
if [ $remaining_seconds -gt 0 ]; then
license_exp="$((remaining_seconds / 86400)) days"
else
license_exp="Expired"
fi
else
license_exp="N/A"
fi
else
client_name="N/A"
license_exp="N/A"
fi
_save_total_users
total_users=$(cat /etc/zivpn/total_users.txt)
apikey=$(cat /etc/zivpn/api_auth.key 2>/dev/null || echo "N/A")
VERSI_URL="https://raw.githubusercontent.com/AutoNV/udpzivpn/main/versi.txt"
versisc=$(curl -fsSL "$VERSI_URL" 2>/dev/null | tr -d ' \r\n')
if [ -z "$versisc" ]; then
versisc="UNKNOWN"
fi

  local W='\033[1;37m'
  local G='\033[1;32m'
  local C='\033[0;36m'
  local N='\033[0m'

  printf "${C}│${W} %-10s ${C}:${W} %s${N}\n"   "OS"      "${os_info}"
  printf "${C}│${W} %-10s ${C}:${W} %s${N}\n"   "IP"      "${ip_info}"
  printf "${C}│${W} %-10s ${C}:${W} %s${N}\n"   "Host"    "${host_info}"
  printf "${C}│${W} %-10s ${C}:${G} %s${N}\n"   "API URL" "${api_url}"
  printf "${C}│${W} %-10s ${C}:${G} %s${N}\n"   "Client"  "${client_name}"
  printf "${C}│${W} %-10s ${C}:${G} %s${N}\n"   "EXP"     "${license_exp}"
  printf "${C}│${W} %-10s ${C}:${W} %s${N}\n"   "RAM"     "${mem_used} / ${mem_total}"
  printf "${C}│${W} %-10s ${C}:${W} %s${N}\n"   "CPU"     "${cpu_name} (${cpu_cores} cores)"
  printf "${C}│${W} %-10s ${C}:${W} %s${N}\n"   "Disk"    "${disk_used} / ${disk_total} (${disk_percent})"
  printf "${C}│${W} %-10s ${C}:${W} %-20s  ${W}Users ${C}:${G} %s${N}\n"  "Uptime"   "${uptime_info}" "${total_users}"
  printf "${C}│${W} %-10s ${C}:${G} %-14s  ${W}Month ${C}:${G} %s${N}\n"  "BW Today" "${bw_today}"    "${bw_month}"
  printf "${C}│${W} %-10s ${C}:${G} %s${N}\n"   "Version" "${versisc}"
}

function _draw_service_status() {
  local W='\033[1;37m'
  local G='\033[1;32m'
  local R='\033[0;31m'
  local Y='\033[1;33m'
  local C='\033[0;36m'
  local N='\033[0m'

  # Status ZiVPN
  local sv1; sv1=$(systemctl is-active "zivpn.service" 2>/dev/null || echo "unknown")
  local st1 sc1
  case "$sv1" in
    active)       st1="ON";  sc1="$G" ;;
    inactive)     st1="OFF"; sc1="$R" ;;
    failed)       st1="ERR"; sc1="$R" ;;
    activating)   st1="..."; sc1="$Y" ;;
    *)            st1="OFF"; sc1="$R" ;;
  esac

  # Status API
  local sv2; sv2=$(systemctl is-active "zivpn-api.service" 2>/dev/null || echo "unknown")
  local st2 sc2
  case "$sv2" in
    active)       st2="ON";  sc2="$G" ;;
    inactive)     st2="OFF"; sc2="$R" ;;
    failed)       st2="ERR"; sc2="$R" ;;
    activating)   st2="..."; sc2="$Y" ;;
    *)            st2="OFF"; sc2="$R" ;;
  esac

  # Status Service ZI
  local rule_ok="no"
  iptables -t nat -S PREROUTING 2>/dev/null | grep -qE "6000:19999|:5667" && rule_ok="yes"
  local st3 sc3
  if [ "$rule_ok" = "yes" ]; then st3="ON";  sc3="$G"
  else                             st3="OFF"; sc3="$R"
  fi

  printf "${C}│${W} ZiVPN ${C}:${sc1}%-3s${W}  API ${C}:${sc2}%-3s${W}  Service ZI ${C}:${sc3}%s${N}\n" \
         "$st1" "$st2" "$st3"
}

function setup_auto_backup() {
echo "─── Configure Auto Backup ───"
if [ ! -f "/etc/zivpn/telegram.conf" ]; then
echo "Telegram is not configured. Please run a manual backup once to set it up."
return
fi
read -p "Enter backup interval in hours (e.g., 6, 12, 24). Enter 0 to disable: " interval
if ! [[ "$interval" =~ ^[0-9]+$ ]]; then
echo "Invalid input. Please enter a number."
return
fi
(crontab -l 2>/dev/null | grep -v "# zivpn-auto-backup") | crontab -
if [ "$interval" -gt 0 ]; then
local cron_schedule="0 */${interval} * * *"
(crontab -l 2>/dev/null; echo "${cron_schedule} /usr/local/bin/zivpn_helper.sh backup >/dev/null 2>&1 # zivpn-auto-backup") | crontab -
echo "Auto backup scheduled to run every ${interval} hour(s)."
else
echo "Auto backup has been disabled."
fi
}

function create_account() {
clear
echo -e "${YELLOW}┌──────────────────────────────────────────────────────┐${NC}"
echo -e "${YELLOW}│${NC}           ${BOLD_WHITE}✦  Create Account  ✦${NC}                        ${YELLOW}│${NC}"
echo -e "${YELLOW}├──────────────────────────────────────────────────────┤${NC}"
echo -e "${YELLOW}│${NC}   ${LIGHT_BLUE}1)${NC}  ${BOLD_WHITE}Create Zivpn                                  ${YELLOW}│${NC}"
echo -e "${YELLOW}│${NC}   ${LIGHT_BLUE}2)${NC}  ${BOLD_WHITE}Trial Zivpn                                   ${YELLOW}│${NC}"
echo -e "${YELLOW}│${NC}   ${LIGHT_BLUE}0)${NC}  ${BOLD_WHITE}Back to Main Menu                             ${YELLOW}│${NC}"
echo -e "${YELLOW}└──────────────────────────────────────────────────────┘${NC}"
read -p " Enter your choice [0-2]: " choice
case $choice in
1) create_manual_account ;;
2) create_trial_account ;;
0) return ;;
*) echo "Invalid option." ;;
esac
}

function show_backup_menu() {
clear
echo -e "${YELLOW}┌──────────────────────────────────────────────────────┐${NC}"
echo -e "${YELLOW}│${NC}           ${BOLD_WHITE}✦  Backup / Restore  ✦${NC}                      ${YELLOW}│${NC}"
echo -e "${YELLOW}├──────────────────────────────────────────────────────┤${NC}"
echo -e "${YELLOW}│${NC}   ${LIGHT_BLUE}1)${NC}  ${BOLD_WHITE}Backup Data                                   ${YELLOW}│${NC}"
echo -e "${YELLOW}│${NC}   ${LIGHT_BLUE}2)${NC}  ${BOLD_WHITE}Restore Data                                  ${YELLOW}│${NC}"
echo -e "${YELLOW}│${NC}   ${LIGHT_BLUE}3)${NC}  ${BOLD_WHITE}Auto Backup                                   ${YELLOW}│${NC}"
echo -e "${YELLOW}│${NC}   ${LIGHT_BLUE}4)${NC}  ${BOLD_WHITE}Atur Ulang Notifikasi Telegram                ${YELLOW}│${NC}"
echo -e "${YELLOW}│${NC}   ${LIGHT_BLUE}0)${NC}  ${BOLD_WHITE}Back to Main Menu                             ${YELLOW}│${NC}"
echo -e "${YELLOW}└──────────────────────────────────────────────────────┘${NC}"
read -p " Enter your choice [0-4]: " choice
case $choice in
1) /usr/local/bin/zivpn_helper.sh backup ;;
2) /usr/local/bin/zivpn_helper.sh restore ;;
3) setup_auto_backup ;;
4) /usr/local/bin/zivpn_helper.sh setup-telegram ;;
0) return ;;
*) echo "Invalid option." ;;
esac
}

function set_reboot_at_time() {
local HOUR="$1"
local MINUTE="0"
local CRON_TAG="#ZIVPN_AUTO_REBOOT"
crontab -l 2>/dev/null | grep -v "$CRON_TAG" > /tmp/cron_zivpn || true
echo "$MINUTE $HOUR * * * /sbin/reboot $CRON_TAG" >> /tmp/cron_zivpn
crontab /tmp/cron_zivpn
rm -f /tmp/cron_zivpn
echo -e "${GREEN}✔ Auto reboot diset jam $(printf '%02d:00' "$HOUR")${NC}"
}

function remove_reboot_schedule() {
local CRON_TAG="#ZIVPN_AUTO_REBOOT"
crontab -l 2>/dev/null | grep -v "$CRON_TAG" | crontab -
echo -e "${YELLOW}✔ Auto reboot dihapus${NC}"
}

function set_reboot_menu() {
clear
echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${CYAN}     PILIH JAM AUTO REBOOT     ${NC}"
echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""
for i in $(seq 1 24); do
if [[ "$i" -eq 24 ]]; then
printf "%2d) Jam 00:00\n" "$i"
else
printf "%2d) Jam %02d:00\n" "$i" "$i"
fi
done
echo " 0) Hapus Auto Reboot"
echo ""
read -rp "Pilih [1-24 / 0]: " choice
if [[ "$choice" == "0" ]]; then
remove_reboot_schedule
return
fi
if [[ "$choice" -ge 1 && "$choice" -le 24 ]]; then
if [[ "$choice" -eq 24 ]]; then
set_reboot_at_time 0
else
set_reboot_at_time "$choice"
fi
else
echo -e "${RED}❌ Pilihan tidak valid${NC}"
fi
}

function show_expired_message_and_exit() {
clear
echo -e "\n${RED}──────────────────────────────────────────────────────${NC}"
echo -e "${RED}          LISENSI ANDA TELAH KEDALUWARSA!             ${NC}"
echo -e "${RED}──────────────────────────────────────────────────────${NC}\n"
echo -e "${BOLD_WHITE}Akses ke layanan ZIVPN di server anda telah dihentikan."
echo -e "Segala aktivitas VPN tidak akan berfungsi lagi.\n"
echo -e "Untuk memperpanjang lisensi dan mengaktifkan kembali layanan,"
echo -e "silakan hubungi admin https://wa.me/62890 \n"
echo -e "${LIGHT_GREEN}Setelah diperpanjang, layanan akan aktif kembali secara otomatis.${NC}\n"
exit 0
}

function show_menu() {
if [ -f "/etc/zivpn/.expired" ]; then
show_expired_message_and_exit
fi
clear

  local W='\033[1;37m'
  local G='\033[1;32m'
  local R='\033[0;31m'
  local C='\033[0;36m'
  local N='\033[0m'

  echo -e "${C}┌────────────────────────────────────────────┐"
  echo -e "${C}│${W}        ⚡  Menu Panel ZiVPN  ⚡          ${C}│"
  echo -e "${C}├────────────────────────────────────────────"

  _draw_info_panel

  echo -e "${C}├──────────── Service Status ────────────────"

  _draw_service_status

  # ── API Key ───────────────────────────────────
  local _kf="/etc/zivpn/api_auth.key"
  local _ak; if [ -f "$_kf" ]; then _ak=$(cat "$_kf"); else _ak="(not set)"; fi
  echo -e "${C}├────────────────────────────────────────────"
  printf  "${C}│${W} API Key  ${C}:${G} %s${N}\n" "$_ak"

  # ══ Menu 2 kolom (tanpa garis tengah) ═════════
  echo -e "${C}├────────────────────────────────────────────"
  printf  "${C}│${W}  %2s. %-16s    %2s. %s${N}\n"  "1"  "Buat Akun"       "8"  "Lihat API Key"
  printf  "${C}│${W}  %2s. %-16s    %2s. %s${N}\n"  "2"  "Perpanjang"      "9"  "Restart"
  printf  "${C}│${W}  %2s. %-16s   %2s. %s${N}\n"   "3"  "Hapus Akun"      "10" "Update Script"
  printf  "${C}│${W}  %2s. %-16s   %2s. %s${N}\n"   "4"  "Ganti Domain"    "11" "Update Lisensi"
  printf  "${C}│${W}  %2s. %-16s   %2s. %s${N}\n"   "5"  "Daftar Akun"     "12" "Speedtest"
  printf  "${C}│${W}  %2s. %-16s   %2s. %s${N}\n"   "6"  "Backup/Restore"  "13" "Perbaiki Error"
  printf  "${C}│${W}  %2s. %-16s   %2s. %s${N}\n"   "7"  "Buat API Key"    "14" "Auto Reboot"
  echo -e "${C}├────────────────────────────────────────────"
  printf  "${C}│${W}  x) Keluar${N}\n"
  echo -e "${C}└────────────────────────────────────────────┘${N}"
  echo ""
  read -p " Pilih Menu (1-14 atau x): " choice
  # remap x -> 0
  [[ "$choice" == "x" || "$choice" == "X" ]] && choice=0
case $choice in
1) create_account ;;
2) renew_account ;;
3) delete_account ;;
4) change_domain ;;
5) list_accounts ;;
6) show_backup_menu ;;
7) _generate_api_key ;;
8) _lihat_api_key ;;
9) systemctl restart zivpn.service --no-block && systemctl restart zivpn-udp.service --no-block && read -p "Tekan Enter untuk kembali ke menu..." && /usr/local/bin/zivpn-manager ;;
10) wget -q https://raw.githubusercontent.com/AutoNV/udpzivpn/main/update.sh -O /usr/local/bin/update-manager && chmod +x /usr/local/bin/update-manager && /usr/local/bin/update-manager && read -p "Tekan Enter untuk kembali ke menu..." && /usr/local/bin/zivpn-manager ;;
11) update_expiry_from_license_url && read -p "Tekan Enter untuk kembali ke menu..." && /usr/local/bin/zivpn-manager ;;
12) wget https://raw.githubusercontent.com/arivpnstores/v4/main/Cdy/speedtest -O /usr/bin/speedtest && chmod +x /usr/bin/speedtest && yes | /usr/bin/speedtest && read -p "Tekan Enter untuk kembali ke menu..." && /usr/local/bin/zivpn-manager ;;
13) wget -q https://raw.githubusercontent.com/AutoNV/udpzivpn/main/fix-zivpn.sh -O /usr/local/bin/fix-zivpn.sh && chmod +x /usr/local/bin/fix-zivpn.sh && /usr/local/bin/fix-zivpn.sh && read -p "Tekan Enter untuk kembali ke menu..." && /usr/local/bin/zivpn-manager ;;
14) set_reboot_menu ;;
0) exit 0 ;;
*) echo "Invalid option. Please try again." ;;
esac
}

function run_setup() {
clear
_sep
echo -e "${_W}    ⚡  ZiVPN Manager - Installation${NC}"
_sep
echo -e "${_Y}    Thank you for using SC UDO ZiVPN${NC}"
echo -e "${_Y}    Powered by  N E X U S D E V${NC}"
_sep
echo ""
sleep 1.2

# ── Verifikasi lisensi ────────────────────────────
_hdr "[ 1/7 ] Verifying license..."
_progress "Checking license"
verify_license

# ── Setup domain & SSL Cloudflare ─────────────────
mkdir -p /etc/zivpn
setup_cloudflare_ssl

# ── Persiapan sistem ──────────────────────────────
_hdr "[ 2/7 ] Preparing system..."
export DEBIAN_FRONTEND=noninteractive
_progress "dpkg configure"
dpkg --configure -a >/dev/null 2>&1 || true
apt -f install -y >/dev/null 2>&1 || true
_ok "dpkg ready"

_progress "apt update"
apt update >/dev/null 2>&1
_ok "apt updated"

_progress "Installing dependencies"
apt install -y sudo screen ufw ruby rubygems curl wget python3-pip jq zip vnstat cron >/dev/null 2>&1
_ok "Dependencies installed"

_progress "iptables-persistent"
echo iptables-persistent iptables-persistent/autosave_v4 boolean true | debconf-set-selections
echo iptables-persistent iptables-persistent/autosave_v6 boolean true | debconf-set-selections
apt install -y iptables-persistent netfilter-persistent >/dev/null 2>&1
iptables -t nat -F PREROUTING
netfilter-persistent save >/dev/null 2>&1
_ok "iptables-persistent ready"

_progress "ca-certificates"
apt install -y wget curl ca-certificates >/dev/null 2>&1
update-ca-certificates >/dev/null 2>&1
_ok "Certificates updated"

# ── Stop service lama ─────────────────────────────
_hdr "[ 3/7 ] Stopping old services..."
_progress "Stopping ZiVPN"
systemctl stop zivpn 2>/dev/null || true
rm -f /usr/local/bin/zivpn
_ok "Old service cleared"

# ── Download & install ZiVPN ──────────────────────
_hdr "[ 4/7 ] Downloading ZiVPN binary..."
ARCH=$(uname -m)
case "$ARCH" in
  x86_64)        FILE="zi.sh"  ;;
  aarch64)       FILE="zi2.sh" ;;
  armv7l|armhf)  FILE="zi3.sh" ;;
  *)
    _err "Unsupported architecture: $ARCH"
    exit 1
  ;;
esac
_progress "Downloading $FILE"
wget -q -O /root/zi.sh "https://raw.githubusercontent.com/AutoNV/udpzivpn/main/$FILE"
chmod +x /root/zi.sh
_ok "ZiVPN binary downloaded ($ARCH)"

_progress "Running installer"
sudo /root/zi.sh >/dev/null 2>&1
_ok "ZiVPN binary installed"

# Restore SSL cert from Let's Encrypt if domain was configured
if [ -f /etc/zivpn/domain.txt ]; then
  _DOMAIN=$(cat /etc/zivpn/domain.txt)
  _LE_CERT="/etc/letsencrypt/live/${_DOMAIN}/fullchain.pem"
  _LE_KEY="/etc/letsencrypt/live/${_DOMAIN}/privkey.pem"
  if [ -f "$_LE_CERT" ] && [ -f "$_LE_KEY" ]; then
    cp "$_LE_CERT" /etc/zivpn/zivpn.crt
    cp "$_LE_KEY"  /etc/zivpn/zivpn.key
    _ok "SSL cert Let's Encrypt dipulihkan untuk ${_DOMAIN}"
  fi
fi

_progress "Starting service"
systemctl daemon-reload
systemctl start zivpn
systemctl enable zivpn >/dev/null 2>&1
_ok "ZiVPN service started"

# ── vnstat ────────────────────────────────────────
_hdr "[ 5/7 ] Setting up bandwidth monitor..."
local net_interface
net_interface=$(ip -o -4 route show to default | awk '{print $5}' | head -n 1)
if [ -n "$net_interface" ]; then
  _progress "vnstat setup"
  systemctl stop vnstat 2>/dev/null || true
  vnstat -u -i "$net_interface" --force 2>/dev/null || true
  systemctl enable vnstat >/dev/null 2>&1
  systemctl start vnstat
  _ok "vnstat ready on $net_interface"
else
  _warn "Network interface not detected, skipping vnstat"
fi

# ── Helper & config ───────────────────────────────
_hdr "[ 6/7 ] Downloading helper scripts..."
_progress "zivpn_helper.sh"
wget -q -O /usr/local/bin/zivpn_helper.sh \
  https://raw.githubusercontent.com/AutoNV/udpzivpn/main/zivpn_helper.sh
chmod +x /usr/local/bin/zivpn_helper.sh
_ok "zivpn_helper.sh"

_progress "Clearing default passwords"
jq '.auth.config = []' /etc/zivpn/config.json > /etc/zivpn/config.json.tmp \
  && mv /etc/zivpn/config.json.tmp /etc/zivpn/config.json
touch /etc/zivpn/users.db
RANDOM_PASS="zivpn$(shuf -i 10000-99999 -n 1)"
_ok "Default passwords cleared"

# ── API, cron, manager ────────────────────────────
_hdr "[ 7/7 ] Setting up REST API & finishing..."

_progress "Node.js check"
if ! command -v node &>/dev/null; then
  curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash - >/dev/null 2>&1
  apt-get install -y nodejs >/dev/null 2>&1
fi
_ok "Node.js ready"

mkdir -p /etc/zivpn/api
cat <<'EOF' > /etc/zivpn/api/package.json
{
"name": "zivpn-api",
"version": "1.0.0",
"description": "API for managing ZIVPN",
"main": "api.js",
"scripts": { "start": "node api.js" },
"dependencies": { "express": "^4.17.1" }
}
EOF
cat <<'EOF' > /etc/zivpn/api/api.js
const express = require('express');
const https = require('https');
const http = require('http');
const { execFile } = require('child_process');
const fs = require('fs');
const app = express();
const HTTPS_PORT = 443;
const HTTP_PORT = 80;
const AUTH_KEY_PATH = '/etc/zivpn/api_auth.key';
const ZIVPN_MANAGER_SCRIPT = '/usr/local/bin/zivpn-manager';
const authenticate = (req, res, next) => {
const providedAuthKey = req.query.auth;
if (!providedAuthKey) return res.status(401).json({ status: 'error', message: 'Authentication key is required.' });
fs.readFile(AUTH_KEY_PATH, 'utf8', (err, storedKey) => {
if (err) return res.status(500).json({ status: 'error', message: 'Could not read authentication key.' });
if (providedAuthKey.trim() !== storedKey.trim()) return res.status(403).json({ status: 'error', message: 'Invalid authentication key.' });
next();
});
};
app.use(authenticate);
const executeZivpnManager = (command, args, res) => {
execFile('/bin/bash', [ZIVPN_MANAGER_SCRIPT, command, ...args], (error, stdout, stderr) => {
if (error) {
const errorMessage = stderr || stdout || 'An internal server error occurred.';
return res.status(500).json({ status: 'error', message: errorMessage.trim() });
}
if (stdout.toLowerCase().includes('success')) {
res.json({ status: 'success', message: stdout.trim() });
} else {
res.status(400).json({ status: 'error', message: stdout.trim() });
}
});
};
app.all('/create/zivpn', (req, res) => {
const { password, exp } = req.query;
if (!password || !exp) return res.status(400).json({ status: 'error', message: 'Parameters password and exp are required.' });
executeZivpnManager('create_account', [password, exp], res);
});
app.all('/delete/zivpn', (req, res) => {
const { password } = req.query;
if (!password) return res.status(400).json({ status: 'error', message: 'Parameter password is required.' });
executeZivpnManager('delete_account', [password], res);
});
app.all('/renew/zivpn', (req, res) => {
const { password, exp } = req.query;
if (!password || !exp) return res.status(400).json({ status: 'error', message: 'Parameters password and exp are required.' });
executeZivpnManager('renew_account', [password, exp], res);
});
app.all('/trial/zivpn', (req, res) => {
const { exp } = req.query;
if (!exp) return res.status(400).json({ status: 'error', message: 'Parameter exp is required.' });
executeZivpnManager('trial_account', [exp], res);
});
// Try HTTPS first, fallback to HTTP if cert not found
const certPath = '/etc/zivpn/zivpn.crt';
const keyPath  = '/etc/zivpn/zivpn.key';
if (fs.existsSync(certPath) && fs.existsSync(keyPath)) {
  const sslOptions = {
    cert: fs.readFileSync(certPath),
    key:  fs.readFileSync(keyPath)
  };
  https.createServer(sslOptions, app).listen(HTTPS_PORT, () =>
    console.log('ZIVPN API server running on HTTPS port ' + HTTPS_PORT));
  // HTTP redirect to HTTPS
  const domain = fs.existsSync('/etc/zivpn/domain.txt')
    ? fs.readFileSync('/etc/zivpn/domain.txt','utf8').trim()
    : 'localhost';
  http.createServer((req, res) => {
    res.writeHead(301, { Location: 'https://' + domain + req.url });
    res.end();
  }).listen(HTTP_PORT, () =>
    console.log('HTTP redirect running on port ' + HTTP_PORT));
} else {
  app.listen(HTTP_PORT, () =>
    console.log('ZIVPN API server running on HTTP port ' + HTTP_PORT + ' (no SSL cert found)'));
}
EOF

_progress "npm install"
npm install --prefix /etc/zivpn/api >/dev/null 2>&1
_ok "API dependencies installed"

cat <<'EOF' > /etc/systemd/system/zivpn-api.service
[Unit]
Description=ZIVPN REST API Service (HTTPS)
After=network.target
[Service]
Type=simple
User=root
WorkingDirectory=/etc/zivpn/api
ExecStart=/usr/bin/node /etc/zivpn/api/api.js
Restart=on-failure
AmbientCapabilities=CAP_NET_BIND_SERVICE
[Install]
WantedBy=multi-user.target
EOF
systemctl daemon-reload
systemctl enable zivpn-api.service >/dev/null 2>&1
systemctl start zivpn-api.service

_progress "API key setup"
if [ ! -f /etc/zivpn/api_auth.key ]; then
  local initial_api_key
  initial_api_key=$(LC_ALL=C tr -dc 'a-zA-Z0-9' < /dev/urandom | head -c 6)
  echo "$initial_api_key" > /etc/zivpn/api_auth.key
  chmod 600 /etc/zivpn/api_auth.key
fi
_ok "API key ready"

_progress "Firewall port 80 & 443"
iptables -I INPUT -p tcp --dport 80  -j ACCEPT
iptables -I INPUT -p tcp --dport 443 -j ACCEPT
ufw allow 80/tcp  >/dev/null 2>&1 || true
ufw allow 443/tcp >/dev/null 2>&1 || true
_ok "Port 80 dan 443 dibuka"

_progress "License checker cron"
# license checker script (unchanged logic)
mkdir -p /etc/zivpn
cat > /etc/zivpn/license_checker.sh << 'LCEOF'
#!/bin/bash
LICENSE_URL="https://raw.githubusercontent.com/AutoNV/udpzivpn/main/ip2"
LICENSE_INFO_FILE="/etc/zivpn/.license_info"
EXPIRED_LOCK_FILE="/etc/zivpn/.expired"
log() { echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> /var/log/zivpn_license.log; }
if [ ! -f "$LICENSE_INFO_FILE" ]; then log "License info file not found."; exit 1; fi
source "$LICENSE_INFO_FILE"
if [ -z "$CLIENT_NAME" ] || [ -z "$EXPIRY_DATE" ]; then log "License info incomplete."; exit 1; fi
SERVER_IP=$(cat /etc/zivpn/ip.txt 2>/dev/null)
if [ -z "$SERVER_IP" ]; then log "Could not read server IP."; exit 1; fi
license_data=$(curl -s "$LICENSE_URL")
if [ $? -ne 0 ] || [ -z "$license_data" ]; then log "Could not reach license server."; exit 0; fi
license_entry=$(echo "$license_data" | grep -w "$SERVER_IP")
if [ -z "$license_entry" ]; then log "IP not found in license list."; exit 1; fi
client_name_remote=$(echo "$license_entry" | awk '{print $1}')
expiry_date_remote=$(echo "$license_entry" | awk '{print $2}')
expiry_timestamp_remote=$(date -d "$expiry_date_remote" +%s)
current_timestamp=$(date +%s)
if [ "$expiry_date_remote" != "$EXPIRY_DATE" ]; then
  echo "CLIENT_NAME=${client_name_remote}" > "$LICENSE_INFO_FILE"
  echo "EXPIRY_DATE=${expiry_date_remote}" >> "$LICENSE_INFO_FILE"
fi
if [ "$expiry_timestamp_remote" -le "$current_timestamp" ]; then
  if [ ! -f "$EXPIRED_LOCK_FILE" ]; then
    systemctl stop zivpn.service
    touch "$EXPIRED_LOCK_FILE"
  fi
else
  if [ -f "$EXPIRED_LOCK_FILE" ]; then
    rm "$EXPIRED_LOCK_FILE"
    systemctl start zivpn.service
  fi
fi
exit 0
LCEOF
chmod +x /etc/zivpn/license_checker.sh
(crontab -l 2>/dev/null | grep -v "# zivpn-license-check") | crontab -
(crontab -l 2>/dev/null; echo "*/5 * * * * /etc/zivpn/license_checker.sh # zivpn-license-check") | crontab -
_ok "License checker cron set"

_progress "Auto update & watchdog cron"
chmod +x /usr/local/bin/update-manager 2>/dev/null || true
(crontab -l 2>/dev/null | grep -v "# zivpn-auto-update") | crontab -
(crontab -l 2>/dev/null; echo "0 4 * * * /usr/local/bin/update-manager # zivpn-auto-update") | crontab -
(crontab -l 2>/dev/null | grep -v "# zivpn-auto-start") | crontab -
(crontab -l 2>/dev/null; echo "*/2 * * * * systemctl is-active --quiet zivpn || systemctl start zivpn # zivpn-auto-start") | crontab -
_ok "Auto update & watchdog enabled"

_progress "Telegram notification"
echo "Notifikasi Telegram dapat diatur nanti melalui menu Backup/Restore."
_ok "Skipped (configure via menu)"

_progress "Installing zivpn-manager"
cp "$0" /usr/local/bin/zivpn-manager
chmod +x /usr/local/bin/zivpn-manager
_ok "zivpn-manager installed"

echo ""
_sep
echo -e "${_G}  ✔  Installation completed successfully!${NC}"
_sep
local _domain_out
_domain_out=$(cat /etc/zivpn/domain.txt 2>/dev/null || echo "N/A")
local _apikey_out
_apikey_out=$(cat /etc/zivpn/api_auth.key 2>/dev/null || echo "N/A")
echo -e "${_W}  Domain   : ${_G}${_domain_out}${NC}"
echo -e "${_W}  API URL  : ${_G}https://${_domain_out}/${NC}"
echo -e "${_W}  API Key  : ${_G}${_apikey_out}${NC}"
echo -e "${_W}  Contoh   : ${_G}https://${_domain_out}/create/zivpn?auth=${_apikey_out}&password=USER&exp=30${NC}"
_sep
echo ""
sleep 1

if [ -f "/usr/local/bin/zivpn-manager" ]; then
rm -rf /root/.profile
cat <<EOF > /root/.profile
if [ "$BASH" ]; then
if [ -f ~/.bashrc ]; then
. ~/.bashrc
fi
fi
mesg n || true
ln -fs /usr/share/zoneinfo/Asia/Jakarta /etc/localtime
$WEB_SERVER
menu
EOF
PROFILE_FILE="/root/.bashrc"
[ -f "/root/.bash_profile" ] && PROFILE_FILE="/root/.bash_profile"
ALIAS_CMD="alias menu='/usr/local/bin/zivpn-manager'"
AUTORUN_CMD="/usr/local/bin/zivpn-manager"
grep -qF "$ALIAS_CMD" "$PROFILE_FILE" || echo "$ALIAS_CMD" >> "$PROFILE_FILE"
grep -qF "$AUTORUN_CMD" "$PROFILE_FILE" || echo "$AUTORUN_CMD" >> "$PROFILE_FILE"
_ok "Mode: ZIVPN Only aktif"
fi
show_menu
}
EXPIRY_DATE=$(date -d "+1 day" +%s)
echo "Creating a temporary initial account..."
echo "${RANDOM_PASS}:${EXPIRY_DATE}" >> /etc/zivpn/users.db
jq --arg pass "$RANDOM_PASS" '.auth.config += [$pass]' /etc/zivpn/config.json > /etc/zivpn/config.json.tmp && mv /etc/zivpn/config.json.tmp /etc/zivpn/config.json
echo "Setting up expiry check cron job..."
cat <<'EOF' > /etc/zivpn/expire_check.sh
DB_FILE="/etc/zivpn/users.db"
CONFIG_FILE="/etc/zivpn/config.json"
TMP_DB_FILE="${DB_FILE}.tmp"
CURRENT_DATE=$(date +%s)
SERVICE_RESTART_NEEDED=false
if [ ! -f "$DB_FILE" ]; then exit 0; fi
> "$TMP_DB_FILE"
while IFS=':' read -r password expiry_date; do
if [[ -z "$password" ]]; then continue; fi
if [ "$expiry_date" -le "$CURRENT_DATE" ]; then
echo "User '${password}' has expired. Deleting permanently."
jq --arg pass "$password" 'del(.auth.config[] | select(. == $pass))' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
SERVICE_RESTART_NEEDED=true
else
echo "${password}:${expiry_date}" >> "$TMP_DB_FILE"
fi
done < "$DB_FILE"
mv "$TMP_DB_FILE" "$DB_FILE"
if [ "$SERVICE_RESTART_NEEDED" = true ]; then
echo "Restarting zivpn service due to user removal."
systemctl restart zivpn.service
fi
exit 0
EOF
chmod +x /etc/zivpn/expire_check.sh
CRON_JOB_EXPIRY="* * * * * /etc/zivpn/expire_check.sh # zivpn-expiry-check"
(crontab -l 2>/dev/null | grep -v "# zivpn-expiry-check") | crontab -
(crontab -l 2>/dev/null; echo "$CRON_JOB_EXPIRY") | crontab -
echo "Setting up license check script and cron job..."
cat <<'EOF' > /etc/zivpn/license_checker.sh
LICENSE_URL="https://raw.githubusercontent.com/AutoNV/udpzivpn/main/ip2"
LICENSE_INFO_FILE="/etc/zivpn/.license_info"
EXPIRED_LOCK_FILE="/etc/zivpn/.expired"
TELEGRAM_CONF="/etc/zivpn/telegram.conf"
LOG_FILE="/var/log/zivpn_license.log"
log() {
echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"
}
function get_host() {
local CERT_CN
CERT_CN=$(openssl x509 -in /etc/zivpn/zivpn.crt -noout -subject | sed -n 's/.*CN = \([^,]*\).*/\1/p' 2>/dev/null || echo "")
if [ "$CERT_CN" == "zivpn" ] || [ -z "$CERT_CN" ]; then
cat /etc/zivpn/ip.txt
else
echo "$CERT_CN"
fi
}
function get_isp() {
cat /etc/zivpn/isp.txt
}
send_telegram_message() {
local message="$1"
if [ ! -f "$TELEGRAM_CONF" ]; then
log "Telegram config not found, skipping notification."
return
fi
source "$TELEGRAM_CONF"
if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
local api_url="https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage"
curl -s -X POST "$api_url" -d "chat_id=${TELEGRAM_CHAT_ID}" --data-urlencode "text=${message}" -d "parse_mode=Markdown" > /dev/null
log "Simple telegram notification sent."
else
log "Telegram config found but token or chat ID is missing."
fi
}
log "Starting license check..."
SERVER_IP=$(cat /etc/zivpn/ip.txt)
if [ -z "$SERVER_IP" ]; then
log "Error: Failed to retrieve server IP. Exiting."
exit 1
fi
if [ ! -f "$LICENSE_INFO_FILE" ]; then
log "Error: Local license info file not found. Exiting."
exit 1
fi
source "$LICENSE_INFO_FILE"
license_data=$(curl -s "$LICENSE_URL")
if [ $? -ne 0 ] || [ -z "$license_data" ]; then
log "Error: Failed to connect to license server. Exiting."
exit 1
fi
license_entry=$(echo "$license_data" | grep -w "$SERVER_IP")
if [ -z "$license_entry" ]; then
if [ ! -f "$EXPIRED_LOCK_FILE" ]; then
log "License for IP ${SERVER_IP} has been REVOKED."
systemctl stop zivpn.service
touch "$EXPIRED_LOCK_FILE"
local MSG="Notifikasi Otomatis: Lisensi untuk Klien \`${CLIENT_NAME}\` dengan IP \`${SERVER_IP}\` telah dicabut (REVOKED). Layanan zivpn telah dihentikan."
send_telegram_message "$MSG"
fi
exit 0
fi
client_name_remote=$(echo "$license_entry" | awk '{print $1}')
expiry_date_remote=$(echo "$license_entry" | awk '{print $2}')
expiry_timestamp_remote=$(date -d "$expiry_date_remote" +%s)
current_timestamp=$(date +%s)
if [ "$expiry_date_remote" != "$EXPIRY_DATE" ]; then
log "Remote license has a different expiry date (${expiry_date_remote}). Updating local file."
echo "CLIENT_NAME=${client_name_remote}" > "$LICENSE_INFO_FILE"
echo "EXPIRY_DATE=${expiry_date_remote}" >> "$LICENSE_INFO_FILE"
CLIENT_NAME=$client_name_remote
EXPIRY_DATE=$expiry_date_remote
fi
if [ "$expiry_timestamp_remote" -le "$current_timestamp" ]; then
if [ ! -f "$EXPIRED_LOCK_FILE" ]; then
log "License for IP ${SERVER_IP} has EXPIRED."
systemctl stop zivpn.service
touch "$EXPIRED_LOCK_FILE"
local host
host=$(get_host)
local isp
isp=$(get_isp)
log "Sending rich expiry notification via helper script..."
/usr/local/bin/zivpn_helper.sh expiry-notification "$host" "$SERVER_IP" "$CLIENT_NAME" "$isp" "$EXPIRY_DATE"
fi
else
if [ -f "$EXPIRED_LOCK_FILE" ]; then
log "License for IP ${SERVER_IP} has been RENEWED/ACTIVATED."
rm "$EXPIRED_LOCK_FILE"
systemctl start zivpn.service
local host
host=$(get_host)
local isp
isp=$(get_isp)
log "Sending rich renewed notification via helper script..."
/usr/local/bin/zivpn_helper.sh renewed-notification "$host" "$SERVER_IP" "$CLIENT_NAME" "$isp" "$expiry_timestamp_remote"
else
log "License is active and valid. No action needed."
fi
fi
log "License check finished."
exit 0
EOF

function main() {
if [ "$#" -gt 0 ]; then
local command="$1"
shift
case "$command" in
create_account)
_create_account_logic "$@"
;;
delete_account)
_delete_account_logic "$@"
;;
renew_account)
_renew_account_logic "$@"
;;
trial_account)
_create_trial_account_logic "$@"
;;
*)
echo "Error: Unknown command '$command'"
exit 1
;;
esac
exit $?
fi
if [ ! -f "/etc/systemd/system/zivpn.service" ]; then
run_setup
fi
while true; do
show_menu
done
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
main "$@"
fi

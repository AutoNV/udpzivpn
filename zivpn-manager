#!/bin/bash

YELLOW='\033[1;37m'
RED='\033[0;31m'
LIGHT_BLUE='\033[0;37m'
BOLD_WHITE='\033[1;37m'
CYAN='\033[0;37m'
GREEN='\033[0;32m'
LIGHT_GREEN='\033[1;32m'
PURPLE='\033[0;37m'
BOLD_CYAN='\033[1;37m'
NC='\033[0m'

_C='\033[0;36m'
_G='\033[1;32m'
_W='\033[1;37m'
_Y='\033[1;33m'
_R='\033[0;31m'

_progress() {
  local label="$1"
  local width=28
  local i bar filled empty
  for ((i=0; i<=100; i++)); do
    filled=$(( i * width / 100 ))
    empty=$(( width - filled ))
    bar=""
    for ((j=0; j<filled; j++)); do bar+="█"; done
    for ((j=0; j<empty; j++)); do bar+="░"; done
    printf "\r${_W}  %-22s ${_C}[${_G}%s${_C}]${_W} %3d%% ${NC}" "$label" "$bar" "$i"
    sleep 0.015
  done
  printf "\r${_W}  %-22s ${_C}[${_G}%s${_C}]${_W} %3d%% ${NC}\n" "$label" "$bar" "100"
}

_ok()   { printf "  ${_G}✔  %s${NC}\n"  "$1"; }
_warn() { printf "  ${_Y}⚠  %s${NC}\n"  "$1"; }
_err()  { printf "  ${_R}✘  %s${NC}\n"  "$1"; }
_sep()  { echo -e "${_C}--------------------------------------------${NC}"; }
_hdr()  { _sep; echo -e "${_W}  $1${NC}"; _sep; }

# ── Cloudflare Config ─────────────────────────────────────────
CF_EMAIL="ayfa7756@gmail.com"
CF_API_KEY="89df648f7990d6d807d6c9ed7dd265d9d4300"
CF_API_TOKEN="beb2618f7705d1b38b2d580ae033a233"
CF_BASE_DOMAIN="nexusdev.web.id"
CF_ZONE_ID=""   # akan di-fetch otomatis

LICENSE_URL="https://raw.githubusercontent.com/AutoNV/udpzivpn/main/ip2"
LICENSE_INFO_FILE="/etc/zivpn/.license_info"
CONFIG_DIR="/etc/zivpn"
TELEGRAM_CONF="${CONFIG_DIR}/telegram.conf"
DOMAIN_CONF="${CONFIG_DIR}/domain.conf"
API_PORT=443

if [ "$(id -u)" -ne 0 ]; then
echo "This script must be run as root. Please use sudo or run as root user." >&2
exit 1
fi

# ══════════════════════════════════════════════════════════════
#  CLOUDFLARE FUNCTIONS
# ══════════════════════════════════════════════════════════════

function cf_get_zone_id() {
  local zone_id
  zone_id=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones?name=${CF_BASE_DOMAIN}" \
    -H "X-Auth-Email: ${CF_EMAIL}" \
    -H "X-Auth-Key: ${CF_API_KEY}" \
    -H "Content-Type: application/json" | jq -r '.result[0].id' 2>/dev/null)
  echo "$zone_id"
}

function cf_delete_existing_record() {
  local zone_id="$1"
  local subdomain="$2"
  local fqdn="${subdomain}.${CF_BASE_DOMAIN}"
  local record_ids
  record_ids=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones/${zone_id}/dns_records?type=A&name=${fqdn}" \
    -H "X-Auth-Email: ${CF_EMAIL}" \
    -H "X-Auth-Key: ${CF_API_KEY}" \
    -H "Content-Type: application/json" | jq -r '.result[].id' 2>/dev/null)
  for rid in $record_ids; do
    curl -s -X DELETE "https://api.cloudflare.com/client/v4/zones/${zone_id}/dns_records/${rid}" \
      -H "X-Auth-Email: ${CF_EMAIL}" \
      -H "X-Auth-Key: ${CF_API_KEY}" \
      -H "Content-Type: application/json" >/dev/null
  done
}

function cf_create_a_record() {
  local zone_id="$1"
  local subdomain="$2"
  local ip="$3"
  local fqdn="${subdomain}.${CF_BASE_DOMAIN}"

  # Hapus record lama dulu
  cf_delete_existing_record "$zone_id" "$subdomain"

  local result
  result=$(curl -s -X POST "https://api.cloudflare.com/client/v4/zones/${zone_id}/dns_records" \
    -H "X-Auth-Email: ${CF_EMAIL}" \
    -H "X-Auth-Key: ${CF_API_KEY}" \
    -H "Content-Type: application/json" \
    --data "{
      \"type\": \"A\",
      \"name\": \"${fqdn}\",
      \"content\": \"${ip}\",
      \"ttl\": 120,
      \"proxied\": false
    }")
  local success
  success=$(echo "$result" | jq -r '.success' 2>/dev/null)
  if [ "$success" = "true" ]; then
    echo "ok"
  else
    local err_msg
    err_msg=$(echo "$result" | jq -r '.errors[0].message' 2>/dev/null)
    echo "error: $err_msg"
  fi
}

function generate_random_subdomain() {
  # Generate subdomain random 4 karakter huruf kecil + 4 angka
  local rand_str
  rand_str=$(LC_ALL=C tr -dc 'abcdefghijklmnopqrstuvwxyz' < /dev/urandom | head -c 4)
  local rand_num
  rand_num=$(shuf -i 1000-9999 -n 1)
  echo "${rand_str}${rand_num}"
}

function setup_cloudflare_domain() {
  _hdr "[ CF ] Cloudflare DNS Setup"

  # Install dependency
  apt install -y jq curl >/dev/null 2>&1

  local server_ip
  server_ip=$(cat /etc/zivpn/ip.txt 2>/dev/null)
  if [ -z "$server_ip" ]; then
    server_ip=$(curl -s https://api.ipify.org 2>/dev/null || curl -s https://ifconfig.me 2>/dev/null)
  fi

  if [ -z "$server_ip" ]; then
    _err "Gagal mendapatkan IP server"
    return 1
  fi

  _progress "Fetching Zone ID"
  local zone_id
  zone_id=$(cf_get_zone_id)
  if [ -z "$zone_id" ] || [ "$zone_id" = "null" ]; then
    _err "Gagal mendapatkan Zone ID untuk ${CF_BASE_DOMAIN}"
    _warn "Pastikan API Key dan email Cloudflare sudah benar"
    return 1
  fi
  CF_ZONE_ID="$zone_id"
  _ok "Zone ID: ${zone_id}"

  # Generate subdomain random
  local subdomain
  subdomain=$(generate_random_subdomain)
  local full_domain="${subdomain}.${CF_BASE_DOMAIN}"

  _progress "Creating DNS A Record"
  local cf_result
  cf_result=$(cf_create_a_record "$zone_id" "$subdomain" "$server_ip")

  if [ "$cf_result" != "ok" ]; then
    _err "Gagal membuat DNS record: $cf_result"
    return 1
  fi
  _ok "DNS Record: ${full_domain} → ${server_ip}"

  # Simpan domain config
  mkdir -p "$CONFIG_DIR"
  cat > "$DOMAIN_CONF" <<EOF
DOMAIN=${full_domain}
SUBDOMAIN=${subdomain}
BASE_DOMAIN=${CF_BASE_DOMAIN}
SERVER_IP=${server_ip}
CF_ZONE_ID=${zone_id}
SSL_ENABLED=true
EOF

  echo "$full_domain"
}

function setup_ssl_certbot() {
  local domain="$1"

  _hdr "[ SSL ] Installing SSL Certificate"

  # Install certbot
  _progress "Installing certbot"
  apt install -y certbot >/dev/null 2>&1
  _ok "Certbot installed"

  # Tunggu DNS propagasi
  _progress "Waiting DNS propagation (30s)"
  sleep 30

  # Coba resolve domain
  local resolved_ip
  for i in {1..10}; do
    resolved_ip=$(dig +short "$domain" 2>/dev/null | head -1)
    if [ -n "$resolved_ip" ]; then
      break
    fi
    sleep 5
  done

  local server_ip
  server_ip=$(cat /etc/zivpn/ip.txt 2>/dev/null)

  # Stop layanan yang pakai port 80/443 sementara
  systemctl stop nginx 2>/dev/null || true
  systemctl stop apache2 2>/dev/null || true

  _progress "Requesting SSL certificate"
  certbot certonly --standalone \
    -d "$domain" \
    --non-interactive \
    --agree-tos \
    --email "$CF_EMAIL" \
    --http-01-port 80 \
    >/var/log/zivpn_certbot.log 2>&1

  if [ $? -eq 0 ]; then
    # Copy cert ke zivpn dir
    cp "/etc/letsencrypt/live/${domain}/fullchain.pem" /etc/zivpn/zivpn.crt
    cp "/etc/letsencrypt/live/${domain}/privkey.pem" /etc/zivpn/zivpn.key
    chmod 600 /etc/zivpn/zivpn.key
    _ok "SSL certificate installed for ${domain}"

    # Setup auto-renew
    (crontab -l 2>/dev/null | grep -v "# zivpn-ssl-renew") | crontab -
    (crontab -l 2>/dev/null; echo "0 3 * * 1 certbot renew --quiet --post-hook 'cp /etc/letsencrypt/live/${domain}/fullchain.pem /etc/zivpn/zivpn.crt && cp /etc/letsencrypt/live/${domain}/privkey.pem /etc/zivpn/zivpn.key && systemctl restart zivpn-api.service' # zivpn-ssl-renew") | crontab -
    _ok "Auto-renew SSL configured"
    return 0
  else
    _warn "Certbot gagal, mencoba metode DNS challenge..."
    # Fallback: buat self-signed dengan domain
    openssl req -new -newkey rsa:4096 -days 365 -nodes -x509 \
      -subj "/C=US/ST=Jakarta/L=Jakarta/O=NexusDev/OU=VPN/CN=${domain}" \
      -keyout "/etc/zivpn/zivpn.key" -out "/etc/zivpn/zivpn.crt" 2>/dev/null
    _warn "SSL self-signed digunakan (certbot gagal, cek /var/log/zivpn_certbot.log)"
    return 1
  fi
}

function setup_nginx_ssl_proxy() {
  local domain="$1"

  _progress "Installing nginx"
  apt install -y nginx >/dev/null 2>&1

  # Config nginx sebagai HTTPS reverse proxy ke API port internal
  cat > "/etc/nginx/sites-available/zivpn-api" <<EOF
server {
    listen 80;
    server_name ${domain};
    return 301 https://\$host\$request_uri;
}

server {
    listen 443 ssl http2;
    server_name ${domain};

    ssl_certificate /etc/zivpn/zivpn.crt;
    ssl_certificate_key /etc/zivpn/zivpn.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    location / {
        proxy_pass http://127.0.0.1:5888;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }
}
EOF

  ln -sf /etc/nginx/sites-available/zivpn-api /etc/nginx/sites-enabled/zivpn-api
  rm -f /etc/nginx/sites-enabled/default 2>/dev/null || true

  nginx -t >/dev/null 2>&1 && systemctl restart nginx
  systemctl enable nginx >/dev/null 2>&1

  # Buka port 443 dan 80
  iptables -I INPUT -p tcp --dport 443 -j ACCEPT
  iptables -I INPUT -p tcp --dport 80 -j ACCEPT
  netfilter-persistent save >/dev/null 2>&1

  _ok "Nginx SSL proxy aktif → https://${domain}"
}

# ══════════════════════════════════════════════════════════════
#  HELPER FUNCTIONS
# ══════════════════════════════════════════════════════════════

function get_active_domain() {
  if [ -f "$DOMAIN_CONF" ]; then
    source "$DOMAIN_CONF"
    echo "${DOMAIN}"
  else
    # fallback ke CN dari cert
    local cert_cn
    cert_cn=$(openssl x509 -in /etc/zivpn/zivpn.crt -noout -subject 2>/dev/null | sed -n 's/.*CN = \([^,]*\).*/\1/p')
    if [ -n "$cert_cn" ] && [ "$cert_cn" != "zivpn" ]; then
      echo "$cert_cn"
    else
      cat /etc/zivpn/ip.txt 2>/dev/null
    fi
  fi
}

function get_api_base_url() {
  local domain
  domain=$(get_active_domain)
  local server_ip
  server_ip=$(cat /etc/zivpn/ip.txt 2>/dev/null)

  if [ -f "$DOMAIN_CONF" ]; then
    source "$DOMAIN_CONF"
    if [ "${SSL_ENABLED}" = "true" ]; then
      echo "https://${domain}"
      return
    fi
  fi
  # fallback
  echo "http://${server_ip}:5888"
}

function send_telegram_notification() {
local message="$1"
local keyboard="$2"
if [ ! -f "$TELEGRAM_CONF" ]; then
return 1
fi
source "$TELEGRAM_CONF"
if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
local api_url="https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage"
if [ -n "$keyboard" ]; then
curl -s -X POST "$api_url" -d "chat_id=${TELEGRAM_CHAT_ID}" --data-urlencode "text=${message}" -d "reply_markup=${keyboard}" > /dev/null
else
curl -s -X POST "$api_url" -d "chat_id=${TELEGRAM_CHAT_ID}" --data-urlencode "text=${message}" -d "parse_mode=Markdown" > /dev/null
fi
fi
}

function verify_license() {
echo "Verifying installation license..."
local SERVER_IP
SERVER_IP=$(cat /etc/zivpn/ip.txt)
if [ -z "$SERVER_IP" ]; then
echo -e "${RED}Failed to retrieve server IP. Please check your internet connection.${NC}"
exit 1
fi
local license_data
license_data=$(curl -s "$LICENSE_URL")
if [ $? -ne 0 ] || [ -z "$license_data" ]; then
echo -e "${RED}Gagal terhubung ke server lisensi. Mohon periksa koneksi internet Anda.${NC}"
exit 1
fi
local license_entry
license_entry=$(echo "$license_data" | grep -w "$SERVER_IP")
if [ -z "$license_entry" ]; then
echo -e "${RED}Verifikasi Lisensi Gagal! IP Anda tidak terdaftar. IP: ${SERVER_IP}${NC}"
exit 1
fi
local client_name
local expiry_date_str
client_name=$(echo "$license_entry" | awk '{print $1}')
expiry_date_str=$(echo "$license_entry" | awk '{print $2}')
local expiry_timestamp
expiry_timestamp=$(date -d "$expiry_date_str" +%s)
local current_timestamp
current_timestamp=$(date +%s)
if [ "$expiry_timestamp" -le "$current_timestamp" ]; then
echo -e "${RED}Verifikasi Lisensi Gagal! Lisensi untuk IP ${SERVER_IP} telah kedaluwarsa. Tanggal Kedaluwarsa: ${expiry_date_str}${NC}"
exit 1
fi
echo -e "${LIGHT_GREEN}Verifikasi Lisensi Berhasil! Client: ${client_name}, IP: ${SERVER_IP}${NC}"
sleep 2
mkdir -p /etc/zivpn
echo "CLIENT_NAME=${client_name}" > "$LICENSE_INFO_FILE"
echo "EXPIRY_DATE=${expiry_date_str}" >> "$LICENSE_INFO_FILE"
}

update_expiry_from_license_url() {
echo "Syncing expiry license..."
local SERVER_IP
SERVER_IP=$(cat /etc/zivpn/ip.txt)
if [ -z "$SERVER_IP" ]; then
echo -e "${RED}Gagal mendapatkan IP server${NC}"
return 1
fi
local license_data
license_data=$(curl -s "$LICENSE_URL")
if [ $? -ne 0 ] || [ -z "$license_data" ]; then
echo -e "${RED}Gagal mengambil data lisensi${NC}"
return 1
fi
local license_entry
license_entry=$(echo "$license_data" | grep -w "$SERVER_IP")
if [ -z "$license_entry" ]; then
echo -e "${RED}IP tidak terdaftar di lisensi${NC}"
return 1
fi
local CLIENT_NAME NEW_EXP_FROM_SERVER
CLIENT_NAME=$(echo "$license_entry" | awk '{print $1}')
NEW_EXP_FROM_SERVER=$(echo "$license_entry" | awk '{print $2}')
if ! date -d "$NEW_EXP_FROM_SERVER" >/dev/null 2>&1; then
echo -e "${RED}Format tanggal EXP dari server tidak valid${NC}"
return 1
fi
mkdir -p "$CONFIG_DIR"
cat > "$LICENSE_INFO_FILE" <<EOF
CLIENT_NAME=${CLIENT_NAME}
EXPIRY_DATE=${NEW_EXP_FROM_SERVER}
EOF
echo -e "${LIGHT_GREEN}Sinkronisasi lisensi berhasil!${NC}"
echo -e "Client  : ${CLIENT_NAME}"
echo -e "Expiry  : ${NEW_EXP_FROM_SERVER}"
}

function restart_zivpn() {
systemctl restart zivpn.service --no-block
}

function _create_account_logic() {
local password="$1"
local days="$2"
local db_file="/etc/zivpn/users.db"
if [ -z "$password" ] || [ -z "$days" ]; then
echo "Error: Password and days are required."
return 1
fi
if ! [[ "$days" =~ ^[0-9]+$ ]]; then
echo "Error: Invalid number of days."
return 1
fi
if grep -q "^${password}:" "$db_file"; then
echo "Error: Password '${password}' already exists."
return 1
fi
local expiry_date
expiry_date=$(date -d "+$days days" +%s)
echo "${password}:${expiry_date}" >> "$db_file"
jq --arg pass "$password" '.auth.config += [$pass]' /etc/zivpn/config.json > /etc/zivpn/config.json.tmp && mv /etc/zivpn/config.json.tmp /etc/zivpn/config.json
if [ $? -eq 0 ]; then
restart_zivpn
local EXPIRE_FORMATTED
EXPIRE_FORMATTED=$(date -d "@$expiry_date" +"%d %B %Y %H:%M")
ip=$(cat /etc/zivpn/ip.txt)
isp=$(cat /etc/zivpn/isp.txt)
local host
host=$(get_active_domain)
local api_base
api_base=$(get_api_base_url)
local api_key
api_key=$(cat /etc/zivpn/api_auth.key 2>/dev/null || echo "N/A")
clear
echo "Success:"
echo "CREATE AKUN ZIVPN"
echo "┌────────────────────────────────────────────┐"
echo "│ Host   : $host"
echo "│ IP     : $ip"
echo "│ ISP    : $isp"
echo "│ Pass   : $password"
echo "│ Expire : $EXPIRE_FORMATTED"
echo "├────────────────────────────────────────────┤"
echo "│ API URL: ${api_base}/create/zivpn"
echo "│         ?password=${password}&exp=${days}&auth=${api_key}"
echo "└────────────────────────────────────────────┘"
echo "Terima kasih telah menggunakan layanan kami"
local message=$(cat <<EOF
CREATE AKUN ZIVPN
┌────────────────────────────────────────────┐
│ Host   : $host
│ IP     : $ip
│ ISP    : $isp
│ Pass   : $password
│ Expire : $EXPIRE_FORMATTED
└────────────────────────────────────────────┘
EOF
)
send_telegram_notification "$message"
return 0
else
sed -i "/^${password}:/d" "$db_file"
echo "Error: Failed to update config.json."
return 1
fi
}

function create_manual_account() {
echo "───────── Create New Zivpn Account ───────"
read -p "Enter new password: " password
if [ -z "$password" ]; then
echo "Password cannot be empty."
return
fi
read -p "Enter active period (in days): " days
if ! [[ "$days" =~ ^[0-9]+$ ]]; then
echo "Invalid number of days."
return
fi
local result
result=$(_create_account_logic "$password" "$days")
if [[ "$result" == "Success"* ]]; then
local db_file="/etc/zivpn/users.db"
local user_line
user_line=$(grep "^${password}:" "$db_file")
if [ -n "$user_line" ]; then
local expiry_date
expiry_date=$(echo "$user_line" | cut -d: -f2)
local HOST
HOST=$(get_active_domain)
local EXPIRE_FORMATTED
EXPIRE_FORMATTED=$(date -d "@$expiry_date" +"%d %B %Y %H:%M")
fi
else
echo "$result"
fi
read -p "Tekan Enter untuk kembali ke menu..."
}

function _generate_api_key() {
clear
echo "─── Generate API Authentication Key ───"
local api_key
api_key=$(LC_ALL=C tr -dc 'a-zA-Z0-9' < /dev/urandom | head -c 6)
local key_file="/etc/zivpn/api_auth.key"
echo "$api_key" > "$key_file"
chmod 600 "$key_file"
echo "New API authentication key has been generated and saved."
echo "Key: ${api_key}"
local server_ip
server_ip=$(cat /etc/zivpn/ip.txt)
local domain
domain=$(get_active_domain)
local api_base
api_base=$(get_api_base_url)
echo ""
echo "═══════════════════════════════════════════════"
echo " Contoh Penggunaan API:"
echo "───────────────────────────────────────────────"
echo " Trial   : ${api_base}/trial/zivpn?exp=60&auth=${api_key}"
echo " Create  : ${api_base}/create/zivpn?password=PASS&exp=30&auth=${api_key}"
echo " Renew   : ${api_base}/renew/zivpn?password=PASS&exp=30&auth=${api_key}"
echo " Delete  : ${api_base}/delete/zivpn?password=PASS&auth=${api_key}"
echo "═══════════════════════════════════════════════"
/usr/local/bin/zivpn_helper.sh api-key-notification "$api_key" "$server_ip" "$domain" 2>/dev/null || true
read -p "Tekan Enter untuk kembali ke menu..."
}

function _lihat_api_key() {
clear
echo "─── Lihat API Authentication Key ───"
local key_file="/etc/zivpn/api_auth.key"
if [ ! -f "$key_file" ]; then
echo "API key belum dibuat!"
echo "Silakan generate API key terlebih dahulu."
read -p "Tekan Enter untuk kembali..."
return
fi
local api_key
api_key=$(cat "$key_file")
local api_base
api_base=$(get_api_base_url)
echo ""
echo "API Authentication Key:"
echo "-----------------------"
echo "Key: ${api_key}"
echo ""
echo "Base URL: ${api_base}"
echo ""
echo "Contoh Penggunaan:"
echo " Trial : ${api_base}/trial/zivpn?exp=60&auth=${api_key}"
echo " Create: ${api_base}/create/zivpn?password=PASS&exp=30&auth=${api_key}"
echo " Renew : ${api_base}/renew/zivpn?password=PASS&exp=30&auth=${api_key}"
echo " Delete: ${api_base}/delete/zivpn?password=PASS&auth=${api_key}"
echo ""
echo "Lokasi file: $key_file"
echo ""
read -p "Tekan Enter untuk kembali ke menu..."
}

function _create_trial_account_logic() {
local minutes="$1"
local db_file="/etc/zivpn/users.db"
if ! [[ "$minutes" =~ ^[0-9]+$ ]]; then
echo "Error: Invalid number of minutes."
return 1
fi
local password="trial$(shuf -i 10000-99999 -n 1)"
local expiry_date
expiry_date=$(date -d "+$minutes minutes" +%s)
echo "${password}:${expiry_date}" >> "$db_file"
jq --arg pass "$password" '.auth.config += [$pass]' /etc/zivpn/config.json > /etc/zivpn/config.json.tmp && mv /etc/zivpn/config.json.tmp /etc/zivpn/config.json
if [ $? -eq 0 ]; then
restart_zivpn
local EXPIRE_FORMATTED
EXPIRE_FORMATTED=$(date -d "@$expiry_date" +"%d %B %Y %H:%M")
ip=$(cat /etc/zivpn/ip.txt)
isp=$(cat /etc/zivpn/isp.txt)
local host
host=$(get_active_domain)
local api_key
api_key=$(cat /etc/zivpn/api_auth.key 2>/dev/null || echo "N/A")
clear
echo "Success:"
echo "TRIAL AKUN ZIVPN"
echo "┌────────────────────────┐"
echo "│ Host   : $host"
echo "│ IP     : $ip"
echo "│ ISP    : $isp"
echo "│ Pass   : $password"
echo "│ Expire : $EXPIRE_FORMATTED"
echo "└────────────────────────┘"
echo "Terima kasih telah menggunakan layanan kami"
local message=$(cat <<EOF
TRIAL AKUN ZIVPN
┌────────────────────────┐
│ Host   : $host
│ IP     : $ip
│ ISP    : $isp
│ Pass   : $password
│ Expire : $EXPIRE_FORMATTED
└────────────────────────┘
Terima kasih telah mencoba layanan kami
EOF
)
send_telegram_notification "$message"
return 0
else
sed -i "/^${password}:/d" "$db_file"
echo "Error: Failed to update config.json."
return 1
fi
}

function create_trial_account() {
echo "─────── Create Trial Zivpn Account ───────"
read -p "Enter active period (in minutes): " minutes
if ! [[ "$minutes" =~ ^[0-9]+$ ]]; then
echo "Invalid number of minutes."
return
fi
local result
result=$(_create_trial_account_logic "$minutes")
echo "$result"
read -p "Tekan Enter untuk kembali ke menu..."
}

function _renew_account_logic() {
local password="$1"
local days="$2"
local db_file="/etc/zivpn/users.db"
if [ -z "$password" ] || [ -z "$days" ]; then
echo "Error: Password and days are required."
return 1
fi
if ! [[ "$days" =~ ^[1-9][0-9]*$ ]]; then
echo "Error: Invalid number of days."
return 1
fi
local user_line
user_line=$(grep "^${password}:" "$db_file")
if [ -z "$user_line" ]; then
echo "Error: Account '${password}' not found."
return 1
fi
local current_expiry_date
current_expiry_date=$(echo "$user_line" | cut -d: -f2)
if ! [[ "$current_expiry_date" =~ ^[0-9]+$ ]]; then
echo "Error: Corrupted database entry for user '$password'."
return 1
fi
local seconds_to_add=$((days * 86400))
local new_expiry_date=$((current_expiry_date + seconds_to_add))
sed -i "s/^${password}:.*/${password}:${new_expiry_date}/" "$db_file"
local new_expiry_formatted
new_expiry_formatted=$(date -d "@$new_expiry_date" +"%d %B %Y %H:%M")
ip=$(cat /etc/zivpn/ip.txt)
isp=$(cat /etc/zivpn/isp.txt)
local host
host=$(get_active_domain)
clear
echo "Success:"
echo "RENEW AKUN ZIVPN"
echo "┌────────────────────────┐"
echo "│ Host   : $host"
echo "│ IP     : $ip"
echo "│ ISP    : $isp"
echo "│ Pass   : $password"
echo "│ Expire : $new_expiry_formatted"
echo "└────────────────────────┘"
echo "Terima kasih telah menggunakan layanan kami"
local message=$(cat <<EOF
RENEW AKUN ZIVPN
┌────────────────────────┐
│ Host   : $host
│ IP     : $ip
│ ISP    : $isp
│ Pass   : $password
│ Expire : $new_expiry_formatted
└────────────────────────┘
Terima kasih telah menggunakan layanan kami
EOF
)
send_telegram_notification "$message"
return 0
}

function renew_account() {
clear
echo "───────────── Renew Account ──────────────"
_display_accounts
echo ""
read -p "Enter password to renew: " password
if [ -z "$password" ]; then
echo "Password cannot be empty."
return
fi
read -p "Enter number of days to extend: " days
if ! [[ "$days" =~ ^[1-9][0-9]*$ ]]; then
echo "Invalid number of days. Please enter a positive number."
return
fi
local result
result=$(_renew_account_logic "$password" "$days")
echo "$result"
read -p "Tekan Enter untuk kembali ke menu..."
}

function _delete_account_logic() {
local password="$1"
local db_file="/etc/zivpn/users.db"
local config_file="/etc/zivpn/config.json"
local tmp_config_file="${config_file}.tmp"
if [ -z "$password" ]; then
echo "Error: Password is required."
return 1
fi
if [ ! -f "$db_file" ] || ! grep -q "^${password}:" "$db_file"; then
echo "Error: Password '${password}' not found."
return 1
fi
jq --arg pass "$password" 'del(.auth.config[] | select(. == $pass))' "$config_file" > "$tmp_config_file"
if [ $? -eq 0 ]; then
sed -i "/^${password}:/d" "$db_file"
mv "$tmp_config_file" "$config_file"
restart_zivpn
ip=$(cat /etc/zivpn/ip.txt)
isp=$(cat /etc/zivpn/isp.txt)
local host
host=$(get_active_domain)
clear
echo "Success:"
echo "DELETE AKUN ZIVPN"
echo "┌────────────────────────┐"
echo "│ Host   : $host"
echo "│ IP     : $ip"
echo "│ ISP    : $isp"
echo "│ Pass   : $password"
echo "│ Status : Deleted"
echo "└────────────────────────┘"
echo "Terima kasih telah menggunakan layanan kami"
local message=$(cat <<EOF
DELETE AKUN ZIVPN
┌────────────────────────┐
│ Host   : $host
│ IP     : $ip
│ ISP    : $isp
│ Pass   : $password
│ Status : Deleted
└────────────────────────┘
Terima kasih telah menggunakan layanan kami
EOF
)
send_telegram_notification "$message"
return 0
else
rm -f "$tmp_config_file"
echo "Error: Failed to update config.json. No changes were made."
return 1
fi
}

function delete_account() {
clear
echo "───────────── Delete Account ─────────────"
_display_accounts
echo ""
read -p "Enter password to delete: " password
if [ -z "$password" ]; then
echo "Password cannot be empty."
return
fi
local result
result=$(_delete_account_logic "$password")
echo "$result"
read -p "Tekan Enter untuk kembali ke menu..."
}

function change_domain() {
echo "─────────────── Change Domain ───────────────"
echo "1) Ganti Domain Manual (Self-Signed)"
echo "2) Setup Ulang Domain Cloudflare + SSL Otomatis"
echo "0) Kembali"
read -p "Pilih: " opt
case $opt in
1)
  read -p "Enter the new domain name: " domain
  if [ -z "$domain" ]; then echo "Domain cannot be empty."; return; fi
  openssl req -new -newkey rsa:4096 -days 365 -nodes -x509 \
    -subj "/C=US/ST=Jakarta/L=Jakarta/O=NexusDev/OU=VPN/CN=${domain}" \
    -keyout "/etc/zivpn/zivpn.key" -out "/etc/zivpn/zivpn.crt"
  echo "Certificate generated for ${domain}."
  restart_zivpn
  ;;
2)
  local new_domain
  new_domain=$(setup_cloudflare_domain)
  if [ $? -eq 0 ] && [ -n "$new_domain" ]; then
    setup_ssl_certbot "$new_domain"
    setup_nginx_ssl_proxy "$new_domain"
    echo ""
    _ok "Domain baru: ${new_domain}"
    _ok "API URL   : https://${new_domain}"
  fi
  ;;
esac
read -p "Tekan Enter untuk kembali ke menu..."
}

function _save_total_users() {
local db_file="/etc/zivpn/users.db"
local output_file="/etc/zivpn/total_users.txt"
if [ ! -f "$db_file" ] || [ ! -s "$db_file" ]; then
echo "0" > "$output_file"
return
fi
local total_users
total_users=$(wc -l < "$db_file" | tr -d ' ')
echo "$total_users" > "$output_file"
}

function _display_accounts() {
local db_file="/etc/zivpn/users.db"
if [ ! -f "$db_file" ] || [ ! -s "$db_file" ]; then
echo "No accounts found."
return
fi
local current_date
current_date=$(date +%s)
printf "%-20s │ %s\n" "Password" "Expires in (days)"
echo "──────────────────────────────────────────"
while IFS=':' read -r password expiry_date; do
if [[ -n "$password" ]]; then
local remaining_seconds=$((expiry_date - current_date))
if [ $remaining_seconds -gt 0 ]; then
local remaining_days=$((remaining_seconds / 86400))
printf "%-20s │ %s days\n" "$password" "$remaining_days"
else
printf "%-20s │ Expired\n" "$password"
fi
fi
done < "$db_file"
echo "──────────────────────────────────────────"
}

function list_accounts() {
clear
echo "──────────── Active Accounts ─────────────"
_display_accounts
echo ""
read -p "Press Enter to return to the menu..."
}

function format_kib_to_human() {
local kib=$1
if ! [[ "$kib" =~ ^[0-9]+$ ]] || [ -z "$kib" ]; then kib=0; fi
if [ "$kib" -lt 1048576 ]; then
awk -v val="$kib" 'BEGIN { printf "%.2f MiB", val / 1024 }'
else
awk -v val="$kib" 'BEGIN { printf "%.2f GiB", val / 1048576 }'
fi
}

function get_main_interface() {
ip -o -4 route show to default | awk '{print $5}' | head -n 1
}

function _draw_info_panel() {
local os_info isp_info ip_info host_info bw_today bw_month client_name license_exp
os_info=$( (hostnamectl 2>/dev/null | grep "Operating System" | cut -d: -f2 | sed 's/^[ \t]*//') || echo "N/A" )
os_info=${os_info:-"N/A"}
ip_info=$(cat /etc/zivpn/ip.txt)
isp_info=$(cat /etc/zivpn/isp.txt)
ip_info=${ip_info:-"N/A"}
isp_info=${isp_info:-"N/A"}
host_info=$(get_active_domain)
host_info=${host_info:-"N/A"}
cpu_name=$(lscpu | grep "Model name" | cut -d: -f2 | sed 's/^[ \t]*//')
cpu_cores=$(nproc)
mem_total=$(free -h | awk '/Mem:/ {print $2}')
mem_used=$(free -h | awk '/Mem:/ {print $3}')
disk_total=$(df -h / | awk 'NR==2 {print $2}')
disk_used=$(df -h / | awk 'NR==2 {print $3}')
disk_percent=$(df -h / | awk 'NR==2 {print $5}')
uptime_info=$(uptime -p)
bw_today=$(vnstat -d | awk '/'"$(date +%Y-%m-%d)"'/ {print $5 " " $6}')
bw_month=$(vnstat -m | awk '/'"$(date +%Y-%m)"'/ {print $5 " " $6}')

# SSL status
local ssl_status="HTTP (No SSL)"
if [ -f "$DOMAIN_CONF" ]; then
  source "$DOMAIN_CONF"
  if [ "${SSL_ENABLED}" = "true" ]; then
    ssl_status="HTTPS ✔ (${DOMAIN})"
  fi
fi

if [ -f "$LICENSE_INFO_FILE" ]; then
source "$LICENSE_INFO_FILE"
client_name=${CLIENT_NAME:-"N/A"}
if [ -n "$EXPIRY_DATE" ]; then
local expiry_timestamp
expiry_timestamp=$(date -d "$EXPIRY_DATE" +%s)
local current_timestamp
current_timestamp=$(date +%s)
local remaining_seconds=$((expiry_timestamp - current_timestamp))
if [ $remaining_seconds -gt 0 ]; then
license_exp="$((remaining_seconds / 86400)) days"
else
license_exp="Expired"
fi
else
license_exp="N/A"
fi
else
client_name="N/A"
license_exp="N/A"
fi
_save_total_users
total_users=$(cat /etc/zivpn/total_users.txt)
apikey=$(cat /etc/zivpn/api_auth.key 2>/dev/null || echo "N/A")
VERSI_URL="https://raw.githubusercontent.com/AutoNV/udpzivpn/main/versi.txt"
versisc=$(curl -fsSL "$VERSI_URL" 2>/dev/null | tr -d ' \r\n')
if [ -z "$versisc" ]; then versisc="UNKNOWN"; fi

  local W='\033[1;37m'
  local G='\033[1;32m'
  local C='\033[0;36m'
  local N='\033[0m'

  printf "${C}│${W} %-10s ${C}:${W} %s${N}\n"   "OS"      "${os_info}"
  printf "${C}│${W} %-10s ${C}:${W} %s${N}\n"   "IP"      "${ip_info}"
  printf "${C}│${W} %-10s ${C}:${G} %s${N}\n"   "Domain"  "${host_info}"
  printf "${C}│${W} %-10s ${C}:${G} %s${N}\n"   "SSL"     "${ssl_status}"
  printf "${C}│${W} %-10s ${C}:${G} %s${N}\n"   "Client"  "${client_name}"
  printf "${C}│${W} %-10s ${C}:${G} %s${N}\n"   "EXP"     "${license_exp}"
  printf "${C}│${W} %-10s ${C}:${W} %s${N}\n"   "RAM"     "${mem_used} / ${mem_total}"
  printf "${C}│${W} %-10s ${C}:${W} %s${N}\n"   "CPU"     "${cpu_name} (${cpu_cores} cores)"
  printf "${C}│${W} %-10s ${C}:${W} %s${N}\n"   "Disk"    "${disk_used} / ${disk_total} (${disk_percent})"
  printf "${C}│${W} %-10s ${C}:${W} %-20s  ${W}Users ${C}:${G} %s${N}\n"  "Uptime"   "${uptime_info}" "${total_users}"
  printf "${C}│${W} %-10s ${C}:${G} %-14s  ${W}Month ${C}:${G} %s${N}\n"  "BW Today" "${bw_today}"    "${bw_month}"
  printf "${C}│${W} %-10s ${C}:${G} %s${N}\n"   "Version" "${versisc}"
}

function _draw_service_status() {
  local W='\033[1;37m'
  local G='\033[1;32m'
  local R='\033[0;31m'
  local Y='\033[1;33m'
  local C='\033[0;36m'
  local N='\033[0m'

  local sv1; sv1=$(systemctl is-active "zivpn.service" 2>/dev/null || echo "unknown")
  local st1 sc1
  case "$sv1" in
    active)     st1="ON";  sc1="$G" ;;
    inactive)   st1="OFF"; sc1="$R" ;;
    failed)     st1="ERR"; sc1="$R" ;;
    activating) st1="..."; sc1="$Y" ;;
    *)          st1="OFF"; sc1="$R" ;;
  esac

  local sv2; sv2=$(systemctl is-active "zivpn-api.service" 2>/dev/null || echo "unknown")
  local st2 sc2
  case "$sv2" in
    active)     st2="ON";  sc2="$G" ;;
    inactive)   st2="OFF"; sc2="$R" ;;
    failed)     st2="ERR"; sc2="$R" ;;
    activating) st2="..."; sc2="$Y" ;;
    *)          st2="OFF"; sc2="$R" ;;
  esac

  # Nginx SSL proxy status
  local sv3; sv3=$(systemctl is-active "nginx" 2>/dev/null || echo "unknown")
  local st3 sc3
  case "$sv3" in
    active)     st3="ON";  sc3="$G" ;;
    *)          st3="OFF"; sc3="$R" ;;
  esac

  local rule_ok="no"
  iptables -t nat -S PREROUTING 2>/dev/null | grep -qE "6000:19999|:5667" && rule_ok="yes"
  local st4 sc4
  if [ "$rule_ok" = "yes" ]; then st4="ON";  sc4="$G"
  else                             st4="OFF"; sc4="$R"
  fi

  printf "${C}│${W} ZiVPN ${C}:${sc1}%-3s${W}  API ${C}:${sc2}%-3s${W}  Nginx SSL ${C}:${sc3}%-3s${W}  ZI ${C}:${sc4}%s${N}\n" \
         "$st1" "$st2" "$st3" "$st4"
}

function setup_auto_backup() {
echo "─── Configure Auto Backup ───"
if [ ! -f "/etc/zivpn/telegram.conf" ]; then
echo "Telegram is not configured."
return
fi
read -p "Enter backup interval in hours (e.g., 6, 12, 24). Enter 0 to disable: " interval
if ! [[ "$interval" =~ ^[0-9]+$ ]]; then echo "Invalid input."; return; fi
(crontab -l 2>/dev/null | grep -v "# zivpn-auto-backup") | crontab -
if [ "$interval" -gt 0 ]; then
local cron_schedule="0 */${interval} * * *"
(crontab -l 2>/dev/null; echo "${cron_schedule} /usr/local/bin/zivpn_helper.sh backup >/dev/null 2>&1 # zivpn-auto-backup") | crontab -
echo "Auto backup scheduled every ${interval} hour(s)."
else
echo "Auto backup disabled."
fi
}

function create_account() {
clear
echo -e "${YELLOW}┌──────────────────────────────────────────────────────┐${NC}"
echo -e "${YELLOW}│${NC}           ${BOLD_WHITE}✦  Create Account  ✦${NC}                        ${YELLOW}│${NC}"
echo -e "${YELLOW}├──────────────────────────────────────────────────────┤${NC}"
echo -e "${YELLOW}│${NC}   ${LIGHT_BLUE}1)${NC}  ${BOLD_WHITE}Create Zivpn                                  ${YELLOW}│${NC}"
echo -e "${YELLOW}│${NC}   ${LIGHT_BLUE}2)${NC}  ${BOLD_WHITE}Trial Zivpn                                   ${YELLOW}│${NC}"
echo -e "${YELLOW}│${NC}   ${LIGHT_BLUE}0)${NC}  ${BOLD_WHITE}Back to Main Menu                             ${YELLOW}│${NC}"
echo -e "${YELLOW}└──────────────────────────────────────────────────────┘${NC}"
read -p " Enter your choice [0-2]: " choice
case $choice in
1) create_manual_account ;;
2) create_trial_account ;;
0) return ;;
*) echo "Invalid option." ;;
esac
}

function show_backup_menu() {
clear
echo -e "${YELLOW}┌──────────────────────────────────────────────────────┐${NC}"
echo -e "${YELLOW}│${NC}           ${BOLD_WHITE}✦  Backup / Restore  ✦${NC}                      ${YELLOW}│${NC}"
echo -e "${YELLOW}├──────────────────────────────────────────────────────┤${NC}"
echo -e "${YELLOW}│${NC}   ${LIGHT_BLUE}1)${NC}  ${BOLD_WHITE}Backup Data                                   ${YELLOW}│${NC}"
echo -e "${YELLOW}│${NC}   ${LIGHT_BLUE}2)${NC}  ${BOLD_WHITE}Restore Data                                  ${YELLOW}│${NC}"
echo -e "${YELLOW}│${NC}   ${LIGHT_BLUE}3)${NC}  ${BOLD_WHITE}Auto Backup                                   ${YELLOW}│${NC}"
echo -e "${YELLOW}│${NC}   ${LIGHT_BLUE}4)${NC}  ${BOLD_WHITE}Atur Ulang Notifikasi Telegram                ${YELLOW}│${NC}"
echo -e "${YELLOW}│${NC}   ${LIGHT_BLUE}0)${NC}  ${BOLD_WHITE}Back to Main Menu                             ${YELLOW}│${NC}"
echo -e "${YELLOW}└──────────────────────────────────────────────────────┘${NC}"
read -p " Enter your choice [0-4]: " choice
case $choice in
1) /usr/local/bin/zivpn_helper.sh backup ;;
2) /usr/local/bin/zivpn_helper.sh restore ;;
3) setup_auto_backup ;;
4) /usr/local/bin/zivpn_helper.sh setup-telegram ;;
0) return ;;
*) echo "Invalid option." ;;
esac
}

function set_reboot_at_time() {
local HOUR="$1"
local MINUTE="0"
local CRON_TAG="#ZIVPN_AUTO_REBOOT"
crontab -l 2>/dev/null | grep -v "$CRON_TAG" > /tmp/cron_zivpn || true
echo "$MINUTE $HOUR * * * /sbin/reboot $CRON_TAG" >> /tmp/cron_zivpn
crontab /tmp/cron_zivpn
rm -f /tmp/cron_zivpn
echo -e "${GREEN}✔ Auto reboot diset jam $(printf '%02d:00' "$HOUR")${NC}"
}

function remove_reboot_schedule() {
local CRON_TAG="#ZIVPN_AUTO_REBOOT"
crontab -l 2>/dev/null | grep -v "$CRON_TAG" | crontab -
echo -e "${YELLOW}✔ Auto reboot dihapus${NC}"
}

function set_reboot_menu() {
clear
echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${CYAN}     PILIH JAM AUTO REBOOT     ${NC}"
echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""
for i in $(seq 1 24); do
if [[ "$i" -eq 24 ]]; then printf "%2d) Jam 00:00\n" "$i"
else printf "%2d) Jam %02d:00\n" "$i" "$i"; fi
done
echo " 0) Hapus Auto Reboot"
echo ""
read -rp "Pilih [1-24 / 0]: " choice
if [[ "$choice" == "0" ]]; then remove_reboot_schedule; return; fi
if [[ "$choice" -ge 1 && "$choice" -le 24 ]]; then
if [[ "$choice" -eq 24 ]]; then set_reboot_at_time 0
else set_reboot_at_time "$choice"; fi
else
echo -e "${RED}❌ Pilihan tidak valid${NC}"
fi
}

function show_expired_message_and_exit() {
clear
echo -e "\n${RED}──────────────────────────────────────────────────────${NC}"
echo -e "${RED}          LISENSI ANDA TELAH KEDALUWARSA!             ${NC}"
echo -e "${RED}──────────────────────────────────────────────────────${NC}\n"
echo -e "${BOLD_WHITE}Akses ke layanan ZIVPN di server anda telah dihentikan."
echo -e "Untuk memperpanjang lisensi, silakan hubungi admin https://wa.me/62890 \n"
echo -e "${LIGHT_GREEN}Setelah diperpanjang, layanan akan aktif kembali secara otomatis.${NC}\n"
exit 0
}

function show_menu() {
if [ -f "/etc/zivpn/.expired" ]; then show_expired_message_and_exit; fi
clear

  local W='\033[1;37m'
  local G='\033[1;32m'
  local R='\033[0;31m'
  local C='\033[0;36m'
  local N='\033[0m'

  echo -e "${C}┌────────────────────────────────────────────┐"
  echo -e "${C}│${W}        ⚡  Menu Panel ZiVPN  ⚡          ${C}│"
  echo -e "${C}├────────────────────────────────────────────"

  _draw_info_panel

  echo -e "${C}├──────────── Service Status ────────────────"
  _draw_service_status

  local _kf="/etc/zivpn/api_auth.key"
  local _ak; if [ -f "$_kf" ]; then _ak=$(cat "$_kf"); else _ak="(not set)"; fi
  local _api_base
  _api_base=$(get_api_base_url)
  echo -e "${C}├────────────────────────────────────────────"
  printf  "${C}│${W} API Key  ${C}:${G} %s${N}\n" "$_ak"
  printf  "${C}│${W} API URL  ${C}:${G} %s${N}\n" "${_api_base}/trial/zivpn?exp=60&auth=${_ak}"

  echo -e "${C}├────────────────────────────────────────────"
  printf  "${C}│${W}  %2s. %-16s    %2s. %s${N}\n"  "1"  "Buat Akun"       "8"  "Lihat API Key"
  printf  "${C}│${W}  %2s. %-16s    %2s. %s${N}\n"  "2"  "Perpanjang"      "9"  "Restart"
  printf  "${C}│${W}  %2s. %-16s   %2s. %s${N}\n"   "3"  "Hapus Akun"      "10" "Update Script"
  printf  "${C}│${W}  %2s. %-16s   %2s. %s${N}\n"   "4"  "Ganti Domain"    "11" "Update Lisensi"
  printf  "${C}│${W}  %2s. %-16s   %2s. %s${N}\n"   "5"  "Daftar Akun"     "12" "Speedtest"
  printf  "${C}│${W}  %2s. %-16s   %2s. %s${N}\n"   "6"  "Backup/Restore"  "13" "Perbaiki Error"
  printf  "${C}│${W}  %2s. %-16s   %2s. %s${N}\n"   "7"  "Buat API Key"    "14" "Auto Reboot"
  echo -e "${C}├────────────────────────────────────────────"
  printf  "${C}│${W}  x) Keluar${N}\n"
  echo -e "${C}└────────────────────────────────────────────┘${N}"
  echo ""
  read -p " Pilih Menu (1-14 atau x): " choice
  [[ "$choice" == "x" || "$choice" == "X" ]] && choice=0
case $choice in
1) create_account ;;
2) renew_account ;;
3) delete_account ;;
4) change_domain ;;
5) list_accounts ;;
6) show_backup_menu ;;
7) _generate_api_key ;;
8) _lihat_api_key ;;
9) systemctl restart zivpn.service --no-block && systemctl restart zivpn-udp.service --no-block && read -p "Tekan Enter..." && /usr/local/bin/zivpn-manager ;;
10) wget -q https://raw.githubusercontent.com/AutoNV/udpzivpn/main/update.sh -O /usr/local/bin/update-manager && chmod +x /usr/local/bin/update-manager && /usr/local/bin/update-manager && read -p "Tekan Enter..." && /usr/local/bin/zivpn-manager ;;
11) update_expiry_from_license_url && read -p "Tekan Enter..." && /usr/local/bin/zivpn-manager ;;
12) wget https://raw.githubusercontent.com/arivpnstores/v4/main/Cdy/speedtest -O /usr/bin/speedtest && chmod +x /usr/bin/speedtest && yes | /usr/bin/speedtest && read -p "Tekan Enter..." && /usr/local/bin/zivpn-manager ;;
13) wget -q https://raw.githubusercontent.com/AutoNV/udpzivpn/main/fix-zivpn.sh -O /usr/local/bin/fix-zivpn.sh && chmod +x /usr/local/bin/fix-zivpn.sh && /usr/local/bin/fix-zivpn.sh && read -p "Tekan Enter..." && /usr/local/bin/zivpn-manager ;;
14) set_reboot_menu ;;
0) exit 0 ;;
*) echo "Invalid option." ;;
esac
}

# ══════════════════════════════════════════════════════════════
#  SETUP / INSTALL
# ══════════════════════════════════════════════════════════════

function run_setup() {
clear
_sep
echo -e "${_W}    ⚡  ZiVPN Manager - Installation${NC}"
_sep
echo -e "${_Y}    Thank you for using SC UDO ZiVPN${NC}"
echo -e "${_Y}    Powered by  N E X U S D E V${NC}"
_sep
echo ""
sleep 1.2

# ── Verifikasi lisensi ────────────────────────────
_hdr "[ 1/9 ] Verifying license..."
_progress "Checking license"
verify_license

# ── Persiapan sistem ──────────────────────────────
_hdr "[ 2/9 ] Preparing system..."
export DEBIAN_FRONTEND=noninteractive
_progress "dpkg configure"
dpkg --configure -a >/dev/null 2>&1 || true
apt -f install -y >/dev/null 2>&1 || true
_ok "dpkg ready"

_progress "apt update"
apt update >/dev/null 2>&1
_ok "apt updated"

_progress "Installing dependencies"
apt install -y sudo screen ufw ruby rubygems curl wget python3-pip jq zip vnstat cron dnsutils nginx certbot >/dev/null 2>&1
_ok "Dependencies installed"

_progress "iptables-persistent"
echo iptables-persistent iptables-persistent/autosave_v4 boolean true | debconf-set-selections
echo iptables-persistent iptables-persistent/autosave_v6 boolean true | debconf-set-selections
apt install -y iptables-persistent netfilter-persistent >/dev/null 2>&1
iptables -t nat -F PREROUTING
netfilter-persistent save >/dev/null 2>&1
_ok "iptables-persistent ready"

_progress "ca-certificates"
apt install -y wget curl ca-certificates >/dev/null 2>&1
update-ca-certificates >/dev/null 2>&1
_ok "Certificates updated"

# ── Stop service lama ─────────────────────────────
_hdr "[ 3/9 ] Stopping old services..."
_progress "Stopping ZiVPN"
systemctl stop zivpn 2>/dev/null || true
rm -f /usr/local/bin/zivpn
_ok "Old service cleared"

# ── Download & install ZiVPN ──────────────────────
_hdr "[ 4/9 ] Downloading ZiVPN binary..."
ARCH=$(uname -m)
case "$ARCH" in
  x86_64)        FILE="zi.sh"  ;;
  aarch64)       FILE="zi2.sh" ;;
  armv7l|armhf)  FILE="zi3.sh" ;;
  *)
    _err "Unsupported architecture: $ARCH"
    exit 1
  ;;
esac
_progress "Downloading $FILE"
wget -q -O /root/zi.sh "https://raw.githubusercontent.com/AutoNV/udpzivpn/main/$FILE"
chmod +x /root/zi.sh
_ok "ZiVPN binary downloaded ($ARCH)"

_progress "Running installer"
sudo /root/zi.sh >/dev/null 2>&1
_ok "ZiVPN binary installed"

_progress "Starting service"
systemctl daemon-reload
systemctl start zivpn
systemctl enable zivpn >/dev/null 2>&1
_ok "ZiVPN service started"

# ── vnstat ────────────────────────────────────────
_hdr "[ 5/9 ] Setting up bandwidth monitor..."
local net_interface
net_interface=$(ip -o -4 route show to default | awk '{print $5}' | head -n 1)
if [ -n "$net_interface" ]; then
  _progress "vnstat setup"
  systemctl stop vnstat 2>/dev/null || true
  vnstat -u -i "$net_interface" --force 2>/dev/null || true
  systemctl enable vnstat >/dev/null 2>&1
  systemctl start vnstat
  _ok "vnstat ready on $net_interface"
else
  _warn "Network interface not detected, skipping vnstat"
fi

# ── Helper ────────────────────────────────────────
_hdr "[ 6/9 ] Downloading helper scripts..."
_progress "zivpn_helper.sh"
wget -q -O /usr/local/bin/zivpn_helper.sh \
  https://raw.githubusercontent.com/AutoNV/udpzivpn/main/zivpn_helper.sh
chmod +x /usr/local/bin/zivpn_helper.sh
_ok "zivpn_helper.sh"

_progress "Clearing default passwords"
jq '.auth.config = []' /etc/zivpn/config.json > /etc/zivpn/config.json.tmp \
  && mv /etc/zivpn/config.json.tmp /etc/zivpn/config.json
touch /etc/zivpn/users.db
RANDOM_PASS="zivpn$(shuf -i 10000-99999 -n 1)"
_ok "Default passwords cleared"

# ══════════════════════════════════════════════════
# ── Cloudflare DNS + SSL Setup ────────────────────
# ══════════════════════════════════════════════════
_hdr "[ 7/9 ] Setting up Cloudflare Domain + SSL..."

# Ambil IP server
local server_ip
server_ip=$(cat /etc/zivpn/ip.txt 2>/dev/null)
if [ -z "$server_ip" ]; then
  server_ip=$(curl -s https://api.ipify.org 2>/dev/null)
  echo "$server_ip" > /etc/zivpn/ip.txt
fi

_progress "Cloudflare DNS"
local full_domain
full_domain=$(setup_cloudflare_domain)

if [ $? -eq 0 ] && [ -n "$full_domain" ] && [ "$full_domain" != "null" ]; then
  _ok "Domain created: ${full_domain}"
  
  _progress "SSL Certificate (Let's Encrypt)"
  setup_ssl_certbot "$full_domain"
  
  _progress "Nginx SSL Proxy"
  setup_nginx_ssl_proxy "$full_domain"
  
  _ok "HTTPS API aktif: https://${full_domain}"
else
  _warn "Cloudflare setup gagal, menggunakan self-signed cert"
  # Fallback self-signed
  openssl req -new -newkey rsa:4096 -days 365 -nodes -x509 \
    -subj "/C=US/ST=Jakarta/L=Jakarta/O=NexusDev/OU=VPN/CN=zivpn" \
    -keyout "/etc/zivpn/zivpn.key" -out "/etc/zivpn/zivpn.crt" 2>/dev/null
  full_domain="$server_ip"
fi

# ── API Setup ─────────────────────────────────────
_hdr "[ 8/9 ] Setting up REST API..."

_progress "Node.js check"
if ! command -v node &>/dev/null; then
  curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash - >/dev/null 2>&1
  apt-get install -y nodejs >/dev/null 2>&1
fi
_ok "Node.js ready"

mkdir -p /etc/zivpn/api
cat <<'EOF' > /etc/zivpn/api/package.json
{
"name": "zivpn-api",
"version": "1.0.0",
"description": "API for managing ZIVPN",
"main": "api.js",
"scripts": { "start": "node api.js" },
"dependencies": { "express": "^4.17.1" }
}
EOF

cat <<'EOF' > /etc/zivpn/api/api.js
const express = require('express');
const { execFile } = require('child_process');
const fs = require('fs');
const app = express();
const PORT = 5888;
const AUTH_KEY_PATH = '/etc/zivpn/api_auth.key';
const ZIVPN_MANAGER_SCRIPT = '/usr/local/bin/zivpn-manager';
const authenticate = (req, res, next) => {
const providedAuthKey = req.query.auth;
if (!providedAuthKey) return res.status(401).json({ status: 'error', message: 'Authentication key is required.' });
fs.readFile(AUTH_KEY_PATH, 'utf8', (err, storedKey) => {
if (err) return res.status(500).json({ status: 'error', message: 'Could not read authentication key.' });
if (providedAuthKey.trim() !== storedKey.trim()) return res.status(403).json({ status: 'error', message: 'Invalid authentication key.' });
next();
});
};
app.use(authenticate);
const executeZivpnManager = (command, args, res) => {
execFile('/bin/bash', [ZIVPN_MANAGER_SCRIPT, command, ...args], (error, stdout, stderr) => {
if (error) {
const errorMessage = stderr || stdout || 'An internal server error occurred.';
return res.status(500).json({ status: 'error', message: errorMessage.trim() });
}
if (stdout.toLowerCase().includes('success')) {
res.json({ status: 'success', message: stdout.trim() });
} else {
res.status(400).json({ status: 'error', message: stdout.trim() });
}
});
};
app.all('/create/zivpn', (req, res) => {
const { password, exp } = req.query;
if (!password || !exp) return res.status(400).json({ status: 'error', message: 'Parameters password and exp are required.' });
executeZivpnManager('create_account', [password, exp], res);
});
app.all('/delete/zivpn', (req, res) => {
const { password } = req.query;
if (!password) return res.status(400).json({ status: 'error', message: 'Parameter password is required.' });
executeZivpnManager('delete_account', [password], res);
});
app.all('/renew/zivpn', (req, res) => {
const { password, exp } = req.query;
if (!password || !exp) return res.status(400).json({ status: 'error', message: 'Parameters password and exp are required.' });
executeZivpnManager('renew_account', [password, exp], res);
});
app.all('/trial/zivpn', (req, res) => {
const { exp } = req.query;
if (!exp) return res.status(400).json({ status: 'error', message: 'Parameter exp is required.' });
executeZivpnManager('trial_account', [exp], res);
});
app.listen(PORT, '127.0.0.1', () => console.log('ZIVPN API server running on 127.0.0.1:' + PORT));
EOF

_progress "npm install"
npm install --prefix /etc/zivpn/api >/dev/null 2>&1
_ok "API dependencies installed"

cat <<'EOF' > /etc/systemd/system/zivpn-api.service
[Unit]
Description=ZIVPN REST API Service
After=network.target
[Service]
Type=simple
User=root
WorkingDirectory=/etc/zivpn/api
ExecStart=/usr/bin/node /etc/zivpn/api/api.js
Restart=on-failure
[Install]
WantedBy=multi-user.target
EOF
systemctl daemon-reload
systemctl enable zivpn-api.service >/dev/null 2>&1
systemctl start zivpn-api.service

_progress "API key setup"
if [ ! -f /etc/zivpn/api_auth.key ]; then
  local initial_api_key
  initial_api_key=$(LC_ALL=C tr -dc 'a-zA-Z0-9' < /dev/urandom | head -c 6)
  echo "$initial_api_key" > /etc/zivpn/api_auth.key
  chmod 600 /etc/zivpn/api_auth.key
fi
local api_key_display
api_key_display=$(cat /etc/zivpn/api_auth.key)
_ok "API key: ${api_key_display}"

# API sekarang via HTTPS (nginx proxy)
_progress "Port 5888 (internal only)"
iptables -I INPUT -p tcp --dport 5888 -s 127.0.0.1 -j ACCEPT
iptables -I INPUT -p tcp --dport 5888 -j DROP  # Block akses langsung dari luar
_ok "Port 5888 dibatasi hanya localhost"

# ── Cron, license checker, dll ────────────────────
_hdr "[ 9/9 ] Finalizing..."

_progress "License checker cron"
cat > /etc/zivpn/license_checker.sh << 'LCEOF'
#!/bin/bash
LICENSE_URL="https://raw.githubusercontent.com/AutoNV/udpzivpn/main/ip2"
LICENSE_INFO_FILE="/etc/zivpn/.license_info"
EXPIRED_LOCK_FILE="/etc/zivpn/.expired"
log() { echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> /var/log/zivpn_license.log; }
if [ ! -f "$LICENSE_INFO_FILE" ]; then log "License info file not found."; exit 1; fi
source "$LICENSE_INFO_FILE"
if [ -z "$CLIENT_NAME" ] || [ -z "$EXPIRY_DATE" ]; then log "License info incomplete."; exit 1; fi
SERVER_IP=$(cat /etc/zivpn/ip.txt 2>/dev/null)
if [ -z "$SERVER_IP" ]; then log "Could not read server IP."; exit 1; fi
license_data=$(curl -s "$LICENSE_URL")
if [ $? -ne 0 ] || [ -z "$license_data" ]; then log "Could not reach license server."; exit 0; fi
license_entry=$(echo "$license_data" | grep -w "$SERVER_IP")
if [ -z "$license_entry" ]; then log "IP not found in license list."; exit 1; fi
client_name_remote=$(echo "$license_entry" | awk '{print $1}')
expiry_date_remote=$(echo "$license_entry" | awk '{print $2}')
expiry_timestamp_remote=$(date -d "$expiry_date_remote" +%s)
current_timestamp=$(date +%s)
if [ "$expiry_date_remote" != "$EXPIRY_DATE" ]; then
  echo "CLIENT_NAME=${client_name_remote}" > "$LICENSE_INFO_FILE"
  echo "EXPIRY_DATE=${expiry_date_remote}" >> "$LICENSE_INFO_FILE"
fi
if [ "$expiry_timestamp_remote" -le "$current_timestamp" ]; then
  if [ ! -f "$EXPIRED_LOCK_FILE" ]; then
    systemctl stop zivpn.service
    touch "$EXPIRED_LOCK_FILE"
  fi
else
  if [ -f "$EXPIRED_LOCK_FILE" ]; then
    rm "$EXPIRED_LOCK_FILE"
    systemctl start zivpn.service
  fi
fi
exit 0
LCEOF
chmod +x /etc/zivpn/license_checker.sh
(crontab -l 2>/dev/null | grep -v "# zivpn-license-check") | crontab -
(crontab -l 2>/dev/null; echo "*/5 * * * * /etc/zivpn/license_checker.sh # zivpn-license-check") | crontab -
_ok "License checker cron set"

_progress "Expiry check cron"
cat <<'EOF' > /etc/zivpn/expire_check.sh
DB_FILE="/etc/zivpn/users.db"
CONFIG_FILE="/etc/zivpn/config.json"
TMP_DB_FILE="${DB_FILE}.tmp"
CURRENT_DATE=$(date +%s)
SERVICE_RESTART_NEEDED=false
if [ ! -f "$DB_FILE" ]; then exit 0; fi
> "$TMP_DB_FILE"
while IFS=':' read -r password expiry_date; do
if [[ -z "$password" ]]; then continue; fi
if [ "$expiry_date" -le "$CURRENT_DATE" ]; then
jq --arg pass "$password" 'del(.auth.config[] | select(. == $pass))' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
SERVICE_RESTART_NEEDED=true
else
echo "${password}:${expiry_date}" >> "$TMP_DB_FILE"
fi
done < "$DB_FILE"
mv "$TMP_DB_FILE" "$DB_FILE"
if [ "$SERVICE_RESTART_NEEDED" = true ]; then
systemctl restart zivpn.service
fi
exit 0
EOF
chmod +x /etc/zivpn/expire_check.sh
(crontab -l 2>/dev/null | grep -v "# zivpn-expiry-check") | crontab -
(crontab -l 2>/dev/null; echo "* * * * * /etc/zivpn/expire_check.sh # zivpn-expiry-check") | crontab -
_ok "Expiry check cron set"

_progress "Auto update & watchdog"
(crontab -l 2>/dev/null | grep -v "# zivpn-auto-update") | crontab -
(crontab -l 2>/dev/null; echo "0 4 * * * /usr/local/bin/update-manager # zivpn-auto-update") | crontab -
(crontab -l 2>/dev/null | grep -v "# zivpn-auto-start") | crontab -
(crontab -l 2>/dev/null; echo "*/2 * * * * systemctl is-active --quiet zivpn || systemctl start zivpn # zivpn-auto-start") | crontab -
_ok "Auto update & watchdog enabled"

_progress "Installing zivpn-manager"
cp "$0" /usr/local/bin/zivpn-manager
chmod +x /usr/local/bin/zivpn-manager
_ok "zivpn-manager installed"

# ── Akun awal ─────────────────────────────────────
EXPIRY_DATE_INIT=$(date -d "+1 day" +%s)
echo "${RANDOM_PASS}:${EXPIRY_DATE_INIT}" >> /etc/zivpn/users.db
jq --arg pass "$RANDOM_PASS" '.auth.config += [$pass]' /etc/zivpn/config.json > /etc/zivpn/config.json.tmp && mv /etc/zivpn/config.json.tmp /etc/zivpn/config.json

# ── Profile ───────────────────────────────────────
rm -rf /root/.profile
cat <<EOF > /root/.profile
if [ "\$BASH" ]; then
if [ -f ~/.bashrc ]; then
. ~/.bashrc
fi
fi
mesg n || true
ln -fs /usr/share/zoneinfo/Asia/Jakarta /etc/localtime
menu
EOF
PROFILE_FILE="/root/.bashrc"
[ -f "/root/.bash_profile" ] && PROFILE_FILE="/root/.bash_profile"
ALIAS_CMD="alias menu='/usr/local/bin/zivpn-manager'"
AUTORUN_CMD="/usr/local/bin/zivpn-manager"
grep -qF "$ALIAS_CMD" "$PROFILE_FILE" || echo "$ALIAS_CMD" >> "$PROFILE_FILE"
grep -qF "$AUTORUN_CMD" "$PROFILE_FILE" || echo "$AUTORUN_CMD" >> "$PROFILE_FILE"
_ok "Mode: ZIVPN Only aktif"

echo ""
_sep
echo -e "${_G}  ✔  Installation completed successfully!${NC}"
_sep
echo ""

# ── Tampilkan ringkasan ────────────────────────────
local final_domain
final_domain=$(get_active_domain)
local final_api_base
final_api_base=$(get_api_base_url)
local final_api_key
final_api_key=$(cat /etc/zivpn/api_auth.key 2>/dev/null || echo "N/A")

echo -e "${_C}╔══════════════════════════════════════════════════╗${NC}"
echo -e "${_C}║${_W}          RINGKASAN INSTALASI ZIVPN            ${_C}║${NC}"
echo -e "${_C}╠══════════════════════════════════════════════════╣${NC}"
echo -e "${_C}║${_W} Domain  : ${_G}${final_domain}${NC}"
echo -e "${_C}║${_W} IP      : ${_G}${server_ip}${NC}"
echo -e "${_C}║${_W} API KEY : ${_G}${final_api_key}${NC}"
echo -e "${_C}╠══════════════════════════════════════════════════╣${NC}"
echo -e "${_C}║${_W} Contoh URL API:${NC}"
echo -e "${_C}║${_G} ${final_api_base}/trial/zivpn?exp=60&auth=${final_api_key}${NC}"
echo -e "${_C}║${_G} ${final_api_base}/create/zivpn?password=PASS&exp=30&auth=${final_api_key}${NC}"
echo -e "${_C}║${_G} ${final_api_base}/renew/zivpn?password=PASS&exp=30&auth=${final_api_key}${NC}"
echo -e "${_C}║${_G} ${final_api_base}/delete/zivpn?password=PASS&auth=${final_api_key}${NC}"
echo -e "${_C}╚══════════════════════════════════════════════════╝${NC}"
echo ""
sleep 2
show_menu
}

# ══════════════════════════════════════════════════════════════
#  MAIN
# ══════════════════════════════════════════════════════════════

function main() {
if [ "$#" -gt 0 ]; then
local command="$1"
shift
case "$command" in
create_account)
_create_account_logic "$@"
;;
delete_account)
_delete_account_logic "$@"
;;
renew_account)
_renew_account_logic "$@"
;;
trial_account)
_create_trial_account_logic "$@"
;;
*)
echo "Error: Unknown command '$command'"
exit 1
;;
esac
exit $?
fi
if [ ! -f "/etc/systemd/system/zivpn.service" ]; then
run_setup
fi
while true; do
show_menu
done
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
main "$@"
fi
